<!--
This web resource works together with arup_opportunitybuttoncommands.js to display 
buttons on the opportunity form that are relevant to the current BPF stage.
    
Arguments: The name of the tab must be specified in the CRM data arguments for the web resource, where it has been added to the form.
    
Bear in mind that this web resource is added to several different tabs within the opportunity, and that each copy of the web resource 
functions independently of the others.
There will be several copies of the web resource visible in the debugger as "arup_opportunitybuttons.html?data=PJN_Costs_Tab", for example.


-->
<html>
<head>
    <meta charset="utf-8">

    <style type="text/css">

        body {
            margin: 0px;
            vertical-align: middle;
        }

        .mainButton {
            -webkit-border-radius: 6px;
            -moz-border-radius: 6px;
            border-radius: 5px;
            color: #FFFFFF;
            font-family: Arial;
            min-width: 280px;
            width: 80%;
            font-size: 16px;
            font-weight: 400;
            padding: 5px 10px 10px 5px;
            background-color: #F44336;
            box-shadow: 1px 1px 2px 2px #ab918f;
            -webkit-box-shadow: 1px 5px 5px 1px #ab918f;
            -moz-box-shadow: 1px 1px 2px 2px #ab918f;
            text-shadow: 2px 4px 10px #000000;
            border: solid #FFFFFF 1px;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            text-align: center;
            margin: 4px;
            cursor: pointer;
        }

            .mainButton:hover {
                background: #E43326;
                border: solid #FFFFFF 1px;
                -webkit-border-radius: 6px;
                -moz-border-radius: 6px;
                border-radius: 6px;
                text-decoration: none;
            }

            .mainButton:active {
                background: #D42316;
                box-shadow: 1px 1px 2px 2px #ab918f;
                -webkit-box-shadow: 1px 1px 1px 1px #ab918f;
                -moz-box-shadow: 1px 1px 2px 2px #ab918f;
                -webkit-transform: translate(4px, 4px);
            }

        .tabButtons {
            text-align: center;
        }

        body {
            text-align: center;
        }
    </style>

    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="ccrm_ms_jQuery1102" type="text/javascript"></script>
</head>

<body style="word-wrap: break-word;">
    <div id="tabButtons"></div>

    <script>
        // Static form context value to be used throughout the page.
        // Note that this use of Xrm>Page is not deprecated (currently as of 04/20)
        var formContext = parent.Xrm.Page;

        // Central logging function.
        var Log = function (s) { console.log(s) };

        // Go back to the previous tab.
        function ReturnToActiveTab() {
            var previousTab = formContext.Arup.PreviousTab;
            if (previousTab != null) {
                DisplayTab(previousTab);
            }
        }

        // Ensure that the named tab is visible.
        function DisplayTab(newTabName) {
            console.log("Display tab:" + newTabName);
            formContext.Arup.PreviousTab = tabName;
            Xrm.Page.Arup.DisplayTab(newTabName, formContext);
        }

        // Move to next step in BPF
        function MoveNext() {
            formContext.Arup.BPFMoveNext(formContext, function () {
                setupNavigationButtons(true);
            });
        }

        // Setup buttons for the tab.
        // each button declared for the current tab will be set up within the "tabButtons" div in this document.
        function setupButtonsForTab(activeTabNum) {
            console.log("Display buttons for " + activeTabNum);
            var tabs = formContext.ui.tabs.get();
            // - generate buttons appropriate to the active tab.
            if (activeTabNum != null) {
                var buttonConfig = buttonConfigs[tabs[activeTabNum].getName()];
                Log("Active tab name " + tabs[activeTabNum].getName());
                if (buttonConfigs != null) {
                    // Generate buttons listed in buttonConfig.
                    $("#tabButtons").empty();
                    var id = 1;
                    for (var buttonNum in buttonConfig) {
                        var button = buttonConfig[buttonNum];
                        var span = document.createElement("span");
                        if (button.id != null) {
                            span.id = button.id;
                        } else {
                            span.id = "button" + id++;
                        }
                        span.onclick = button.action;
                        span.innerHTML = button.label;
                        span.className = "mainButton";
                        $("#tabButtons")[0].appendChild(span);

                        // Check for static or dynamic value for hidden.
                        if (button.hidden instanceof Function) {
                            if (button.hidden()) {
                                span.style.display = "none";
                            }
                        } else {
                            if (button.hidden) {
                                span.style.display = "none";
                            }
                        }
                    }
                }
            }
        }

        // Declare the configuration of each button: label, action to take when pressed and whether the button should be hidden.
        buttonConfigs = {
            'Prebid_tab': [
                {
                    'label': 'Request PJN',
                    'action': function () {
                        Log("Requesting PJN");
                        formContext.Arup.RequestPossibleJob();
                    },
                    'hidden': a => !formContext.Arup.RequestPossibleJobEnabled(formContext)
                },
                {
                    'label': 'Click Here for PJN Costs',
                    'action': function () {
                        DisplayTab("PJN_Costs_Tab");
                    }
                },
                {
                    'label': 'Approve Decision to Bid',
                    'action': function () {
                        Log("Approving bid decision");
                        formContext.Arup.BidDicisionConfirmation();
                    }
                },
                {
                    'label': 'Move to Next Stage',
                    'action': function () {
                        Log("Move next stage");
                        MoveNext();
                    }
                }
            ],
            'Cross_Region_Tab': [
                {
                    'label': 'Move to Next Stage',
                    'action': function () {
                        Log("Move next stage");
                        MoveNext();
                    }
                }
            ],
            'Developing_Bid_tab': [
                {
                    'label': 'Move to Next Stage',
                    'action': function () {
                        Log("Move next stage");
                        MoveNext();
                    }
                },
                {
                    'label': 'Update Financial Details',
                    'action': function () {
                        Log("Update Financial Details");
                        // Visit Project Financials?
                        DisplayTab("Project_Financials_Tab");
                    }
                },
            ],
            'Bid_Review_Submission_tab': [
                {
                    'label': 'Approve Bid Review',
                    'action': function () {
                        Log("Approve Bid Review");
                        formContext.Arup.ApproveBidReview(formContext);
                    },
                    'hidden': f => !formContext.Arup.IsApproveBidReviewEnabled(formContext)
                },
                {
                    'id': 'next_stage_button',
                    'label': 'Move to Next Stage',
                    'action': function () {
                        Log("Move next stage");
                        MoveNext();
                    },
                    'hidden': f => !formContext.Arup.IsApproveBidReviewApproved(formContext)
                }
            ],
            'Confirmed_Job_Project_Tab': [
                {
                    'label': 'Move to Next Stage',
                    'action': function () {
                        Log("Move next stage");
                        MoveNext();
                    }
                }
            ],
            'Confirmed_Job_commercial_Tab': [
                {
                    'label': 'Request Confirmed Job Number',
                    'action': function () {
                        Log("Request CJN");
                        formContext.Arup.RequestCJN();
                    },
                    'hidden': false // formContext.Arup.IsRequestCJNEnabled(formContext)
                }
            ],
            'PJN_Costs_Tab': [
                {
                    // TOD: return to active stage
                    'label': 'Back to the active stage tab',
                    'action': function () {
                        ReturnToActiveTab();
                    },
                    hidden: f => formContext.Arup.PreviousTab == null || formContext.Arup.PreviousTab == 'PJN_Costs_Tab'
                }
            ],
            'Project_Financials_Tab': [
                {
                    'label': 'Return to: Required Fields - Developing Bid tab',
                    'action': function () {
                        ReturnToActiveTab();
                    },
                    hidden: f => formContext.Arup.PreviousTab == null || formContext.Arup.PreviousTab == 'Project_Financials_Tab'
                }
            ],
            'PJN_Approval_tab': [
                {
                    'label': 'Approve PJN Group Leader',
                    'action': function () {
                        Log("Move next stage");
                        formContext.Arup.ApproveGroupLeader(formContext);
                    },
                    hidden: f => !formContext.Arup.IsGroupLeaderApprovalEnabled(formContext)
                },
                {
                    'label': 'Approve PJN Sector Leader',
                    'action': function () {
                        Log("Move next stage");
                        formContext.Arup.ApproveSectorLeader(formContext);
                    },
                    hidden: f => !formContext.Arup.IsSectorLeaderApprovalEnabled(formContext)
                },
                {
                    'label': 'Approve Regional COO',
                    'action': function () {
                        Log("Move next stage");
                        formContext.Arup.ApproveRegionalCOO(formContext);
                    },
                    hidden: f => !formContext.Arup.IsRegionalCOOApprovalEnabled(formContext)
                }
            ],
            'tab_testing': [
            ]
        };

        // Call on startup to ensure that the buttons for this tab are set up within the web resource, and that the callback to 
        // refresh the buttons is registered in arup_opportunitybuttoncomamnds.js.
        var tabName;
        var tabNumber;
        document.onreadystatechange = function () {
            if (document.readyState == "complete") {
                if (location.search == "") {
                    console.error("No tab name given");
                } else {
                    // Tab number is specified as part of the data argument to the web resource.
                    tabName = location.search.split("=")[1];
                    tabNumber = formContext.Arup.GetTabNumber(formContext, tabName);
                    console.log("Setup for tab " + tabName);
                    setupButtonsForTab(tabNumber);
                    formContext.Arup.OnDisplayingTab(formContext, tabName,
                        function () {
                            setupButtonsForTab(tabNumber);
                        });
                }
            }
        }
    </script>
</body>
</html>