<html>
<head>
    <meta charset="utf-8">

    <style type="text/css">

        body {
            margin: 0px;
        }

        .mainButton {
            background-color: #fc1303;
            color: #FFFFFF;
            font-family: Segoe UI, Tahoma, Arial;
            font-size: 12px;
            padding: 5px 10px 5px 10px;
            margin: 4px 4px 0px 0px;
            width: 240px;
            text-overflow: ellipsis;
            display: inline-block;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
        }

            .mainButton:hover {
                background-color: #ff3020;
            }

    </style>

    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="ccrm_ms_jQuery1102" type="text/javascript"></script>
    <script>




        function activateTab(tab) {

            parent.Xrm.Page.ui.tabs.get(tab).setFocus();
            parent.Xrm.Page.ui.tabs.get(tab).setDisplayState("expanded");

            var tabCtrl = document.getElementById('tabCtrl');
            var tabToActivate = document.getElementById(tab);
            for (var i = 0; i < tabCtrl.childNodes.length; i++) {
                var node = tabCtrl.childNodes[i];
                if (node.nodeType == 1) {
                    node.className = (node == tabToActivate) ? "activeTab" : "inactiveTab";
                }
            }

            loopTabs(tab, staticTabs.concat(tab), true, null);

        }

        function loopTabs(tab, tabArray, visibility, state) {

            var selectedTabs = null;
            var oppState = null;
            if (state == 'collapsed') {
                oppState = 'expanded';
            } else if (state == 'expanded') {
                oppState = 'collapsed';
            };

            var tabs = parent.Xrm.Page.ui.tabs.get();
            for (var i in tabs) {
                var tabProcessed = tabs[i];

                if (visibility != null) {
                    if (tabArray.indexOf(tabProcessed.getName()) > -1) {
                        parent.Xrm.Page.ui.tabs.get(tabProcessed.getName()).setVisible(visibility);
                    } else {
                        parent.Xrm.Page.ui.tabs.get(tabProcessed.getName()).setVisible(!visibility);
                    }
                }
                if (state != null) {
                    if (tabArray.indexOf(tabProcessed.getName()) > -1) {
                        parent.Xrm.Page.ui.tabs.get(tabProcessed.getName()).setDisplayState(state);
                    } else {
                        parent.Xrm.Page.ui.tabs.get(tabProcessed.getName()).setDisplayState(oppState);
                    }
                }
            }
        }
    </script>
    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
    <meta>
</head>

<body style="word-wrap: break-word;">
    <div id="tabButtons"></div>

    <script>
        staticTabs = ['PJN_Costs_Tab', 'Summary', 'Project_Financials_Tab', 'Project_Details_Tab', 'Bid_Details_Tab', 'Bid_Development_Tab_External'];

        var Log = function(s) { console.log(s) };

        buttonConfigs = {
            'tab_prebid': [
                {
                    'label': 'Approve Decision to Bid',
                    'action': function () {
                        Log("Approving bid decision");
                        parent.Xrm.Page.Arup.BidDicisionConfirmation();
                    }
                },
                {
                    'label': 'Move to Next Stage',
                    'action': function () {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.BPFMoveNext();
                    }
                }
            ]
        };

        // When loaded
        // - Work out which tab is currently active.
        var tabs = parent.Xrm.Page.ui.tabs.get();
        var activeTab = null;
        for (var t in tabs) {
            var tab = tabs[t];
            if (tab.getDisplayState() == "expanded") {
                activeTab = t;
            } else {
                if (staticTabs.includes(tab.getName())) {
                    tab.setVisible(true);
                } else {
                    tab.setVisible(false);
                }
            }
        }

        // - generate buttons appropriate to the active tab.
        if (activeTab != null) {
            var buttonConfig = buttonConfigs[tabs[activeTab].getName()];
            if (buttonConfigs != null) {
                // Generate buttons listed in buttonConfig.
                var id = 1;
                for (buttonNum in buttonConfig) {
                    var button = buttonConfig[buttonNum];
                    var span = document.createElement("span");
                    span.id = "button" + id++;
                    span.onclick = button.action;
                    span.innerHTML = button.label;
                    span.className = "mainButton";
                    $("#tabButtons")[0].appendChild(span);
                }
            }
        }

    </script>
</body>
</html>