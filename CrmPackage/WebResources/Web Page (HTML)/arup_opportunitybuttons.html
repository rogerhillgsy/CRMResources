<html>
<head>
    <meta charset="utf-8">

    <style type="text/css">

        body {
            margin: 0px;
        }

        .mainButton {
            background-color: #fc1303;
            color: #FFFFFF;
            font-family: Segoe UI, Tahoma, Arial;
            font-size: 12px;
            padding: 5px 10px 5px 10px;
            margin: 4px 4px 0px 0px;
            width: 240px;
            text-overflow: ellipsis;
            display: inline-block;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
        }

            .mainButton:hover {
                background-color: #ff3020;
            }

        .tabButtons {
            text-align: center;
        }

        body {
            text-align: center;
        }
    </style>

    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="ccrm_ms_jQuery1102" type="text/javascript"></script>
</head>

<body style="word-wrap: break-word;">
    <div id="tabButtons"></div>

    <script>
        function DisplayTab(tabName) {
            var tab = parent.Xrm.Page.ui.tabs.get(tabName);
            tab.setDisplayState("expanded");
            tab.setVisible(true);
            tab.setFocus();
            tabToDisplay = tabName;
            // Do we need to trigger the arup_opportunitybuttons.html web resource to update?
        }

        var tabToDisplay = null;

        staticTabs = ['tab_testing', 'PJN_Costs_Tab', 'Summary', 'Project_Financials_Tab', 'Project_Details_Tab', 'Bid_Details_Tab', 'Bid_Development_Tab_External'];
        debugger;
        var Log = function(s) { console.log(s) };

        buttonConfigs = {
            'Prebid_tab': [
                {
                    'label': 'Approve Decision to Bid',
                    'action': function() {
                        Log("Approving bid decision");
                        parent.Xrm.Page.Arup.BidDicisionConfirmation();
                    }
                },
                {
                    'label': 'Move to Next Stage',
                    'action': function() {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.BPFMoveNext();
                    }
                }
            ],
            'Cross_Region_Tab': [
                {
                    'label': 'Move to Next Stage',
                    'action': function() {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.BPFMoveNext();
                    }
                }
            ],
            'Developing_Bid_tab': [
                {
                    'label': 'Update Financial Details',
                    'action': function() {
                        Log("Updae Financial Details");
                        // Visit Project Financials?
                        parent.Xrm.Page.Arup.UpdateFinancialDetails();
                    }
                },
                {
                    'label': 'Move to Next Stage',
                    'action': function() {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.BPFMoveNext();
                    }
                }
            ],
            'Bid_Review_Submission_tab': [
                {
                    'label': 'Approve Bid Review',
                    'action': function() {
                        Log("Approve Bid Review");
                        parent.Xrm.Page.Arup.BPFMoveNext();
                        $('#next_stage_button').show();
                        debugger;
                        this.hide(); // ?? How do we do this?
                    }
                },
                {
                    'id': 'next_stage_button',
                    'label': 'Move to Next Stage',
                    'action': function() {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.BPFMoveNext();
                    },
                    'hidden': true
                }
            ],
            'Confirmed_Job_Project_Tab': [
                {
                    'label': 'Move to Next Stage',
                    'action': function() {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.BPFMoveNext();
                    }
                }
            ],
            'Confirmed_Job_commercial_Tab': [
                {
                    'label': 'Request Confirmed Job Number',
                    'action': function() {
                        Log("Request CJN");
                        parent.Xrm.Page.Arup.RequestCJN();
                    }
                }
            ],
            'PJN_Costs_Tab': [
                {
                    // TOD: return to active stage
                    'label': 'Return to: Required Fields - Pre-Bid',
                    'action': function() {
                        Log("Move next stage");
                        DisplayTab("Prebid_tab");
                    }
                }
            ],
            'Project_Financials_Tab': [
                {
                    'label': 'Return to: Required Fields - Developing Bid tab',
                    'action': function() {
                        Log("Move next stage");
                        DisplayTab("Developing_Bid_tab");
                    }
                }
            ],
            'PJN_Approval_tab': [
                {
                    'label': 'Approve PJN Group Leader',
                    'action': function() {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.PJNApproveGroupLeader("");
                    }
                },
                {
                    'label': 'Approve PJN Sector Leader',
                    'action': function() {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.PJNApproveSectorLeader("");
                    }
                },
                {
                    'label': 'Approve Regional COO',
                    'action': function () {
                        Log("Move next stage");
                        parent.Xrm.Page.Arup.PJNApproveRegionalCOO("");
                    }
                }
            ],
            'tab_testing': [
                ]
        };

        // When loaded
        // - Work out which tab is currently active.
        var tabs = parent.Xrm.Page.ui.tabs.get();
        var activeTab = tabToDisplay;
        tabToDisplay = null;
        for (var t in tabs) {
            var tab = tabs[t];
            if (tab.getDisplayState() == "expanded") {
                activeTab = t;
            } else {
                if (staticTabs.includes(tab.getName())) {
                    tab.setVisible(true);
                } else {
                    tab.setVisible(false);
                }
            }
            // If (testing) add buttons linking to all of the tabs to the test tab.
                var tabName = tab.getName();
                buttonConfigs['tab_testing'].push({
                    'label': tab.getLabel(),
                    'action': function (name) {
                        return function() {
                            debugger;
                            DisplayTab(name);
                        };
                    }(tabName)
                });
        }

        // - generate buttons appropriate to the active tab.
        if (activeTab != null) {
            var buttonConfig = buttonConfigs[tabs[activeTab].getName()];
            if (buttonConfigs != null) {
                // Generate buttons listed in buttonConfig.
                var id = 1;
                for (buttonNum in buttonConfig) {
                    var button = buttonConfig[buttonNum];
                    var span = document.createElement("span");
                    if (button.id != null) {
                        span.id = button.id;
                    } else {
                        span.id = "button" + id++;
                    }
                    span.onclick = button.action;
                    span.innerHTML = button.label;
                    span.className = "mainButton";
                    $("#tabButtons")[0].appendChild(span);
                    if (button.hidden) {
                        span.hidden = true;
                    }
                }
            }
        }

    </script>
</body>
</html>