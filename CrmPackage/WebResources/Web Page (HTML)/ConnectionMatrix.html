<html>
<head>
</head>
<body style="width: 100%; -webkit-print-color-adjust: exact; overflow-wrap: break-word;" onload="OnLoad()" onfocusout="parent.setEmailRange();">
    ﻿



    <title>CRM Report - Client Connection Matrix</title>
    <meta charset="utf-8">
    <!--<link href="../../arup_BootStrap_MinCSS.css" rel="stylesheet">-->
    <script src="../../ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="../../ccrm_/JavaScripts/Lib/SDK.REST.js"></script>
    <script src="../../ccrm_/JavaScripts/Lib/SDK.MetaData.js" type="text/javascript"></script>
    <script src="../../ccrm_/JavaScripts/Lib/XrmServiceToolkit.min.js" type="text/javascript"></script>
    <script src="../../ccrm_/JavaScripts/D3V4.js" type="text/javascript"></script>
    <script src="../../ccrm_/JavaScripts/Lib/jquery_3.2.0.min" type="text/javascript"></script>
    <!--<script src="../../arup_BootStrap.min" rel="stylesheet"></script>-->
    <!-- Bootstrap core CSS -->
    <link href="../../arup_Bootstrap4.3.1.css" rel="stylesheet">

    <style type="text/css">
        body, html {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        svg {
            display: block;
        }

        #connectionMatrix {
            width: 100%;
            font: 10px sans-serif;
        }


        .arc text {
            font: 10px sans-serif;
            text-anchor: middle;
        }

        .arc path {
            stroke: #fff;
        }

        .bar rect {
            fill: steelblue;
        }

        .bar text {
            fill: black;
            font: 10px sans-serif;
            text-anchor: start;
        }

        div {
            background-color: white;
            float: left;
        }

        #OpportunityForAccChart {
            width: 450px;
            height: 200px;
        }

        #OpenOpportunityChart {
            width: 580px;
            height: 200px;
        }

        .axis .domain {
            display: none;
        }

        /*body {
            font: 10px sans-serif;
        }*/

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        /*.bar {
            fill: steelblue;
        }*/

        .x.axis path {
            display: none;
        }

        .print {
            width: 90px;
            background-color: rgb(77, 144, 254);
            background-image: linear-gradient(to bottom, rgb(77, 144, 254), rgb(71, 135, 237));
            border: 1px solid rgb(48, 121, 237);
            color: #fff;
            vertical-align: middle;
            text-shadow: 0 1px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .printimg {
            color: #fff;
            vertical-align: middle;
            text-shadow: 0 1px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            stroke: #fff;
            stroke-width: 1px;
        }

        .nodetext {
            pointer-events: none;
            font-size: 5px;
            font-family: 'Segoe UI';
            fill: #000000;
        }
    </style>



    <div id="showhideNav" style="width:100%">
        <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
            <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Arup</a>
        </nav>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div id="maindivGraph" role="main" class="col-md-9 ml-sm-auto col-lg-10" style="padding-right:0">
                <div style="width:100%">
                    <div id="clientconnectionHelp" style="width:100%">
                        <table style="width:100%">
                            <tbody>
                                <tr>
                                    <td>
                                        <table style="width:100%">
                                            <tbody>
                                                <tr style="margin-bottom:140px;">
                                                    <td colspan="12" id="accountName" style="font-weight:bold;font-size:18pt;"></td>
                                                </tr>
                                                <tr></tr>
                                                <tr>
                                                    <td colspan="9" style="font-style: normal; font-family: 'Times New Roman'; font-size: 12pt; font-weight: 400;">CLIENT CONNECTION MATRIX</td>
                                                    <td colspan="3" style="float:right;margin-right:10px;font-size:9pt">

                                                        <p style="font-size:9pt; margin-bottom:0px"><b>Help:</b> Use mouse wheel to zoom-in / zoom-out. Press mouse left click and drag the chart to navigate</p>

                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="width:100%">
                        <table style="width:100%; margin-left:0">
                            <tbody>
                                <tr>
                                    <td>
                                        <table style="background-color: lightgray; font-size: 10pt; font-family: Arial; width:100%">
                                            <tbody>
                                                <tr height="0">
                                                    <td style="WIDTH:13%"></td>
                                                    <td style="WIDTH:14%"></td>
                                                    <td style="WIDTH:12%"></td>
                                                    <td style="WIDTH:17%"></td>
                                                    <td style="WIDTH:14%"></td>
                                                    <td style="WIDTH:14%"></td>
                                                    <td style="WIDTH:15%"></td>
                                                </tr>
                                                <tr>
                                                    <td style="font-weight:bold">Relationship Manager:</td>
                                                    <td id="relationshipmanager"></td>
                                                    <td style="font-weight:bold">Relationship Team:</td>
                                                    <td id="relationshipteam"></td>
                                                    <td style="font-weight:bold">Parent Company:</td>
                                                    <td id="parentOrg"></td>
                                                    <td>
                                                        <div class="table-responsive" id="ConnectionButtons" style="float:right;background-color: lightgray; ">
                                                            <button id="homeButton" style="margin : 1px; float: right;background-color: white; border: 1px white; padding: 0px; cursor: pointer;"> <input type="image" src="../../arup_HomeIcon" style="height:25px" title="Home"></button>
                                                            <button id="zoom_in" style="margin : 1px; float: right;background-color: white; border: 1px white; padding: 0px; cursor: pointer;"> <input type="image" src="../../arup_graphzoomin" style="height:25px" title="Zoom In"></button>
                                                            <button id="zoom_out" style="margin : 1px; float: right;background-color: white; border: 1px white; padding: 0px; cursor: pointer;"> <input type="image" src="../../arup_graphzoomout" style="height:25px" title="Zoom Out"></button>
                                                            <button id="zoom_init" style="margin : 1px; float: right;background-color: white; border: 1px white; padding: 0px; cursor: pointer;"> <input type="image" src="../../arup_graphreset" style="height:25px" title="Reset Zoom"></button>
                                                            <!--<button id='print' style='margin : 1px; float: right;background-color: white; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphprint' style='height:26px' title='Print' /></button>-->
                                                        </div>
                                                    </td>
                                                </tr>

                                            </tbody>
                                        </table>

                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>


                </div>

                <div class="table-responsive" id="connectionMatrix" style="width:100%; height:70%; float:left; margin-right:2px;">
                    <svg id="connForcelay" width="100%" height="100%"></svg>
                </div>


                <div class="table-responsive" style="padding-bottom: 80px">
                    <div id="connectionMatrixtable" style="width:100%">
                        <h3>Contacts with no connections</h3>
                        <p id="p"></p>
                    </div>
                </div>

            </div>
            <div id="seconddivgraph" class="col-md-2" style="margin-top:65px">

                <div id="Accountfilters" style="border:1px solid grey; padding-right:0px; padding-left:0px; font-size:9pt; width:100%">
                    <div class="list-group" style="width:100%; font-size:11pt">
                        <button type="button" class="list-group-item list-group-item-action list-group-item-secondary active">
                            Filters
                        </button>

                        <div class="panel-group" style="width:100%">
                            <div class="panel panel-info" style="width:100%; padding : 5px 5px 5px 5px">
                                <div class="panel-body" style="width:100%">
                                    <label class="list-group-item list-group-item-action list-group-item-secondary" style="cursor: pointer;">
                                        <label style="width:100%; font-size:12pt ">
                                            <input type="radio" name="RadOrg" id="Radios1" value="C" checked="checked">
                                            Connections
                                            <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="connectioncount"></span>
                                        </label>
                                    </label>

                                    <label class="list-group-item list-group-item-action" style="padding-left:30px; cursor: pointer;">
                                        <input type="checkbox" value="1" id="chkDecisonMaker">
                                        <label for="chkDecisonMaker" style="margin-bottom:0px">
                                            Decision Makers
                                        </label>
                                        <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="decisionmakercount"></span>
                                    </label>
                                </div>
                            </div>
                        </div>


                        <div class="panel-group" style="width:100%">
                            <div class="panel panel-info" style="width:100%; padding : 5px 5px 5px 5px">
                                <div class="panel-body" style="width:100%">

                                    <label class="list-group-item list-group-item-action list-group-item-secondary" style="width:100%; margin:2px,2px,2px,2px;font-size:12pt; cursor: pointer; ">
                                        <input type="radio" name="RadOrg" id="Radios2" value="O">
                                        Opportunities
                                        <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="openopportunitycount"></span>
                                    </label>


                                    <label class="list-group-item list-group-item-action" style="padding-left:30px; cursor: pointer;">
                                        <input type="checkbox" value="1" id="chkShowBidTeam" title="Show bid teams">
                                        <label for="chkShowBidTeam">Bid Teams</label>
                                    </label>

                                    <label class="list-group-item list-group-item-action" style="padding-left:30px; cursor: pointer;">
                                        <input type="checkbox" value="1" id="chkShowInternal" title="Show Internal Opportunities">
                                        <label for="chkShowInternal">Show Internal</label>
                                        <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="InternalOpportunityCount"></span>
                                    </label>
                                    <label class="list-group-item list-group-item-action" style="padding-left:30px; cursor: pointer;">
                                        <input type="radio" name="opportunitystatus" value="200013" id="chkprebid">
                                        <label for="chkprebid">Pre-Bid</label>
                                        <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="PreBidOpportunityCount"></span>
                                    </label>

                                    <label class="list-group-item list-group-item-action" style="padding-left:30px; cursor: pointer;">
                                        <input type="radio" name="opportunitystatus" value="1,200015" id="chkInProgress">
                                        <label for="chkInProgress">Developing Bids</label>
                                        <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="DevelopingBidOpportunityCount"></span>
                                    </label>

                                    <label class="list-group-item list-group-item-action" style="padding-left:30px; cursor: pointer;">
                                        <input type="radio" name="opportunitystatus" value="200020" id="chkBidSubmitted">
                                        <label for="chkBidSubmitted">Bid Submitted</label>
                                        <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="BidSubmittedOpportunityCount"></span>
                                    </label>
                                    <label class="list-group-item list-group-item-action" style="padding-left:30px; cursor: pointer;">
                                        <input type="radio" name="opportunitystatus" value="200041,200032,200021,100000000,200038,200035" id="chkCJNApproval">
                                        <label for="chkCJNApproval">CJN Approval</label>
                                        <span class="badge badge-info badge-pill" style="float:right; background-color:#4DABF7" id="CJNApprovalOpportunityCount"></span>
                                    </label>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="Userfilters" style="border:1px solid grey; display:none;padding-right:0px; padding-left:0px; font-size:9pt; width:100% ">
                    <div class="list-group" style="width:100%; font-size:11pt">
                        <button type="button" class="list-group-item list-group-item-action list-group-item-secondary active">
                            Filters
                        </button>
                        <label style="cursor: pointer;" class="list-group-item list-group-item-action">
                            <input type="checkbox" value="1" id="chkShowAllConnectionsforUser">
                            <label for="chkShowAllConnectionsforUser">Show child org connections</label>
                        </label>
                    </div>
                </div>

                <div id="Connectionfilters" style="border:1px solid grey; display:none;padding-right:0px; padding-left:0px; font-size:9pt; width:100% ">
                    <div class="list-group" style="width:100%; font-size:11pt">
                        <button type="button" class="list-group-item list-group-item-action list-group-item-secondary active">
                            Filters
                        </button>
                        <label style="cursor: pointer;" class="list-group-item list-group-item-action">
                            <input type="checkbox" value="1" id="chkMarketingList">
                            <label for="chkMarketingList">Marketing Lists</label>
                        </label>

                        <label style="cursor: pointer;" class="list-group-item list-group-item-action">
                            <input type="checkbox" value="2" id="chkContactActivities">
                            <label for="chkContactActivities">Activities</label>
                        </label>

                    </div>
                    <div class="alert alert-danger" id="alert-activities" style="display:none; margin-top: 20px;">
                        <strong>Activities not found </strong>
                    </div>
                    <div class="alert alert-danger" id="alert-marketing" style="display:none;  margin-top: 20px; ">
                        <strong>Marketing Lists not found </strong>
                    </div>

                </div>



            </div>
        </div>
    </div>

    <script>
        var accId, accName, parentaccountid, isManagedClient, relationshipManager, accTownCity = "", accDepartment = "", accOpenOpptys = "";
        var currentselectedUserid = "";
        var childData = [];
        var childOrgAccIds = [];
        var basicProfile = [];
        var childOrgs = [];
        var relTeamMembers = [];
        var sizetoggle = 0;
        function OnLoad() {
        debugger;
            //if we need to display report within form:Starts
            var queryString = location.search.substring(1);
            var params = {};
			var queryStringParts = queryString.split("&");
			for (var i = 0; i < queryStringParts.length; i++) {
				var pieces = queryStringParts[i].split("=");
				params[pieces[0]] = pieces.length == 1 ? null : decodeURIComponent(pieces[1]);
			}
            var parameters = decodeURIComponent(params.data);//GetGlobalContext().getQueryStringParameters().Data;
            if (parameters != undefined) {
                accId = parameters.split('&')[0].split('=')[1];
                parentaccountid = parameters.split('&')[1].split('=')[1];
                if (accId != parentaccountid) {
                    var fetchXML = "<fetch>" +
                                      "<entity name='account' >" +
                                        "<attribute name='accountid' />" +
                                        "<filter>" +
                                          "<condition attribute='accountid' operator='eq-or-above' value='" + accId + "' />" +
                                          "<condition attribute='parentaccountid' operator='null' />" +
                                        "</filter>" +
                                      "</entity>" +
                                    "</fetch>";
                    var accounts = XrmServiceToolkit.Soap.Fetch(fetchXML);

                    if (accounts.length > 0) {
                        parentaccountid = accounts[0].id;
                    }
                }
            }
            else {
                accId = "29616C21-7745-E011-9CF6-78E7D16510D0";
                parentaccountid = accId;
            }
            try {
                PopulateBasicAccProfile();
            }
            catch (err) { }
            try {
                PopulateManagingTeamMembers();
            }
            catch (err) { }
            try {
                $('#chkShowBidTeam').prop('disabled', true);
                $('#chkShowInternal').prop('disabled', true);
                $('input[name="opportunitystatus"]').prop('disabled', true);
                PopulateConnection(true,true,true,true,true);
            }
            catch (err) { }

        }

        function PopulateManagingTeamMembers() {
            var fetchXML = "<fetch version='1.0' output-format='xml-platform' mapping='logical' top='5' distinct='true'>" +
                          "<entity name='systemuser'>" +
                            "<attribute name='fullname' />" +
                            "<attribute name='systemuserid' />" +
                            "<attribute name='title' />" +
                            "<attribute name='ccrm_arupofficeid' alias='Office'/>" +
                            "<attribute name='businessunitid' alias='Business' />" +
                            "<order attribute='fullname' descending='false' />" +
                            "<link-entity name='teammembership' from='systemuserid' to='systemuserid' visible='false' intersect='true'>" +
                              "<link-entity name='team' from='teamid' to='teamid' alias='af'>" +
                                "<link-entity name='account' from='ccrm_managingteamid' to='teamid' alias='ag'>" +
                                  "<filter type='and'>" +
                                    "<condition attribute='accountid' operator='eq' value='" + accId + "' />" +
                                  "</filter>" +
                                "</link-entity>" +
                              "</link-entity>" +
                            "</link-entity>" +
                          "</entity>" +
                        "</fetch>";
            var userRecords = XrmServiceToolkit.Soap.Fetch(fetchXML);
            var userList = [];
            if (userRecords.length > 0) {
                for (var i = 0; i < userRecords.length; i++) {
                    //debugger;
                    var sysuserid = userRecords[i].attributes.systemuserid.value;
                    var fullname = userRecords[i].attributes.fullname != undefined ? userRecords[i].attributes.fullname.value : "";
                    var Office = userRecords[i].attributes.Office != undefined ? userRecords[i].attributes.Office.name : "";
                    var title = userRecords[i].attributes.title != undefined ? userRecords[i].attributes.title.value : "";
                    var business = userRecords[i].attributes.Business != undefined ? userRecords[i].attributes.Business.name : "";

                    var user = { "Name": fullname, "Arup Office": Office, Title: title, Business: business, UserID: sysuserid };
                    userList.push(user);
                    relTeamMembers.push(sysuserid);
                }
                DrawTable("#relationshipTeam", userList, Object.keys(userList[0]));
            }
        }

        function InititializeGraphDivs()
        {
            if (sizetoggle == 0) {
                $("#connectionMatrix").empty();
                $("#ConnectionButtons").empty();
                $("#connectionMatrix").html("<svg id='connForcelay' width='100%' height='800'></svg>");
                $("#ConnectionButtons").html(
                            //"<button id='print' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphprint' style='height:26px' title='Print' /></button>" +
                              "<button id='btnresize' style='margin : 1px; float: right;border: 0px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphresize' style='height:25px' title='Resize' /></button>" +
                              "<button id='zoom_init' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphreset' style='height:25px' title='Reset Zoom' /></button>" +
                             "<button id='zoom_out' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphzoomout' style='height:25px' title='Zoom Out' /></button> " +
                            "<button id='zoom_in' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphzoomin' style='height:25px' title='Zoom In' /></button>" +
                           "<button id='homeButton' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_HomeIcon' style='height:25px' title='Home' /></button>"
                    );
                $("#connectionMatrix").css("height", "75%");
            }
            else {
                $("#connectionMatrix").empty();
                $("#ConnectionButtons").empty();
                $("#connectionMatrix").html("<svg id='connForcelay' width='100%' height='800'></svg>");
                $("#ConnectionButtons").html(
                            //"<button id='print' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphprint' style='height:26px' title='Print' /></button>" +
                              "<button id='btnresize' style='margin : 1px; float: right;border: 0px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphresize' style='height:25px' title='Resize' /></button>" +
                              "<button id='zoom_init' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphreset' style='height:25px' title='Reset Zoom' /></button>" +
                             "<button id='zoom_out' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphzoomout' style='height:25px' title='Zoom Out' /></button> " +
                            "<button id='zoom_in' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_graphzoomin' style='height:25px' title='Zoom In' /></button>" +
                           "<button id='homeButton' style='margin : 1px; float: right; border: 1px white; padding: 0px; cursor: pointer;'> <input type='image' src='../../arup_HomeIcon' style='height:25px' title='Home' /></button>"
                    );
                $("#connectionMatrix").css("height", "90%");
                $('#connForcelay').css("height", "1100px");

            }
        }

        function PopulateConnection(ContactAccountRoleDM,ContactAccountRoleInf,ContacAccountRoleEmp, ContactAccountRoleOthers, ContactAccountRoleCS) {
            ConnectionContactData = "";
            $("#Connectionfilters").hide();
            $("#Accountfilters").show();

            $("#Radios1").attr('checked', 'checked');

            InititializeGraphDivs();
            InitializeHomeButtonClick();
            var connections;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v9.1/connections?fetchXml=%3Cfetch%20distinct%3D'true'%20%3E%3Centity%20name%3D'connection'%20%3E%3Cattribute%20name%3D'record1id'%20alias%3D'Contact'%20%2F%3E%3Cattribute%20name%3D'record2id'%20alias%3D'CRM_User'%20%2F%3E%3Corder%20attribute%3D'record1id'%20descending%3D'false'%20%2F%3E%3Cfilter%3E%3Ccondition%20attribute%3D'statuscodename'%20operator%3D'eq'%20value%3D'Active'%20%2F%3E%3Ccondition%20attribute%3D'record1objecttypecode'%20operator%3D'eq'%20value%3D'2'%20%2F%3E%3Ccondition%20attribute%3D'record2objecttypecode'%20operator%3D'eq'%20value%3D'8'%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'contact'%20from%3D'contactid'%20to%3D'record1id'%20link-type%3D'inner'%20alias%3D'co'%20%3E%3Cattribute%20name%3D'accountrolecode'%20%2F%3E%3Cattribute%20name%3D'jobtitle'%20%2F%3E%3Cattribute%20name%3D'department'%20alias%20%3D%20'contactdepartment'%20%20%2F%3E%3Cattribute%20name%3D'emailaddress1'%20alias%20%3D'contactemail'%2F%3E%3Cattribute%20name%3D'telephone1'%20alias%20%3D%20'contactphone'%20%2F%3E%3Cattribute%20name%3D'ccrm_countryid'%20%2F%3E%3Cattribute%20name%3D'accountrolecodename'%20%2F%3E%3Cattribute%20name%3D'contactid'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20alias%3D'contactimage'%20%2F%3E%3Cfilter%20type%3D'and'%20%3E%3Ccondition%20attribute%3D'statuscodename'%20operator%3D'eq'%20value%3D'Active'%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'parentcustomerid'%20link-type%3D'inner'%20alias%3D'ac'%20%3E%3Cattribute%20name%3D'accountid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'address1_city'%20alias%20%3D%20'orgtowncity'%20%2F%3E%3Cattribute%20name%3D'ccrm_address1attentiondepartment'%20alias%20%3D%20'orgdepartment'%20%2F%3E%3Cattribute%20name%3D'arup_openopportunitiescalc'%20alias%20%3D%20'orgopenopptys'%20%2F%3E%3Cfilter%20type%3D'and'%20%3E%3Ccondition%20attribute%3D'accountid'%20operator%3D'eq'%20value%3D'" + accId + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D'systemuser'%20from%3D'systemuserid'%20to%3D'record2id'%20%3E%3Cattribute%20name%3D'arup_employmentstatus'%20alias%3D'employmentstatus'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20alias%3D'userimage'%20%2F%3E%3Cattribute%20name%3D'title'%20alias%20%3D%20'usertitle'%20%2F%3E%3Cattribute%20name%3D'systemuserid'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20%2F%3E%3Cattribute%20name%3D'address1_country'%20alias%20%3D%20'usercountry'%20%2F%3E%3Cattribute%20name%3D'mobilephone'%20%2F%3E%3Cattribute%20name%3D'address1_telephone1'%20alias%20%3D%20'userphone'%20%2F%3E%3Clink-entity%20name%3D'ccrm_arupaccountingcode'%20from%3D'ccrm_arupaccountingcodeid'%20to%3D'ccrm_accountingcentreid'%20link-type%3D'outer'%20alias%3D'User_ACC'%20%3E%3Cattribute%20name%3D'ccrm_arupcompanycode'%20alias%3D'usercompanycode'%2F%3E%3Cattribute%20name%3D'ccrm_arupaccountingcode'%20alias%20%3D'useraccountingcode'%20%2F%3E%3Cattribute%20name%3D'ccrm_name'%20%2F%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D'ccrm_arupregion'%20from%3D'ccrm_arupregionid'%20to%3D'ccrm_arupregionid'%20link-type%3D'outer'%20alias%3D'User_AR'%20%3E%3Cattribute%20name%3D'ccrm_name'%20alias%20%3D%20'userregion'%20%2F%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    connections = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                }
            });

            //new fectxml -  everything is same just modified to populate user/contact image url
            var fetchXML = "<fetch distinct='true' >" +
                              "<entity name='connection' >" +
                                "<attribute name='record1id' alias='Contact' />" +
                                "<attribute name='record2id' alias='CRM_User' />" +
                                "<order attribute='record1id' descending='false' />" +
                                "<filter>" +
                                  "<condition attribute='statuscodename' operator='eq' value='Active' />" +
                                  "<condition attribute='record1objecttypecode' operator='eq' value='2' />" +
                                  "<condition attribute='record2objecttypecode' operator='eq' value='8' />" +
                                "</filter>" +
                                "<link-entity name='contact' from='contactid' to='record1id' link-type='inner' alias='co' >" +
                                  "<attribute name='accountrolecode' />" +
                                  "<attribute name='jobtitle' />" +
                                   "<attribute name='department' alias = 'contactdepartment'  />" +
                                  "<attribute name='emailaddress1' alias ='contactemail'/>" +
                                    "<attribute name='telephone1' alias = 'contactphone' />" +
                                     "<attribute name='ccrm_countryid' />" +
                                  "<attribute name='accountrolecodename' />" +
                                  "<attribute name='contactid' />" +
                                  "<attribute name='entityimage_url' alias='contactimage' />" +
                                  "<filter type='and' >" +
                                    "<condition attribute='statuscodename' operator='eq' value='Active' />" +
                                  "</filter>" +
                                  "<link-entity name='account' from='accountid' to='parentcustomerid' link-type='inner' alias='ac' >" +
                                    "<attribute name='accountid' />" +
                                    "<attribute name='name' />" +
                                    "<attribute name='address1_city' alias = 'orgtowncity' />" +
                                     "<attribute name='ccrm_address1attentiondepartment' alias = 'orgdepartment' />" +
                                     "<attribute name='arup_openopportunitiescalc' alias = 'orgopenopptys' />" +
                                    "<filter type='and' >" +
                                      "<condition attribute='accountid' operator='eq' value='" + accId + "' />" +
                                    "</filter>" +
                                  "</link-entity>" +
                                "</link-entity>" +
                                "<link-entity name='systemuser' from='systemuserid' to='record2id' >" +
                                  "<attribute name='arup_employmentstatus' alias='employmentstatus' />" +
                                  "<attribute name='entityimage_url' alias='userimage' />" +
                                   "<attribute name='title' alias = 'usertitle' />" +
                                    "<attribute name='systemuserid' />" +
                                  "<attribute name='entityimage_url' />" +
                                  "<attribute name='address1_country' alias = 'usercountry' />" +
                                  "<attribute name='mobilephone' />" +
                                  "<attribute name='address1_telephone1' alias = 'userphone' />" +
                                  "<link-entity name='ccrm_arupaccountingcode' from='ccrm_arupaccountingcodeid' to='ccrm_accountingcentreid' link-type='outer' alias='User_ACC' >" +
                                   "<attribute name='ccrm_arupcompanycode' alias='usercompanycode'/>" +
                                    "<attribute name='ccrm_arupaccountingcode' alias ='useraccountingcode' /> " +
                                    "<attribute name='ccrm_name' />" +
                                  "</link-entity>" +
                                  "<link-entity name='ccrm_arupregion' from='ccrm_arupregionid' to='ccrm_arupregionid' link-type='outer' alias='User_AR' >" +
                                   "<attribute name='ccrm_name' alias = 'userregion' />" +
                                  "</link-entity>"+
                                "</link-entity>" +
                              "</entity>" +
                "</fetch>";
            var contacts;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v9.1/contacts?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'true'%3E%3Centity%20name%3D'contact'%3E%3Cattribute%20name%3D'fullname'%20%2F%3E%3Cattribute%20name%3D'parentcustomerid'%20%2F%3E%3Cattribute%20name%3D'emailaddress1'%20%2F%3E%3Cattribute%20name%3D'jobtitle'%20%2F%3E%3Cattribute%20name%3D'ccrm_countryid'%20%2F%3E%3Cattribute%20name%3D'address1_city'%20%2F%3E%3Cattribute%20name%3D'address1_line1'%20%2F%3E%3Cattribute%20name%3D'address1_postalcode'%20%2F%3E%3Cattribute%20name%3D'contactid'%20%2F%3E%3Corder%20attribute%3D'fullname'%20descending%3D'false'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'parentcustomerid'%20alias%3D'aj'%20link-type%3D'inner'%3E%3Cattribute%20name%3D'accountid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3C%2Flink-entity%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'0'%20%2F%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq'%20uitype%3D'account'%20value%3D'" + accId + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    contacts = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                }
            });
            var fetchXMLCon = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'>" +
                                    "<entity name='contact'>" +
                                        "<attribute name='fullname' />" +
                                        "<attribute name='parentcustomerid' />" +
                                        "<attribute name='emailaddress1' />" +
                                        "<attribute name='jobtitle' />" +
                                        "<attribute name='ccrm_countryid' />" +
                                        "<attribute name='address1_city' />" +
                                        "<attribute name='address1_line1' />" +
                                        "<attribute name='address1_postalcode' />" +
                                        "<attribute name='contactid' />" +
                                        "<order attribute='fullname' descending='false' />" +
                                        "<link-entity name='account' from='accountid' to='parentcustomerid' alias='aj' link-type='inner'>" +
                                            "<attribute name='accountid' />" +
                                            "<attribute name='name' />" +
                                        "</link-entity>" +
                                        "<filter type='and'>" +
                                            "<condition attribute='statecode' operator='eq' value='0' />" +
                                        //"<condition attribute='parentcustomerid' operator='eq' value='{051A6371-B843-E211-BDB4-78E7D1652028}' />" +
                                            "<condition entityname= 'aj' attribute='accountid' operator='eq' uitype='account' value='" + accId + "' />" +
                                        "</filter>" +
                                    "</entity>" +
                                "</fetch>";
            //debugger;
            //var connections = XrmServiceToolkit.Soap.Fetch(fetchXML);
            //var contacts = XrmServiceToolkit.Soap.Fetch(fetchXMLCon);
            var connectionLst = [];
            var connectionforNoContactsLst = [];
            var connectionLstTbl = [];
            var contactLst = [];
            var decisionmakercount = 0;

            if (connections.length > 0) {
                for (var i = 0; i < connections.length; i++) {
                    //debugger;
                    var connection = connections[i];

                    var orgTownCity = connection.orgtowncity !=  undefined ? connection.orgtowncity : "";
                    var orgDepartment = connection.orgdepartment != undefined ? connection.orgdepartment : "";
                    var orgOpenOpptys = connection.orgopenopptys != undefined ? connection.orgopenopptys : "";

                    var contact = connection.Contact != undefined ? connection["Contact@OData.Community.Display.V1.FormattedValue"] : "";
                    var contactid = connection.Contact != undefined ? connection.Contact : "";

                    var contactDepartment = connection.contactdepartment  != undefined ? connection.contactdepartment : "";
                    var contactEmail = connection.contactemail != undefined ? connection.contactemail : "";

                    //var contactcountry = connection.attributes.ccrm_countryid != undefined ? connection.attributes.ccrm_countryid.name : "";
                    var contactphone = connection.contactphone != undefined ? connection.contactphone : "";
                    var jobTitle = connection['co.jobtitle'] != undefined ? connection['co.jobtitle'] : "";
                    var userName = connection.CRM_User != undefined ? connection["CRM_User@OData.Community.Display.V1.FormattedValue"] : "";
                    var userid = connection.CRM_User != undefined ? connection.CRM_User : "";
                    var contactimage = connection.contactimage != undefined ? connection.contactimage : "";
                    var userimage = connection.userimage != undefined ? connection.userimage : "";
                    var employmentstatus = connection.employmentstatus != undefined ? connection["employmentstatus@OData.Community.Display.V1.FormattedValue"] : "";

                    var usercountry = connection.usercountry != undefined ? connection.usercountry : "";
                    var accountRole = connection['co.accountrolecode'] != undefined ? connection['co.accountrolecode'] : "";
                    var userPhone = connection.userphone != undefined ? connection.userphone : "";
                    var userCompanyCode = connection.usercompanycode != undefined ? connection.usercompanycode : "";
                    var userAccountingCode = connection.useraccountingcode != undefined ? connection.useraccountingcode : "";
                    var userRegion = connection.userregion != undefined ? connection.userregion : "";
                    var userTitle = connection.usertitle != undefined ? connection.usertitle : "";
                    var conn = {
                        "Contact": contact, "ContactId": contactid, "JobTitle": jobTitle, "ContactPhone": contactphone,
                        "CRMUser": userName, "CRM UserId": userid, "ContactImage": contactimage,
                        "UserImage": userimage, "EmpStatus": employmentstatus, "EmpPhone": userPhone,
                        "EmpCountry": usercountry, "userid": userid, "AccountRole": accountRole,
                        "orgTownCity": orgTownCity, "orgDepartment": orgDepartment, "contactDepartment": contactDepartment,
                        "contactEmail": contactEmail, "userCompanyCode": userCompanyCode, "userAccountingCode": userAccountingCode,
                        "userRegion": userRegion, "orgOpenOpptys": orgOpenOpptys, "userTitle": userTitle
                    };

                    connectionforNoContactsLst.push(conn);
                    if (ContactAccountRoleDM && accountRole == "1") {
                        // Decision Makers
                        connectionLst.push(conn);

                        decisionmakercount = decisionmakercount + 1;
                    }
                    else if (ContactAccountRoleInf && accountRole == "3")
                    {
                        // Influences
                        connectionLst.push(conn);
                    }
                    else if (ContacAccountRoleEmp && accountRole == "2") {
                        // Employees
                        connectionLst.push(conn);
                    }
                    else if (ContactAccountRoleCS && accountRole == "770000000") {
                        // C-Suite
                        connectionLst.push(conn);
                    }
                    else if (ContactAccountRoleOthers && accountRole == "") {
                        // others
                        connectionLst.push(conn);
                    }

                    var conntable = {
                        "Contact": contact, "Job Title": jobTitle, "CRM User": userName
                    };

                    connectionLstTbl.push(conntable);
                }

                bindCountsforGraph(connectionLstTbl.length, accOpenOpptys, decisionmakercount);
                //  DrawMatrixTable("#connectionMatrixtable", connectionLstTbl);
                DrawMatrixForceLayout("#connectionMatrix", connectionLst);
            }

            if (contacts.length > 0) {
                for (var j = 0; j < contacts.length; j++) {
                    var contact = contacts[j];
                    var contFound = contExists(contact.contactid);

                    if (!contFound) {
                        var fullName = contact.fullname != undefined ? contact.fullname : "";
                        //var orgId = connection.attributes['co.jobtitle'] != undefined ? connection.attributes['co.jobtitle'].value : "";
                        var jobTitle = contact.jobtitle != undefined ? contact.jobtitle : "";
                        var email = contact.emailaddress1 != undefined ? contact.emailaddress1 : "";

                        var contarray = {
                            "Full Name": fullName, "Job Title": jobTitle, "Email": email
                        };

                        contactLst.push(contarray);
                    }

                    function contExists(contid) {
                        return connectionforNoContactsLst.some(function (el) {
                            return el.ContactId === contid;
                        });
                    }
                }

                if (contactLst.length > 0) {
                    DrawTable('#connectionMatrixtable', contactLst, Object.keys(contactLst[0]));
                }
                else {
                    $("#p").text("No contact records found");
                }

            }

         //   bindCountsforGraph(connectionLstTbl.length - contactLst.length, accOpenOpptys);

        }

        function bindCountsforGraph(Connectioncount, opptycount, decisionmakercount)
        {
            $('#connectioncount').html(Connectioncount);
            $('#openopportunitycount').html(opptycount);
           // $('#decisionmakercount').html(decisionmakercount);
        }
        function PopulateBasicAccProfile() {
            var oppty;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v9.1/accounts?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%3E%3Centity%20name%3D'account'%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'accountid'%20%2F%3E%3Cattribute%20name%3D'statuscode'%20alias%3D'status'%20%2F%3E%3Cattribute%20name%3D'primarycontactid'%20%2F%3E%3Cattribute%20name%3D'parentaccountid'%20alias%3D'ParentOrganisation'%2F%3E%3Cattribute%20name%3D'ccrm_managingteamid'%20alias%3D'ManagingTeam'%2F%3E%3Cattribute%20name%3D'ccrm_clienttype'%20alias%3D'Clienttype'%20%2F%3E%3Cattribute%20name%3D'ccrm_clientsectorpicklistname'%20alias%3D'ClientSectors'%2F%3E%3Cattribute%20name%3D'websiteurl'%20alias%3D'weburl'%2F%3E%3Cattribute%20name%3D'telephone1'%20alias%3D'telephone'%2F%3E%3Cattribute%20name%3D'ccrm_keyaccountmanagerid'%2F%3E%3Cattribute%20name%3D'ccrm_keyaccount'%2F%3E%3Cattribute%20name%3D'description'%2F%3E%3Cattribute%20name%3D'address1_postalcode'%20%2F%3E%3Cattribute%20name%3D'address1_line3'%20%2F%3E%3Cattribute%20name%3D'address1_line2'%20%2F%3E%3Cattribute%20name%3D'address1_line1'%20%2F%3E%3Cattribute%20name%3D'address1_city'%20%2F%3E%3Cattribute%20name%3D'ccrm_address1attentiondepartment'%20alias%20%3D%20'orgdepartment'%20%2F%3E%3Cattribute%20name%3D'arup_openopportunitiescalc'%20alias%20%3D%20'orgopenopptys'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'accountid'%20operator%3D'eq'%20value%3D'" + accId + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    oppty = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                }
            });
            var fetchXML = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>" +
                              "<entity name='account'>" +
                                "<attribute name='name' />" +
                                "<attribute name='accountid' />" +
                                "<attribute name='statuscode' alias='status' />" +
                                "<attribute name='primarycontactid' />" +
                                "<attribute name='parentaccountid' alias='ParentOrganisation'/>" +
                                "<attribute name='ccrm_managingteamid' alias='ManagingTeam'/>" +
                                "<attribute name='ccrm_clienttype' alias='Clienttype' />" +
                                "<attribute name='ccrm_clientsectorpicklistname' alias='ClientSectors'/>" +
                                "<attribute name='websiteurl' alias='weburl'/>" +
                                "<attribute name='telephone1' alias='telephone'/>" +
                                "<attribute name='ccrm_keyaccountmanagerid'/>" +
                                "<attribute name='ccrm_keyaccount'/>" +
                                "<attribute name='description'/>" +
                                "<attribute name='address1_postalcode' />" +
                                "<attribute name='address1_line3' />" +
                                "<attribute name='address1_line2' />" +
                                "<attribute name='address1_line1' />" +
                                "<attribute name='address1_city' />" +
                                "<attribute name='ccrm_address1attentiondepartment' alias = 'orgdepartment' />" +
                                "<attribute name='arup_openopportunitiescalc' alias = 'orgopenopptys' />" +
                                "<filter type='and'>" +
                                    "<condition attribute='accountid' operator='eq' value='" + accId + "' />" +
                                "</filter>" +
                              "</entity>" +
                            "</fetch>";
            //var oppty = XrmServiceToolkit.Soap.Fetch(fetchXML);
            if (oppty.length > 0) {
                //debugger;
                var result = oppty[0];
                var basicProfile = {
                    accountId: result.accountid,
                    address_comosite: result.address1_composite != undefined ? result.address1_composite : "",
                    address1_City: result.address1_city != undefined ? result.address1_city : "",
                    address1_Line1: result.address1_line1 != undefined ? result.address1_line1 : "",
                    address1_Line2: result.address1_line2 != undefined ? result.address1_line2 : "",
                    address1_Line3: result.address1_line3 != undefined ? result.address1_line3 : "",
                    address1_PostalCode: result.address1_postalcode != undefined ? result.address1_postalcode : "",
                    //ccrm_ClientSectorPicklistName: result.ClientSectors,
                    ccrm_ClientSectorValue: result.ClientSectors != undefined ? result.ClientSectors : "",
                    ccrm_ClientType: result.Clienttype != undefined ? result["Clienttype@OData.Community.Display.V1.FormattedValue"] : "",
                    ccrm_keyaccountmanagerid: result.ccrm_keyaccountmanagerid != undefined ? result.ccrm_keyaccountmanagerid : "",
                    ccrm_keyaccountmanagername: result.ccrm_keyaccountmanagerid != undefined ? result["ccrm_keyaccountmanagerid@OData.Community.Display.V1.FormattedValue"] : "",
                    ccrm_keyaccount: result.ccrm_keyaccount != undefined ? result.ccrm_keyaccount : false,
                    ccrm_managingteamid: result.ManagingTeam != undefined ? result.ManagingTeam : "",
                    description: result.description != undefined ? result.description : "",
                    name: result.name != undefined ? result.name : "",
                    parentAccountId: result.ParentOrganisation != undefined ? result["ParentOrganisation@OData.Community.Display.V1.FormattedValue"] : "",
                    //primaryContactId: result.PrimaryContactId,
                    //stateCode: result.StateCode,
                    statusCode: result.status,
                    telephone1: result.telephone != undefined ? result.telephone : "",
                    webSiteURL: result.weburl != undefined ? result.weburl : "",
                    orgdepartment: result.orgdepartment != undefined ? result.orgdepartment : "",
                    orgopenopptys: result.orgopenopptys != undefined ? result.orgopenopptys : ""
                };
                AssociateProfileDataWithReport(basicProfile);
            }
        }
        function AssociateProfileDataWithReport(profileData) {
            //debugger;
            var address = '';
            if (profileData.address1_Line1 != null && profileData.address1_Line1.length > 0) {
                address = address + profileData.address1_Line1.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
            }
            if (profileData.address1_Line2 != null && profileData.address1_Line2.length > 0) {
                address = address + profileData.address1_Line2.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
            }
            if (profileData.address1_Line3 != null && profileData.address1_Line3.length > 0) {
                address = address + profileData.address1_Line3.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
            }
            if (profileData.address1_City != null && profileData.address1_City.length > 0) {
                address = address + profileData.address1_City.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
                accTownCity = profileData.address1_City.replace('\t', '').replace('\r', '').replace('\f', '');
            }
            if (profileData.address1_PostalCode != null && profileData.address1_PostalCode.length > 0) {
                address = address + profileData.address1_PostalCode.replace('\t', '').replace('\r', '').replace('\f', '');
            }
            if (profileData.orgdepartment != "") {
                accDepartment = profileData.orgdepartment;
            }
            if (profileData.orgopenopptys != "") {
                accOpenOpptys = profileData.orgopenopptys;
            }

            accName = profileData.name;
            isManagedClient = profileData.ccrm_keyaccount;
            relationshipManager = profileData.ccrm_keyaccountmanagerid;
            relationshipManagername = profileData.ccrm_keyaccountmanagername;

            $("#accountName").text(profileData.name +"  (" + accTownCity + ")  ");
            $("#website").text(profileData.webSiteURL);
            $("#relationshipmanager").text(profileData.ccrm_keyaccountmanagername);
            if (profileData.parentAccountId != null) {
                $("#parentOrg").text(profileData.parentAccountId);
            }
            $("#relationshipteam").text(profileData.ccrm_managingteamid);
            $("#phonenum").text(profileData.telephone1);
            $("#address").text(address);
            $("#clientType").text(profileData.ccrm_ClientType);
            $("#clientSector").text(profileData.ccrm_ClientSectorValue);
            $("#clientDesc").text(profileData.description);
        }
        function DrawTable(div, data, columns) {
            d3.select(div).selectAll("table").remove();
            var relTable = d3.select(div).append('table').attr('width', '100%');
            var tabHead = relTable.append('thead');
            var tabBody = relTable.append('tbody');
            tabHead.append('tr')
            .selectAll('th')
            .data(function (d) { return columns })
            .enter()
            .append('th')
            .style('width', function (d) {
                if (d == 'Created On' || d == 'Date Won' || d == 'Date') {
                    return '50px';
                }
                else if (d == 'Prob. Proj Proceed %' || d == 'Probability of Win %') {
                    return '60px';
                }
                else if (d == 'Project Director') {
                    return '150px';
                }
                else if (d == 'Full Name' || d == 'Email') {
                    return '300px';
                }
                else if (d == 'Job Title') {
                    return '500px';
                }
            })
            .text(function (col) { return col; }).style('background-color', 'rgba(158, 158, 158, 0.5)');


            var rows = tabBody.selectAll('tr')
            .data(data)
            .enter()
            .append('tr').style('background-color', function (d, i) {
                if (i % 2 == 0) {
                    return 'rgba(158, 158, 158, 0.05)';
                }
                else {
                    return 'rgba(158, 158, 158, 0.2)';
                }
            });

            rows.selectAll('td')
            .data(function (row) {
                return columns.map(function (column) {
                    return { column: column, value: row[column], OpportunityId: row["OpportunityId"] };
                })
            })
            .enter()
            .append('td')
            .style('text-align', function (d) {
                if (d.column == 'Created On' || d.column == 'Date' || d.column == 'Arup Start Date' || d.column == 'Date Won'
                    || d.column == 'Total Fee Income' || d.column == 'Prob. Proj Proceed %' || d.column == 'Probability of Win %') {
                    return 'center';
                }
            })
            .html(function (d) {
                if (div == '#top10OpenOportunities' && d.column == 'Title') {
                    return '<a href=\"' + GetGlobalContext().getClientUrl() + '/main.aspx?etc=3&pagetype=entityrecord&id=%7b' + d.OpportunityId + '%7d' + '\" target=\"_blank\">' + d.value + '</a>';
                }
                else {
                    return d.value;
                }
            });
        }
        function DrawMatrixTable(div, data) {
            var nested = data.filter(function (currentValue, index, arr) { if (index >= arr.length - 10) return currentValue; });

            var columns = Object.keys(data[0]).slice(0, 2);

            var matrixData = [];

            var ContactRows = d3.nest()
                .key(function (d) { return d['Contact']; })
                .rollup(function (leaves) {
                    leaves.forEach(function (leave) {
                        matrixData.push({ key: leave['Contact'], value: leave['CRM User'] });

                    })
                    return leaves[0];
                })
                .entries(nested);

            var crmusers = d3.nest()
                .key(function (d) { return d['CRM User']; })
                .entries(nested);

            crmusers.sort(function (a, b) {

                if (a.key < b.key) {
                    return -1;
                }
                if (a.key > b.key) {
                    return 1;
                }
                // a must be equal to b
                return 0;
            }).map(function (d) { columns.push(d.key); });

            var relTable = d3.select(div).append('table');
            var tabHead = relTable.append('thead');
            var tabBody = relTable.append('tbody');

            tabHead.append('tr')
                .selectAll('th')
                .data(function (d) { return columns })
                .enter()
                .append('th')
                .text(function (col) { return col; }).style('background-color', 'lightgray');

            var rows = tabBody.selectAll('tr')
                .data(ContactRows)
                .enter()
                .append('tr');

            rows.selectAll('td')
                .data(function (row) {
                    return columns.map(function (column) {
                        //if (row['CRM User'] == column) {
                        //    return { column: column, value: row[column], Color: 'gray' };
                        //}
                        //else {
                        //    return { column: column, value: row[column], Color: 'lightgray' };
                        //}
                        var exist = matrixData.filter(function (c, i, a) {
                            if (c.value == column && c.key == row.key) { return c; }
                        })
                        if (exist.length > 0) {
                            return { column: column, value: "", Color: 'gray' };
                        }
                        else {
                            return { column: column, value: row.value[column], Color: 'lightgray' };
                        }
                    })
                })
                .enter()
                .append('td')
                .text(function (d) { return d.value }).style('background-color', function (d) { return d.Color });
        }
        var currentscale = 1.5;

        function DrawMatrixForceLayout(div, conData, isUserClick) {

            if (isUserClick == undefined)
                isUserClick = false;

            var nodelink = Object();
            nodelink.nodes = [];
            nodelink.links = [];

            if (!isUserClick) {
                nodelink.nodes.push({
                    id: accName, name: accName, group: 1, rad: 10, imageUrl: '../../arup_graphOrg', phone: "", jobtitleorCountry: "", userid: "100",
                    orgTownCity: accTownCity, orgDepartment: accDepartment, contactDepartment: "",
                    contactEmail: "", userCompanyCode: "", userAccountingCode: "",
                    userRegion: "", orgOpenOpptys: accOpenOpptys, userTitle: ""
                });
            }

            var arupContact = d3.nest()
                            .key(function (d) { return d['CRM UserId']; })
                            .entries(conData);
            var clientContact = d3.nest()
                            .key(function (d) { return d['ContactId']; })
                            .entries(conData);
            arupContact.forEach(function (ac, i) {
                //var userpro = conData.filter(function (currentValue, index, arr) { if (currentValue['CRM User'] == ac.key) return true; });
                nodelink.nodes.push({
                    id: ac.key, group: 2, rad: 7, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].UserImage, empstatus: ac.values[0].EmpStatus, name: ac.values[0].CRMUser
                    , phone: ac.values[0].EmpPhone, jobtitleorCountry: ac.values[0].EmpCountry, userid: ac.values[0].userid,
                    orgTownCity: ac.values[0].orgTownCity, orgDepartment: ac.values[0].orgDepartment, contactDepartment: ac.values[0].contactDepartment,
                    contactEmail: ac.values[0].contactEmail, userCompanyCode: ac.values[0].userCompanyCode, userAccountingCode: ac.values[0].userAccountingCode,
                    userRegion: ac.values[0].userRegion, orgOpenOpptys: ac.values[0].orgOpenOpptys,userTitle : ac.values[0].userTitle
                });
                if (!isUserClick)
                nodelink.links.push({ source: accName, target: ac.key, value: 2 });
            })

            var contactsids = [];
            clientContact.forEach(function (ac, i) {
                //var contactpro = conData.filter(function (currentValue, index, arr) { if (currentValue['Contact'] == ac.key) return true; });
                var ContactRadius = 4;
                var ContactGroup = 3
                if (ac.values[0].AccountRole == "1")  // Decision Maker
                {
                    ContactRadius = 10;
                    ContactGroup = 6;
                }
                else if (ac.values[0].AccountRole == "3") // Influencer
                {
                    ContactRadius = 10;
                    ContactGroup = 6;
                }
                nodelink.nodes.push({
                    id: ac.key, group: ContactGroup, rad: ContactRadius, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].ContactImage,
                    name: ac.values[0].Contact, phone: ac.values[0].ContactPhone, jobtitleorCountry: ac.values[0].JobTitle, userid: "200",
                    orgTownCity: ac.values[0].orgTownCity, orgDepartment: ac.values[0].orgDepartment, contactDepartment: ac.values[0].contactDepartment,
                    contactEmail: ac.values[0].contactEmail, userCompanyCode: ac.values[0].userCompanyCode, userAccountingCode: ac.values[0].userAccountingCode,
                    userRegion: ac.values[0].userRegion, orgOpenOpptys: ac.values[0].orgOpenOpptys,userTitle : ac.values[0].userTitle
                });
                //  contactsids.push(ac.values[0].ContactId);

            })

                conData.forEach(function (cc, i) {
                    nodelink.links.push({ source: cc['CRM UserId'], target: cc['ContactId'], value: 1 });
                })




            var svgwidth = $("#connForcelay").width()

            var svg = d3.select("#connForcelay"),
        width = +svgwidth,
        height = +svg.attr("height");

            var zoom = d3.zoom().scaleExtent([1 / 2, 4]).on("zoom", zoomed);

            svg.call(zoom);


            //svg.append("rect")
            //    .attr("width", width)
            //    .attr("height", height)
            //    .style("fill", "none")
            //    .style("pointer-events", "all");

            var g = svg.append("g");


            //////////////////////////
            var config = {
                "avatar_size": 10
            }

            var body = d3.select("body");
            var defs = svg.append('svg:defs');
            data = [{
                posx: 30,
                posy: 20,
                posx1: 25,
                posy1: 15,
                img: "../../arup_/Images/Contact.png",
                color: "#28AF73",
                "label": "Relationship Manager",
                width : 10
            }, {
                posx: 170,
                posy: 20,
                posx1: 165,
                posy1: 15,
                img: "../../arup_/Images/Contact.png",
                color: "#A0235F",
                "label": "Relationship Team",
                width: 10
            }, {
                posx: 310,
                posy: 20,
                posx1: 305,
                posy1: 15,
                img: "../../arup_/Images/Contact.png",
                color: "#666666",
                "label": "Arup Non-Employee",
                width: 10
            },
             {
                 posx: 450,
                 posy: 20,
                 posx1: 445,
                 posy1: 15,
                 img: "../../arup_/Images/Contact.png",
                 color: "#1982AF",
                 "label": "Arup Contacts",
                 width: 10
             },
              {
                  posx: 590,
                  posy: 20,
                  posx1: 585,
                  posy1: 15,
                  img: "../../arup_/Images/Contact.png",
                  color: "#32325F",
                  "label": "Arup Users",
                  width: 10
              },
               {
                   posx: 730,
                   posy: 20,
                   posx1: 718,
                   posy1: 10,
                   img: "../../arup_graphOrg",
                   color: "#875005",
                   "label": "Organisations",
                   width: 20
               }

            ];

            data.forEach(function (d, i) {
                svg.append("circle")
                .attr('cx', d.posx)
                          .attr('cy', d.posy)
                         .attr('r', config.avatar_size)
                         .style("stroke-width", 1)
                          .attr("fill", d.color)
                     .style("stroke", d.color)

                svg.append('clipPath')
                   .attr('id', 'clipObj' + i)
                        .append('circle')
                         .attr('cx', d.posx)
                          .attr('cy', d.posy)
                         .attr('r', config.avatar_size)

            })

            data.forEach(function (d, i) {
                var xaxis, yaxis, width
                if (d.label == "Organisations") {
                    width = config.avatar_size * 3;
                    xaxis = parseInt(d.posx - (config.avatar_size + config.avatar_size * .5));
                    yaxis = parseInt(d.posy - (config.avatar_size + config.avatar_size * .5));
                }
                else {
                    width = config.avatar_size + config.avatar_size * .1;
                    xaxis = parseInt(d.posx - config.avatar_size + config.avatar_size * .45);
                    yaxis = parseInt(d.posy - config.avatar_size + config.avatar_size * .45)
                }
                svg.append('image')
                   .attr('xlink:href', d.img)
                   .attr('width',width)
                   .attr('height',width)
                    .attr('x', xaxis)
                      .attr('y', yaxis)
                  // .attr('transform', 'translate(' + parseInt(d.posx1) + ',' + parseInt(d.posy1) + ')')
                   // .attr('transform', 'translate(' + parseInt(d.posx - config.avatar_size + config.avatar_size * .45) + ',' + parseInt(d.posy - config.avatar_size + config.avatar_size * .45) + ')')
                   .attr('clip-path', "url(#clipObj" + i + ")")

            })
            var text = svg.selectAll("text")
                 .data(data)
                 .enter()
                 .append("text");


            var textLabels = text
            .attr("x", function (d) { return d.posx + 15; })
            .attr("y", function (d) { return d.posy + 5; })
            .text(function (d) { return d.label; });


            ////////////////////////////



            function zoomed() {
                g.attr('transform', 'translate(' + d3.event.transform.x + ',' + d3.event.transform.y + ') scale(' + d3.event.transform.k + ')');
                currentscale = d3.event.transform.k;
            };

            if (currentscale != "") {
                svg.transition()
                      .delay(100)
                      .duration(700)
                      .call(zoom.scaleTo, currentscale);

            }

            function transition(zoomLevel) {
                svg.transition()
                    .delay(100)
                    .duration(700)
                    .call(zoom.scaleBy, zoomLevel);
                //.call(zoom.transform, transform);
                //.on("end", function() { canvas.call(transition); });
            }

            d3.selectAll('button').on('click', function () {
                if (this.id === 'zoom_in') {
                    transition(1.2); // increase on 0.2 each time
                }
                if (this.id === 'zoom_out') {
                    transition(0.8); // deacrease on 0.2 each time
                }
                if (this.id === 'zoom_init') {
                    svg.transition()
                        .delay(100)
                        .duration(700)
                        .call(zoom.scaleTo, 1.5); // return to initial state
                }
                if(this.id === 'btnresize')
                {
                    if (sizetoggle == 0) {
                        $(div).css("height", "90%");
                        $('.row').css("width", "100%");
                        $('#connForcelay').css("height", "1100px");
                        //$('#maindivGraph').removeClass('col-md-9 ml-sm-auto col-lg-10').addClass('col-md-9 ml-sm-auto col-lg-12');
                        //$('#seconddivgraph').hide();
                        $('#clientconnectionHelp').hide();
                        $('#showhideNav').hide();
                        $('#seconddivgraph').css({ 'margin-top': '0px' });

                        sizetoggle = 1;
                    }
                    else {
                        $(div).css("height", "75%");
                        $('.row').css("width", "100%");
                        $('#connForcelay').css("height", "800px");
                        //$('#maindivGraph').removeClass('col-md-9 ml-sm-auto col-lg-12').addClass('col-md-9 ml-sm-auto col-lg-10');
                        //$('#seconddivgraph').show();
                        $('#clientconnectionHelp').show();
                        $('#showhideNav').show();
                        $('#seconddivgraph').css({ 'margin-top': '65px' });
                        sizetoggle = 0;
                    }
                }

            });

            var color = d3.scaleOrdinal(d3.schemeCategory20);


            var simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(function (d) { return d.id; }).distance(function (d, i) { return 30 + i }))
                .force("charge", d3.forceManyBody().strength(-100))
                .force("center", d3.forceCenter(width / 2, height / 2));


            var link = g.append("g")
                .attr("class", "links")
              .selectAll("line")
              .data(nodelink.links)
              .enter().append("line")
                .style("stroke-dasharray", (0, function (d) {
                    if (d.value == 1) {
                        return 3;
                    }
                    else { return 0; }
                }))
                .style('stroke', function (d) {
                    //debugger;
                    if (isManagedClient) {
                        if (d.source == relationshipManager || d.target == relationshipManager) {
                            return "#28AF73";
                        }
                        else if (relTeamMembers.indexOf(d.source) > -1 || relTeamMembers.indexOf(d.target) > -1) {
                            return "#A0235F";
                        }
                    }
                })
                .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

            var node = g.append("g")
               .attr("class", "nodes")
             .selectAll("circle")
             .data(nodelink.nodes)
             .enter().append("g")
             .on('dblclick', releasenode)
             .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            var circle = node.append("circle")
                .attr("r", function (d) { return d.rad; })
                .attr("fill", function (d) { return GetNodeBackGrdClr(d, color) })
                .style("stroke", function (d) { return GetNodeBackGrdClr(d, color) })
                .style("stroke-width", function (d) { return GetNodeBackGrdStrokeWidth(d) })
             .on("click", function (d) {
                 tooltip.style("visibility", "hidden");
                 getDataforUser(d.userid, d.id)
             })
             .on("mouseover", function (d) {
                 connectedNodes(d);
                 var tooltipcontent = getToolTipsForConnection(d);
                 tooltip.html(tooltipcontent);
                 return tooltip.style("visibility", "visible");
                 // tooltip.html(d.name + "<br/>" + d.jobtitleorCountry + "<br/>" + d.phone); return tooltip.style("visibility", "visible");

             })
          .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
          .on("mouseout", function (d) { removehighlighting(d); return tooltip.style("visibility", "hidden"); });

            // add circle clip
            var clipPath = node.append("clipPath")
                                        .attr("id", function (d, i) {
                                            return "clipCircle_" + i
                                        })
                                        .append("circle")
                                        .attr("r", function (d) { return d.rad });


         var tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("z-index", "12")
        .style("visibility", "hidden")
        .style("background", "#5C9BD1")
        .style("color", "white")
        .style("padding", "5px")
        .style("margin", "2px")
        .style("font-size", "12px")
        .style( "box-shadow", "0px 5px 15px 0px rgba(0,0,0,0.3)")
        .text("a simple tooltip");

            var image = node.append('svg:image').attr('class', 'entityImage').attr('xlink:href', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.imageUrl;
                }
                else {
                    return '../../arup_/Images/Contact.png';
                }
            })
            .attr('width', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.rad * 3;
                }
                else {
                    return d.rad + d.rad * .1;
                }
            })
            .attr('height', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.rad * 3;
                }
                else {
                    return d.rad + d.rad * .1;
                }
            })
            .attr("clip-path", function (d, i) { return "url(#clipCircle_" + i + ")" })
             .on("click", function (d) {
                 tooltip.style("visibility", "hidden");
                 getDataforUser(d.userid, d.id)
             })
             .on("mouseover", function (d) {
                 connectedNodes(d);
                 var tooltipcontent = getToolTipsForConnection(d);
                 tooltip.html(tooltipcontent); return tooltip.style("visibility", "visible");

               //  tooltip.html(d.name + "<br/>" + d.jobtitleorCountry + "<br/>" + d.phone); return tooltip.style("visibility", "visible");
             })
          .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
          .on("mouseout", function (d) { removehighlighting(d); return tooltip.style("visibility", "hidden"); });

            var nodeText = node.append('svg:text').attr('class', 'nodetext').text(function (d) {
                var name = d.name.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                if (name.length > 20) {
                    name = name.substring(0, 20) + "...";
                }
                if (isManagedClient) {
                    if (d.id == relationshipManager) {
                        return name + " (RM)";
                    }
                    else if (relTeamMembers.indexOf(d.id) > -1) {
                        return name + " (RT)";
                    }
                    else {
                        return name;
                    }
                }
                return name;
            }).style("text-anchor", "middle");


            //var title = node.append("title")
            //     .text(function (d) { return d.id; });

            simulation
                .nodes(nodelink.nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(nodelink.links);

            function ticked() {
                link
                    .attr("x1", function (d) { return d.source.x; })
                    .attr("y1", function (d) { return d.source.y; })
                    .attr("x2", function (d) { return d.target.x; })
                    .attr("y2", function (d) { return d.target.y; });

                circle
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });

                clipPath
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });

                image
                    .attr("x", function (d) {
                        if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                            return d.x - d.rad - d.rad * .5;
                        }
                        else {
                            return d.x - d.rad + d.rad * .45;
                        }
                    })
                    .attr("y", function (d) {
                        if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                            return d.y - d.rad - d.rad * .5;
                        }
                        else {
                            return d.y - d.rad + d.rad * .45;
                        }

                    });


                nodeText
                    .attr("dx", function (d) { return d.x - function (d) { return d.name.normalize('NFD').replace(/[\u0300-\u036f]/g, "") }.length / 2 * 3; })
                    .attr("dy", function (d) {
                        if (d.group == 1) {
                            return d.y - 11;
                        }
                        else if (d.group == 2) {
                            return d.y - 8;
                        }
                        else if (d.group == 6) {
                            return d.y - 11;
                        }
                        else {
                            return d.y - 5;
                        }
                    });


            }


            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                //d.fx = null;
                //d.fy = null;
                d.fx = d.x;
                d.fy = d.y;
            }

            function releasenode(d) {
                //d.fx = false; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
                //force.resume();
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            ////////////////////////////////////////////////////////////////////////////////

            function connectedNodes(d) {
                var connectedlinks = link.filter(function (e) {
                    //return e.source.id == d.id || e.target.id == d.id; //connected links
                    if( e.source.id == d.id || e.target.id == d.id)
                    {
                        node.filter(function (k) {
                            return k.id != d.id;
                        }).style('stroke-opacity', 0.1);
                        return d.id;
                    }
                }).style('stroke', 'red')
                  .attr('r', 15);


                var disconnectedlinks =
                     link.filter(function (e) {
                         return e.source.id != d.id && e.target.id != d.id; //disconnected links
                     }).style('stroke-opacity', 0.1)
                  .attr('r', 15);
            }
            function removehighlighting(d)
            {
                var connectedlinks = link.filter(function (e) {
                    if (e.source.id == d.id || e.target.id == d.id) { //connected links
                        node.filter(function (k) {
                            return k.id != d.id;
                        }).style('stroke-opacity', 0.6);
                        return d.id;
                    }
                })
                 .style('stroke', function (d) {
                     //debugger;
                     if (isManagedClient) {
                         if (d.source.id == relationshipManager || d.target.id == relationshipManager) {
                             return "#28AF73";
                         }
                         else if (relTeamMembers.indexOf(d.source.id) > -1 || relTeamMembers.indexOf(d.target.id) > -1) {
                             return "#A0235F";
                         }
                         else return '#999'
                     }
                     else return '#999'

                 }) .attr('r', 15)

                var disconnectedlinks =
                  link.filter(function (e) {
                      return e.source.id != d.id && e.target.id != d.id; //disconnected links
                  }).style('stroke-opacity', 0.6)
               .attr('r', 15);

            }
            /////////////////////////////////////////////////////



        }

        function getDataforUser(userid, id) {
            if (userid === "100") {
                   PopulateConnection(true, true, true, true, true);
                }
                else if (userid === "200") {
                    PopulateConnectionForContact(id);
                }
                else if (userid == "400" || userid == "500" || userid == "1000")
                {
                    return;
                }
            if (userid != "" && userid != "100" && userid != "200") {
                $('#chkShowAllConnectionsforUser').prop('checked', false);
                PopulateConnectionForuser(userid);
                currentselectedUserid = userid;
            }
        }

        var currentorgid = "";
        var currentorgname = "";
        var currentOpportunityid = "";
        function getDataforOpportunity(userid, id, name)
         {
            $('#chkShowBidTeam').prop('checked', false);
            var chkShowInternal = $("#chkShowInternal").is(':checked') ? true : false;
            var chkShowBidTeam = $("#chkShowBidTeam").is(':checked') ? true : false;
            $("input[name=opportunitystatus]").prop("checked", false);
            if(userid == "600")
            {
                currentOpportunityid = id;
                OpportunityMatrix(currentorgid, currentorgname, id,chkShowBidTeam, "", chkShowInternal);
            }
            else if (userid == "100") {
                currentorgid = id;
                currentorgname = name;
                currentOpportunityid = "";
                OpportunityMatrix(id, name, "", chkShowBidTeam, "", chkShowInternal);
                //PopulateOpportunities();
            }

       }

        function PopulateConnectionForContact(clickcontactid) {
            ConnectionContactData = "";
            $("#Connectionfilters").show();
            $("#Accountfilters").hide();
            $("#Userfilters").hide();

            InititializeGraphDivs();

            InitializeHomeButtonClick();
            var connections;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v9.1/connections?fetchXml=%3Cfetch%20distinct%3D'true'%20%3E%3Centity%20name%3D'connection'%20%3E%3Cattribute%20name%3D'record1id'%20alias%3D'Contact'%20%2F%3E%3Cattribute%20name%3D'record2id'%20alias%3D'CRM_User'%20%2F%3E%3Corder%20attribute%3D'record1id'%20descending%3D'false'%20%2F%3E%3Cfilter%3E%3Ccondition%20attribute%3D'statuscodename'%20operator%3D'eq'%20value%3D'Active'%20%2F%3E%3Ccondition%20attribute%3D'record1objecttypecode'%20operator%3D'eq'%20value%3D'2'%20%2F%3E%3Ccondition%20attribute%3D'record2objecttypecode'%20operator%3D'eq'%20value%3D'8'%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'contact'%20from%3D'contactid'%20to%3D'record1id'%20link-type%3D'inner'%20alias%3D'co'%20%3E%3Cattribute%20name%3D'accountrolecode'%20%2F%3E%3Cattribute%20name%3D'jobtitle'%20%2F%3E%3Cattribute%20name%3D'department'%20alias%20%3D%20'contactdepartment'%20%20%2F%3E%3Cattribute%20name%3D'emailaddress1'%20alias%20%3D'contactemail'%2F%3E%3Cattribute%20name%3D'telephone1'%20alias%20%3D%20'contactphone'%20%2F%3E%3Cattribute%20name%3D'emailaddress1'%20%2F%3E%3Cattribute%20name%3D'ccrm_countryid'%20%2F%3E%3Cattribute%20name%3D'accountrolecodename'%20%2F%3E%3Cattribute%20name%3D'contactid'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20alias%3D'contactimage'%20%2F%3E%3Cfilter%20type%3D'and'%20%3E%3Ccondition%20attribute%3D'statuscodename'%20operator%3D'eq'%20value%3D'Active'%20%2F%3E%3Ccondition%20attribute%3D'contactid'%20operator%3D'eq'%20value%3D'" + clickcontactid + "'%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'parentcustomerid'%20link-type%3D'inner'%20alias%3D'ac'%20%3E%3Cattribute%20name%3D'accountid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D'listmember'%20from%3D'entityid'%20to%3D'contactid'%20link-type%3D'outer'%20%3E%3Cattribute%20name%3D'listid'%20%2F%3E%3Clink-entity%20name%3D'list'%20from%3D'listid'%20to%3D'listid'%20link-type%3D'outer'%20%3E%3Cattribute%20name%3D'listname'%20alias%20%3D%20'memberlistname'%2F%3E%3Cattribute%20name%3D'listid'%20alias%20%3D%20'memberlistid'%20%2F%3E%3Cattribute%20name%3D'createdon'%20alias%20%3D%20'mlcreatedon'%20%2F%3E%3Cattribute%20name%3D'ownerid'%20alias%3D'mlownerid'%20%2F%3E%3Cattribute%20name%3D'ccrm_arupoffice'%20alias%20%3D%20'mlarupoffice'%20%2F%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D'activitypointer'%20from%3D'regardingobjectid'%20to%3D'contactid'%20link-type%3D'outer'%20%3E%3Cattribute%20name%3D'activityid'%20alias%20%3D%20'activityid'%20%2F%3E%3Cattribute%20name%3D'subject'%20%20alias%20%3D%20'activitysubject'%2F%3E%3Cattribute%20name%3D'activitytypecode'%20alias%20%3D%20'activitytypecode'%20%2F%3E%3Cattribute%20name%3D'statecode'%20alias%3D'activitystatecode'%20%2F%3E%3Cattribute%20name%3D'prioritycode'%20alias%20%3D%20'activitypriority'%20%2F%3E%3Cattribute%20name%3D'ownerid'%20alias%20%3D%20'activityowner'%20%2F%3E%3Cattribute%20name%3D'scheduledend'%20alias%20%3D%20'activityduedate'%20%2F%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D'systemuser'%20from%3D'systemuserid'%20to%3D'record2id'%20%3E%3Cattribute%20name%3D'arup_employmentstatus'%20alias%3D'employmentstatus'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20alias%3D'userimage'%20%2F%3E%3Cattribute%20name%3D'title'%20%2F%3E%3Cattribute%20name%3D'systemuserid'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20%2F%3E%3Cattribute%20name%3D'address1_country'%20alias%3D'usercountry'%20%2F%3E%3Cattribute%20name%3D'mobilephone'%20%2F%3E%3Cattribute%20name%3D'address1_telephone1'%20alias%3D'userphone'%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    connections = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                }
            });
            //new fectxml -  everything is same just modified to populate user/contact image url
            var fetchXML = "<fetch distinct='true' >" +
                              "<entity name='connection' >" +
                                "<attribute name='record1id' alias='Contact' />" +
                                "<attribute name='record2id' alias='CRM_User' />" +
                                "<order attribute='record1id' descending='false' />" +
                                "<filter>" +
                                  "<condition attribute='statuscodename' operator='eq' value='Active' />" +
                                  "<condition attribute='record1objecttypecode' operator='eq' value='2' />" +
                                  "<condition attribute='record2objecttypecode' operator='eq' value='8' />" +
                                "</filter>" +
                                "<link-entity name='contact' from='contactid' to='record1id' link-type='inner' alias='co' >" +
                                  "<attribute name='accountrolecode' />" +
                                  "<attribute name='jobtitle' />" +
                                     "<attribute name='department' alias = 'contactdepartment'  />" +
                                  "<attribute name='emailaddress1' alias ='contactemail'/>" +
                                    "<attribute name='telephone1' alias = 'contactphone' />" +
                                  "<attribute name='emailaddress1' />" +
                                  "<attribute name='ccrm_countryid' />" +
                                  "<attribute name='accountrolecodename' />" +
                                  "<attribute name='contactid' />" +
                                  "<attribute name='entityimage_url' alias='contactimage' />" +
                                  "<filter type='and' >" +
                                    "<condition attribute='statuscodename' operator='eq' value='Active' />" +
                                    "<condition attribute='contactid' operator='eq' value='" + clickcontactid + "' />" +
                                  "</filter>" +
                                  "<link-entity name='account' from='accountid' to='parentcustomerid' link-type='inner' alias='ac' >" +
                                    "<attribute name='accountid' />" +
                                    "<attribute name='name' />" +
                                  "</link-entity>" +
                                  "<link-entity name='listmember' from='entityid' to='contactid' link-type='outer' >" +
                                    "<attribute name='listid' />" +
                                    "<link-entity name='list' from='listid' to='listid' link-type='outer' >" +
                                      "<attribute name='listname' alias = 'memberlistname'/>" +
                                       "<attribute name='listid' alias = 'memberlistid' />" +
                                        "<attribute name='createdon' alias = 'mlcreatedon' />" +
                                        "<attribute name='ownerid' alias='mlownerid' />" +
                                        "<attribute name='ccrm_arupoffice' alias = 'mlarupoffice' />" +
                                    "</link-entity>" +
                                  "</link-entity>" +
                                  "<link-entity name='activitypointer' from='regardingobjectid' to='contactid' link-type='outer' >" +
                                    "<attribute name='activityid' alias = 'activityid' />" +
                                    "<attribute name='subject'  alias = 'activitysubject'/>" +
                                    "<attribute name='activitytypecode' alias = 'activitytypecode' />" +
                                      "<attribute name='statecode' alias='activitystatecode' />" +
                                        "<attribute name='prioritycode' alias = 'activitypriority' />"+
                                        "<attribute name='ownerid' alias = 'activityowner' />"+
                                        "<attribute name='scheduledend' alias = 'activityduedate' />"+
                                  "</link-entity>" +
                                "</link-entity>" +
                                "<link-entity name='systemuser' from='systemuserid' to='record2id' >" +
                                  "<attribute name='arup_employmentstatus' alias='employmentstatus' />" +
                                  "<attribute name='entityimage_url' alias='userimage' />" +
                                  "<attribute name='title' />" +
                                  "<attribute name='systemuserid' />" +
                                  "<attribute name='entityimage_url' />" +
                                  "<attribute name='address1_country' alias='usercountry' />" +
                                  "<attribute name='mobilephone' />" +
                                  "<attribute name='address1_telephone1' alias='userphone' />" +
                                "</link-entity>" +
                              "</entity>" +
                            "</fetch>";


           // var connections = XrmServiceToolkit.Soap.Fetch(fetchXML);
            var connectionLst = [];
            var connectionLstTbl = [];
            var contactLst = [];

            if (connections.length > 0) {
                for (var i = 0; i < connections.length; i++) {
                    //debugger;
                    var connection = connections[i];
                    var contact = connection.Contact != undefined ? connection["Contact@OData.Community.Display.V1.FormattedValue"] : "";
                    var contactid = connection.Contact != undefined ? connection.Contact : "";
                    //var contactcountry = connection.attributes.ccrm_countryid != undefined ? connection.attributes.ccrm_countryid.name : "";
                    var contactphone = connection.contactphone != undefined ? connection.contactphone : "";
                    var contactDepartment = connection.contactdepartment != undefined ? connection.contactdepartment : "";
                    var contactEmail = connection.contactemail != undefined ? connection.contactemail : "";
                    var jobTitle = connection['co.jobtitle'] != undefined ? connection['co.jobtitle'] : "";
                    var userName = connection.CRM_User != undefined ? connection["CRM_User@OData.Community.Display.V1.FormattedValue"] : "";
                    var userid = connection.CRM_User != undefined ? connection.CRM_User : "";
                    var contactimage = connection.contactimage != undefined ? connection.contactimage : "";
                    var userimage = connection.userimage != undefined ? connection.userimage : "";
                    var employmentstatus = connection.employmentstatus != undefined ? connection.employmentstatus : "";
                    var userPhone = connection.userphone != undefined != undefined ? connection.userphone : "";
                    var usercountry = connection.usercountry != undefined ? connection.usercountry : "";
                    var accountRole = connection['co.accountrolecode'] != undefined ? connection['co.accountrolecode'] : "";
                    var listid = connection.memberlistid != undefined ? connection.memberlistid : "";
                    var listName = connection.memberlistname != undefined ? connection.memberlistname : "";
                    var mlcreatedon = connection.mlcreatedon != undefined ? new Date(connection.mlcreatedon).getFullYear() : "";
                    var mlOwner = connection.mlownerid != undefined ? connection["mlownerid@OData.Community.Display.V1.FormattedValue"] : "";
                    var MlOffice = connection.mlarupoffice != undefined ? connection["mlarupoffice@OData.Community.Display.V1.FormattedValue"] : "";
                    var activityid = connection.activityid != undefined ? connection.activityid : "";
                    var activitysubject = connection.activitysubject != undefined ? connection.activitysubject : "";
                    var activityowner = connection.activityowner != undefined ? connection["activityowner@OData.Community.Display.V1.FormattedValue"] : "";
                    var activityduedate = connection.activityduedate != undefined ? connection.activityduedate : "";
                    var activitypriority = connection.activitypriority != undefined ? connection["activitypriority@OData.Community.Display.V1.FormattedValue"] : "";
                    var activitystatus = connection.activitystatecode != undefined ? connection["activitystatecode@OData.Community.Display.V1.FormattedValue"] : "";
                    var actvititytypecode = connection.activitytypecode != undefined ? connection["activitytypecode@OData.Community.Display.V1.FormattedValue"] : "";
                    var conn = {
                        "Contact": contact, "ContactId": contactid, "JobTitle": jobTitle, "ContactPhone": contactphone, "contactDepartment": contactDepartment,
                        "contactEmail": contactEmail,"CRMUser": userName, "CRM UserId": userid, "ContactImage": contactimage,
                        "UserImage": userimage, "EmpStatus": employmentstatus, "EmpPhone": userPhone,
                        "EmpCountry": usercountry, "userid": userid, "AccountRole": accountRole,
                        "MemberListId": listid, "MemberListName": listName
                        , "MLCreatedon": mlcreatedon, "MLOwner": mlOwner, "MLOffice": MlOffice
                        , "ActivityId": activityid, "ActivitySubject": activitysubject, "ActivityDueDate": activityduedate,
                        "ActivityOwner": activityowner, "ActivityPriority": activitypriority, "ActivityStatus": activitystatus,
                        "ActivityTypeCode": actvititytypecode
                    };
                    connectionLst.push(conn);
                }
                ConnectionContactData = "";
                $('#chkMarketingList').prop('checked', true);
                $('#chkContactActivities').prop('checked', false);
                DrawMatrixForceLayoutContacts("#connectionMatrix", connectionLst, true, false);
            }
        }

        var ChildOrgids = [];
        function getChildOrganisations(organisationid) {

            var fetchxml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>" +
                              "<entity name='account'>" +
                                "<attribute name='accountid' />" +
                                 "<filter type='and'>" +
                                  "<condition attribute='parentaccountid' operator='eq' value='" + organisationid + "' />" +
                                "</filter>" +
                              "</entity>" +
                            "</fetch>"
            var Orgaccounts = XrmServiceToolkit.Soap.Fetch(fetchxml);

            if (Orgaccounts.length > 0) {
                for (var i = 0; i < Orgaccounts.length; i++) {
                    var accountid = Orgaccounts[i].attributes.accountid != undefined ? Orgaccounts[i].attributes.accountid.value : "";
                    if (accountid != "") {
                        ChildOrgids.push(accountid);
                        getChildOrganisations(accountid);
                    }
                }

            }
        }

        function PopulateConnectionForuser(clickuserid, HasOrg) {

            if (HasOrg == undefined)
                HasOrg = true;

            ConnectionContactData = "";
            $("#Connectionfilters").hide();
            $("#Accountfilters").hide();
            $("#Userfilters").show();

            InititializeGraphDivs();
            InitializeHomeButtonClick();

            var hasOrgCondition = "";
            if (HasOrg)
                hasOrgCondition = encodeURIComponent("<condition attribute='accountid' operator='eq' value='" + accId + "' />");
            else {
                // find all child organisations
                if (ChildOrgids.length == 0) {
                    ChildOrgids = [];
                    ChildOrgids.push(accId);
                    getChildOrganisations(accId);
                }
                // form filter condition for below fetchxml
                hasOrgCondition =   "<condition attribute='accountid' operator='in'>" ;
                for(var i=0; i < ChildOrgids.length; i++)
                {
                    hasOrgCondition = hasOrgCondition + "<value>" + ChildOrgids[i] + "</value>";
                }
                hasOrgCondition = encodeURIComponent(hasOrgCondition + " </condition>");
            }
            var connections;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v9.1/connections?fetchXml=%3Cfetch%20distinct%3D'true'%20%3E%3Centity%20name%3D'connection'%20%3E%3Cattribute%20name%3D'record1id'%20alias%3D'Contact'%20%2F%3E%3Cattribute%20name%3D'record2id'%20alias%3D'CRM_User'%20%2F%3E%3Corder%20attribute%3D'record1id'%20descending%3D'false'%20%2F%3E%3Cfilter%3E%3Ccondition%20attribute%3D'statuscodename'%20operator%3D'eq'%20value%3D'Active'%20%2F%3E%3Ccondition%20attribute%3D'record1objecttypecode'%20operator%3D'eq'%20value%3D'2'%20%2F%3E%3Ccondition%20attribute%3D'record2objecttypecode'%20operator%3D'eq'%20value%3D'8'%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'contact'%20from%3D'contactid'%20to%3D'record1id'%20link-type%3D'inner'%20alias%3D'co'%20%3E%3Cattribute%20name%3D'accountrolecode'%20%2F%3E%3Cattribute%20name%3D'jobtitle'%20%2F%3E%3Cattribute%20name%3D'department'%20alias%20%3D%20'contactdepartment'%20%20%2F%3E%3Cattribute%20name%3D'emailaddress1'%20alias%20%3D'contactemail'%2F%3E%3Cattribute%20name%3D'telephone1'%20alias%20%3D%20'contactphone'%20%2F%3E%3Cattribute%20name%3D'ccrm_countryid'%20%2F%3E%3Cattribute%20name%3D'accountrolecodename'%20%2F%3E%3Cattribute%20name%3D'contactid'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20alias%3D'contactimage'%20%2F%3E%3Cfilter%20type%3D'and'%20%3E%3Ccondition%20attribute%3D'statuscodename'%20operator%3D'eq'%20value%3D'Active'%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'parentcustomerid'%20link-type%3D'inner'%20alias%3D'ac'%20%3E%3Cattribute%20name%3D'accountid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'address1_city'%20alias%20%3D%20'orgtowncity'%20%2F%3E%3Cattribute%20name%3D'ccrm_address1attentiondepartment'%20alias%20%3D%20'orgdepartment'%20%2F%3E%3Cattribute%20name%3D'arup_openopportunitiescalc'%20alias%20%3D%20'orgopenopptys'%20%2F%3E%3Cfilter%20type%3D'and'%20%3E'" + hasOrgCondition +"'%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D'systemuser'%20from%3D'systemuserid'%20to%3D'record2id'%20%3E%3Cattribute%20name%3D'arup_employmentstatus'%20alias%3D'employmentstatus'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20alias%3D'userimage'%20%2F%3E%3Cattribute%20name%3D'title'%20alias%20%3D%20'usertitle'%20%2F%3E%3Cattribute%20name%3D'systemuserid'%20%2F%3E%3Cattribute%20name%3D'entityimage_url'%20%2F%3E%3Cattribute%20name%3D'address1_country'%20alias%20%3D%20'usercountry'%20%2F%3E%3Cattribute%20name%3D'mobilephone'%20%2F%3E%3Cattribute%20name%3D'address1_telephone1'%20alias%20%3D%20'userphone'%20%2F%3E%3Clink-entity%20name%3D'ccrm_arupaccountingcode'%20from%3D'ccrm_arupaccountingcodeid'%20to%3D'ccrm_accountingcentreid'%20link-type%3D'outer'%20alias%3D'User_ACC'%20%3E%3Cattribute%20name%3D'ccrm_arupcompanycode'%20alias%3D'usercompanycode'%2F%3E%3Cattribute%20name%3D'ccrm_arupaccountingcode'%20alias%20%3D'useraccountingcode'%20%2F%3E%3Cattribute%20name%3D'ccrm_name'%20%2F%3E%3C%2Flink-entity%3E%3Clink-entity%20name%3D'ccrm_arupregion'%20from%3D'ccrm_arupregionid'%20to%3D'ccrm_arupregionid'%20link-type%3D'outer'%20alias%3D'User_AR'%20%3E%3Cattribute%20name%3D'ccrm_name'%20alias%20%3D%20'userregion'%20%2F%3E%3C%2Flink-entity%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'systemuserid'%20operator%3D'eq'%20value%3D'" + clickuserid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    connections = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                }
            });
            var fetchXML = "<fetch distinct='true' >" +
                               "<entity name='connection' >" +
                                 "<attribute name='record1id' alias='Contact' />" +
                                 "<attribute name='record2id' alias='CRM_User' />" +
                                 "<order attribute='record1id' descending='false' />" +
                                 "<filter>" +
                                   "<condition attribute='statuscodename' operator='eq' value='Active' />" +
                                   "<condition attribute='record1objecttypecode' operator='eq' value='2' />" +
                                   "<condition attribute='record2objecttypecode' operator='eq' value='8' />" +
                                 "</filter>" +
                                 "<link-entity name='contact' from='contactid' to='record1id' link-type='inner' alias='co' >" +
                                   "<attribute name='accountrolecode' />" +
                                   "<attribute name='jobtitle' />" +
                                    "<attribute name='department' alias = 'contactdepartment'  />" +
                                   "<attribute name='emailaddress1' alias ='contactemail'/>" +
                                     "<attribute name='telephone1' alias = 'contactphone' />" +
                                      "<attribute name='ccrm_countryid' />" +
                                   "<attribute name='accountrolecodename' />" +
                                   "<attribute name='contactid' />" +
                                   "<attribute name='entityimage_url' alias='contactimage' />" +
                                   "<filter type='and' >" +
                                     "<condition attribute='statuscodename' operator='eq' value='Active' />" +
                                   "</filter>" +
                                   "<link-entity name='account' from='accountid' to='parentcustomerid' link-type='inner' alias='ac' >" +
                                     "<attribute name='accountid' />" +
                                     "<attribute name='name' />" +
                                     "<attribute name='address1_city' alias = 'orgtowncity' />" +
                                      "<attribute name='ccrm_address1attentiondepartment' alias = 'orgdepartment' />" +
                                      "<attribute name='arup_openopportunitiescalc' alias = 'orgopenopptys' />" +
                                     "<filter type='and' >" +
                                       hasOrgCondition +
                                     "</filter>" +
                                   "</link-entity>" +
                                 "</link-entity>" +
                                 "<link-entity name='systemuser' from='systemuserid' to='record2id' >" +
                                   "<attribute name='arup_employmentstatus' alias='employmentstatus' />" +
                                   "<attribute name='entityimage_url' alias='userimage' />" +
                                    "<attribute name='title' alias = 'usertitle' />" +
                                     "<attribute name='systemuserid' />" +
                                   "<attribute name='entityimage_url' />" +
                                   "<attribute name='address1_country' alias = 'usercountry' />" +
                                   "<attribute name='mobilephone' />" +
                                   "<attribute name='address1_telephone1' alias = 'userphone' />" +
                                   "<link-entity name='ccrm_arupaccountingcode' from='ccrm_arupaccountingcodeid' to='ccrm_accountingcentreid' link-type='outer' alias='User_ACC' >" +
                                    "<attribute name='ccrm_arupcompanycode' alias='usercompanycode'/>" +
                                     "<attribute name='ccrm_arupaccountingcode' alias ='useraccountingcode' /> " +
                                     "<attribute name='ccrm_name' />" +
                                   "</link-entity>" +
                                   "<link-entity name='ccrm_arupregion' from='ccrm_arupregionid' to='ccrm_arupregionid' link-type='outer' alias='User_AR' >" +
                                    "<attribute name='ccrm_name' alias = 'userregion' />" +
                                   "</link-entity>" +
                                    "<filter type='and'>" +
                                      "<condition attribute='systemuserid' operator='eq' value='" + clickuserid + "' />" +
                                    "</filter>" +
                                 "</link-entity>" +
                               "</entity>" +
                "</fetch>";
            var contacts;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: Xrm.Page.context.getClientUrl() + "/api/data/v9.1/contacts?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'true'%3E%3Centity%20name%3D'contact'%3E%3Cattribute%20name%3D'fullname'%20%2F%3E%3Cattribute%20name%3D'parentcustomerid'%20%2F%3E%3Cattribute%20name%3D'emailaddress1'%20%2F%3E%3Cattribute%20name%3D'jobtitle'%20%2F%3E%3Cattribute%20name%3D'ccrm_countryid'%20%2F%3E%3Cattribute%20name%3D'address1_city'%20%2F%3E%3Cattribute%20name%3D'address1_line1'%20%2F%3E%3Cattribute%20name%3D'address1_postalcode'%20%2F%3E%3Cattribute%20name%3D'contactid'%20%2F%3E%3Corder%20attribute%3D'fullname'%20descending%3D'false'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'parentcustomerid'%20alias%3D'aj'%20link-type%3D'inner'%3E%3Cattribute%20name%3D'accountid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3C%2Flink-entity%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'0'%20%2F%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq'%20uitype%3D'account'%20value%3D'" + accId + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    contacts = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                }
            });
            var fetchXMLCon = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='true'>" +
                                   "<entity name='contact'>" +
                                       "<attribute name='fullname' />" +
                                       "<attribute name='parentcustomerid' />" +
                                       "<attribute name='emailaddress1' />" +
                                       "<attribute name='jobtitle' />" +
                                       "<attribute name='ccrm_countryid' />" +
                                       "<attribute name='address1_city' />" +
                                       "<attribute name='address1_line1' />" +
                                       "<attribute name='address1_postalcode' />" +
                                       "<attribute name='contactid' />" +
                                       "<order attribute='fullname' descending='false' />" +
                                       "<link-entity name='account' from='accountid' to='parentcustomerid' alias='aj' link-type='inner'>" +
                                           "<attribute name='accountid' />" +
                                           "<attribute name='name' />" +
                                       "</link-entity>" +
                                       "<filter type='and'>" +
                                           "<condition attribute='statecode' operator='eq' value='0' />" +
                                       //"<condition attribute='parentcustomerid' operator='eq' value='{051A6371-B843-E211-BDB4-78E7D1652028}' />" +
                                           "<condition entityname= 'aj' attribute='accountid' operator='eq' uitype='account' value='" + accId + "' />" +
                                       "</filter>" +
                                   "</entity>" +
                               "</fetch>";
            //debugger;
           // var connections = XrmServiceToolkit.Soap.Fetch(fetchXML);
            //var contacts = XrmServiceToolkit.Soap.Fetch(fetchXMLCon);
            var connectionLst = [];
            var connectionLstTbl = [];
            var contactLst = [];

            if (connections.length > 0) {
                for (var i = 0; i < connections.length; i++) {
                    //debugger;
                    var connection = connections[i];
                    var orgTownCity = connection.orgtowncity != undefined ? connection.orgtowncity : "";
                    var orgDepartment = connection.orgdepartment != undefined ? connection.orgdepartment : "";
                    var orgOpenOpptys = connection.orgopenopptys != undefined ? connection.orgopenopptys : "";

                    var contact = connection.Contact != undefined ? connection["Contact@OData.Community.Display.V1.FormattedValue"] : "";
                    var contactid = connection.Contact != undefined ? connection.Contact : "";

                    var contactDepartment = connection.contactdepartment != undefined ? connection.contactdepartment : "";
                    var contactEmail = connection.contactemail != undefined ? connection.contactemail : "";

                    //var contactcountry = connection.attributes.ccrm_countryid != undefined ? connection.attributes.ccrm_countryid.name : "";
                    var contactphone = connection.contactphone != undefined ? connection.contactphone : "";
                    var jobTitle = connection['co.jobtitle'] != undefined ? connection['co.jobtitle'] : "";
                    var userName = connection.CRM_User != undefined ? connection["CRM_User@OData.Community.Display.V1.FormattedValue"] : "";
                    var userid = connection.CRM_User != undefined ? connection.CRM_User : "";
                    var contactimage = connection.contactimage != undefined ? connection.contactimage : "";
                    var userimage = connection.userimage != undefined ? connection.userimage : "";
                    var employmentstatus = connection.employmentstatus != undefined ? connection.employmentstatus : "";
                    var userPhone = connection.userphone != undefined ? connection.userphone : "";
                    var usercountry = connection.usercountry != undefined ? connection.usercountry : "";
                    var accountRole = connection['co.accountrolecode'] != undefined ? connection['co.accountrolecode'] : "";

                    var userCompanyCode = connection.usercompanycode != undefined ? connection.usercompanycode : "";
                    var userAccountingCode = connection.useraccountingcode != undefined ? connection.useraccountingcode : "";
                    var userRegion = connection.userregion != undefined ? connection.userregion : "";
                    var userTitle = connection.usertitle != undefined ? connection.usertitle : "";
                    var organisationid = connection['ac.accountid'] != undefined ? connection['ac.accountid'] : "";
                    var organisationame = connection['ac.name'] != undefined ? connection['ac.name'] : "";
                    var conn = {
                        "Contact": contact, "ContactId": contactid, "JobTitle": jobTitle, "ContactPhone": contactphone,
                        "CRMUser": userName, "CRM UserId": userid, "ContactImage": contactimage,
                        "UserImage": userimage, "EmpStatus": employmentstatus, "EmpPhone": userPhone,
                        "EmpCountry": usercountry, "userid": userid, "AccountRole": accountRole,
                        "orgTownCity": orgTownCity, "orgDepartment": orgDepartment, "contactDepartment": contactDepartment,
                        "contactEmail": contactEmail, "userCompanyCode": userCompanyCode, "userAccountingCode": userAccountingCode,
                        "userRegion": userRegion, "orgOpenOpptys": orgOpenOpptys, "userTitle": userTitle,
                        "OrganisationName" : organisationame, "OrganisationId" : organisationid
                    };
                    if (userid == clickuserid) {
                        connectionLst.push(conn);
                    }
                    var conntable = {
                        "Contact": contact, "Job Title": jobTitle, "CRM User": userName
                    };

                    connectionLstTbl.push(conntable);

                }

                //  DrawMatrixTable("#connectionMatrixtable", connectionLstTbl);
                if (HasOrg == "") {
                    DrawMatrixForceLayoutForAllUsers("#connectionMatrix", connectionLst, true);
                }
                else {
                    DrawMatrixForceLayout("#connectionMatrix", connectionLst, true);
                }
            }

            if (contacts.length > 0) {
                for (var j = 0; j < contacts.length; j++) {
                    var contact = contacts[j];
                    var contFound = contExists(contact.contactid);

                    if (!contFound) {
                        var fullName = contact.fullname != undefined ? contact.fullname : "";
                        //var orgId = connection.attributes['co.jobtitle'] != undefined ? connection.attributes['co.jobtitle'].value : "";
                        var jobTitle = contact.jobtitle != undefined ? contact.jobtitle : "";
                        var email = contact.emailaddress1 != undefined ? contact.emailaddress1 : "";

                        var contarray = {
                            "Full Name": fullName, "Job Title": jobTitle, "Email": email
                        };

                        contactLst.push(contarray);
                    }

                    function contExists(contid) {
                        return connectionLst.some(function (el) {
                            return el.ContactId === contid;
                        });
                    }
                }


            }
        }

        function DrawMatrixForceLayoutForAllUsers(div, conData, isUserClick) {

            if (isUserClick == undefined)
                isUserClick = false;

            var nodelink = Object();
            nodelink.nodes = [];
            nodelink.links = [];


            var arupContact = d3.nest()
                            .key(function (d) { return d['CRM UserId']; })
                            .entries(conData);

            var arupOrganisation = d3.nest()
                            .key(function (d) { return d['OrganisationId']; })
                            .entries(conData);
            var clientContact = d3.nest()
                            .key(function (d) { return d['ContactId']; })
                            .entries(conData);

            arupOrganisation.forEach(function (ac, i) {
                nodelink.nodes.push({
                    id: ac.key, group: 1, rad: 7, imageUrl: '../../arup_graphOrg', empstatus: ac.values[0].EmpStatus, name: ac.values[0].OrganisationName
                    , phone: ac.values[0].EmpPhone, jobtitleorCountry: ac.values[0].EmpCountry, userid: "1000",
                    orgTownCity: ac.values[0].orgTownCity, orgDepartment: ac.values[0].orgDepartment, contactDepartment: ac.values[0].contactDepartment,
                    contactEmail: ac.values[0].contactEmail, userCompanyCode: ac.values[0].userCompanyCode, userAccountingCode: ac.values[0].userAccountingCode,
                    userRegion: ac.values[0].userRegion, orgOpenOpptys: ac.values[0].orgOpenOpptys, userTitle: ac.values[0].userTitle
                });
            })

            arupContact.forEach(function (ac, i) {
                nodelink.nodes.push({
                    id: ac.key, group: 1, rad: 8, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].UserImage, empstatus: ac.values[0].EmpStatus, name: ac.values[0].CRMUser
                    , phone: ac.values[0].EmpPhone, jobtitleorCountry: ac.values[0].EmpCountry, userid: ac.values[0].userid,
                    orgTownCity: ac.values[0].orgTownCity, orgDepartment: ac.values[0].orgDepartment, contactDepartment: ac.values[0].contactDepartment,
                    contactEmail: ac.values[0].contactEmail, userCompanyCode: ac.values[0].userCompanyCode, userAccountingCode: ac.values[0].userAccountingCode,
                    userRegion: ac.values[0].userRegion, orgOpenOpptys: ac.values[0].orgOpenOpptys, userTitle: ac.values[0].userTitle
                });
            })

            conData.forEach(function (cc, i) {
                nodelink.links.push({ source: cc['CRM UserId'], target: cc['OrganisationId'], value: 2 });
            })


            var contactsids = [];
            clientContact.forEach(function (ac, i) {
                //var contactpro = conData.filter(function (currentValue, index, arr) { if (currentValue['Contact'] == ac.key) return true; });
                var ContactRadius = 4;
                var ContactGroup = 3
                if (ac.values[0].AccountRole == "1")  // Decision Maker
                {
                    ContactRadius = 10;
                    ContactGroup = 6;
                }
                else if (ac.values[0].AccountRole == "3") // Influencer
                {
                    ContactRadius = 10;
                    ContactGroup = 6;
                }
                nodelink.nodes.push({
                    id: ac.key, group: ContactGroup, rad: ContactRadius, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].ContactImage,
                    name: ac.values[0].Contact, phone: ac.values[0].ContactPhone, jobtitleorCountry: ac.values[0].JobTitle, userid: "200",
                    orgTownCity: ac.values[0].orgTownCity, orgDepartment: ac.values[0].orgDepartment, contactDepartment: ac.values[0].contactDepartment,
                    contactEmail: ac.values[0].contactEmail, userCompanyCode: ac.values[0].userCompanyCode, userAccountingCode: ac.values[0].userAccountingCode,
                    userRegion: ac.values[0].userRegion, orgOpenOpptys: ac.values[0].orgOpenOpptys, userTitle: ac.values[0].userTitle
                });
                //  contactsids.push(ac.values[0].ContactId);

            })

            conData.forEach(function (cc, i) {
                nodelink.links.push({ source: cc['OrganisationId'], target: cc['ContactId'], value: 1 });
            })


            var svgwidth = $("#connForcelay").width()

            var svg = d3.select("#connForcelay"),
        width = +svgwidth,
        height = +svg.attr("height");

            var zoom = d3.zoom().scaleExtent([1 / 2, 4]).on("zoom", zoomed);

            svg.call(zoom);


            svg.append("rect")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all");

            var g = svg.append("g");


            //////////////////////////
            var config = {
                "avatar_size": 10
            }

            var body = d3.select("body");
            var defs = svg.append('svg:defs');
            data = [{
                posx: 30,
                posy: 20,
                posx1: 25,
                posy1: 15,
                img: "../../arup_/Images/Contact.png",
                color: "#28AF73",
                "label": "Relationship Manager",
                width: 10
            }, {
                posx: 170,
                posy: 20,
                posx1: 165,
                posy1: 15,
                img: "../../arup_/Images/Contact.png",
                color: "#A0235F",
                "label": "Relationship Team",
                width: 10
            }, {
                posx: 310,
                posy: 20,
                posx1: 305,
                posy1: 15,
                img: "../../arup_/Images/Contact.png",
                color: "#666666",
                "label": "Arup Non-Employee",
                width: 10
            },
             {
                 posx: 450,
                 posy: 20,
                 posx1: 445,
                 posy1: 15,
                 img: "../../arup_/Images/Contact.png",
                 color: "#1982AF",
                 "label": "Arup Contacts",
                 width: 10
             },
              {
                  posx: 590,
                  posy: 20,
                  posx1: 585,
                  posy1: 15,
                  img: "../../arup_/Images/Contact.png",
                  color: "#32325F",
                  "label": "Arup Users",
                  width: 10
              },
               {
                   posx: 730,
                   posy: 20,
                   posx1: 718,
                   posy1: 10,
                   img: "../../arup_graphOrg",
                   color: "#875005",
                   "label": "Organisations",
                   width: 20
               }

            ];

            data.forEach(function (d, i) {
                svg.append("circle")
                .attr('cx', d.posx)
                          .attr('cy', d.posy)
                         .attr('r', config.avatar_size)
                         .style("stroke-width", 1)
                          .attr("fill", d.color)
                     .style("stroke", d.color)

                svg.append('clipPath')
                   .attr('id', 'clipObj' + i)
                        .append('circle')
                         .attr('cx', d.posx)
                          .attr('cy', d.posy)
                         .attr('r', config.avatar_size)

            })

            data.forEach(function (d, i) {
                var xaxis, yaxis, width
                if (d.label == "Organisations") {
                    width = config.avatar_size * 3;
                    xaxis = parseInt(d.posx - (config.avatar_size + config.avatar_size * .5));
                    yaxis = parseInt(d.posy - (config.avatar_size + config.avatar_size * .5));
                }
                else {
                    width = config.avatar_size + config.avatar_size * .1;
                    xaxis = parseInt(d.posx - config.avatar_size + config.avatar_size * .45);
                    yaxis = parseInt(d.posy - config.avatar_size + config.avatar_size * .45)
                }
                svg.append('image')
                   .attr('xlink:href', d.img)
                   .attr('width', width)
                   .attr('height', width)
                    .attr('x', xaxis)
                      .attr('y', yaxis)
                  // .attr('transform', 'translate(' + parseInt(d.posx1) + ',' + parseInt(d.posy1) + ')')
                   // .attr('transform', 'translate(' + parseInt(d.posx - config.avatar_size + config.avatar_size * .45) + ',' + parseInt(d.posy - config.avatar_size + config.avatar_size * .45) + ')')
                   .attr('clip-path', "url(#clipObj" + i + ")")

            })
            var text = svg.selectAll("text")
                 .data(data)
                 .enter()
                 .append("text");


            var textLabels = text
            .attr("x", function (d) { return d.posx + 15; })
            .attr("y", function (d) { return d.posy + 5; })
            .text(function (d) { return d.label; });


            ////////////////////////////



            function zoomed() {
                g.attr('transform', 'translate(' + d3.event.transform.x + ',' + d3.event.transform.y + ') scale(' + d3.event.transform.k + ')');
                currentscale = d3.event.transform.k;
            };

            if (currentscale != "") {
                svg.transition()
                      .delay(100)
                      .duration(700)
                      .call(zoom.scaleTo, currentscale);

            }

            function transition(zoomLevel) {
                svg.transition()
                    .delay(100)
                    .duration(700)
                    .call(zoom.scaleBy, zoomLevel);
                //.call(zoom.transform, transform);
                //.on("end", function() { canvas.call(transition); });
            }

            d3.selectAll('button').on('click', function () {
                if (this.id === 'zoom_in') {
                    transition(1.2); // increase on 0.2 each time
                }
                if (this.id === 'zoom_out') {
                    transition(0.8); // deacrease on 0.2 each time
                }
                if (this.id === 'zoom_init') {
                    svg.transition()
                        .delay(100)
                        .duration(700)
                        .call(zoom.scaleTo, 1.5); // return to initial state
                }
                if (this.id === 'btnresize') {
                    if (sizetoggle == 0) {
                        $(div).css("height", "90%");
                        $(div).css("width", "100%");
                        $('#connForcelay').css("height", "1100px");
                        //$('#maindivGraph').removeClass('col-md-9 ml-sm-auto col-lg-10').addClass('col-md-9 ml-sm-auto col-lg-12');
                        //$('#seconddivgraph').hide();
                        $('#clientconnectionHelp').hide();
                        $('#showhideNav').hide();
                        $('#seconddivgraph').css({ 'margin-top': '0px' });

                        sizetoggle = 1;
                    }
                    else {
                        $(div).css("height", "70%");
                        $(div).css("width", "100%");

                        $('#connForcelay').css("height", "800px");
                        //$('#maindivGraph').removeClass('col-md-9 ml-sm-auto col-lg-12').addClass('col-md-9 ml-sm-auto col-lg-10');
                        //$('#seconddivgraph').show();
                        $('#clientconnectionHelp').show();
                        $('#showhideNav').show();
                        $('#seconddivgraph').css({ 'margin-top': '65px' });
                        sizetoggle = 0;
                    }
                }
            });

            var color = d3.scaleOrdinal(d3.schemeCategory20);


            var simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(function (d) { return d.id; }).distance(function (d, i) { return 30 + i }))
                .force("charge", d3.forceManyBody().strength(-100))
                .force("center", d3.forceCenter(width / 2, height / 2));


            var link = g.append("g")
                .attr("class", "links")
              .selectAll("line")
              .data(nodelink.links)
              .enter().append("line")
                .style("stroke-dasharray", (0, function (d) {
                    if (d.value == 1) {
                        return 3;
                    }
                    else { return 0; }
                }))
                .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

            var node = g.append("g")
               .attr("class", "nodes")
             .selectAll("circle")
             .data(nodelink.nodes)
             .enter().append("g")
             .on('dblclick', releasenode)
             .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            var circle = node.append("circle")
                .attr("r", function (d) { return d.rad; })
                .attr("fill", function (d) { return GetNodeBackGrdClr(d, color) })
                .style("stroke", function (d) { return GetNodeBackGrdClr(d, color) })
                .style("stroke-width", function (d) { return GetNodeBackGrdStrokeWidth(d) })
             .on("click", function (d) {
                 tooltip.style("visibility", "hidden");
                 getDataforUser(d.userid, d.id)
             })
             .on("mouseover", function (d) {
                 connectedNodes(d);
                 var tooltipcontent = getToolTipsForConnection(d);
                 tooltip.html(tooltipcontent);
                 return tooltip.style("visibility", "visible");
                 // tooltip.html(d.name + "<br/>" + d.jobtitleorCountry + "<br/>" + d.phone); return tooltip.style("visibility", "visible");

             })
          .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
          .on("mouseout", function (d) { removehighlighting(d); return tooltip.style("visibility", "hidden"); });

            // add circle clip
            var clipPath = node.append("clipPath")
                                        .attr("id", function (d, i) {
                                            return "clipCircle_" + i
                                        })
                                        .append("circle")
                                        .attr("r", function (d) { return d.rad });


            var tooltip = d3.select("body")
           .append("div")
           .style("position", "absolute")
           .style("z-index", "12")
           .style("visibility", "hidden")
           .style("background", "#5C9BD1")
           .style("color", "white")
           .style("padding", "5px")
           .style("margin", "2px")
           .style("font-size", "12px")
           .style("box-shadow", "0px 5px 15px 0px rgba(0,0,0,0.3)")
           .text("a simple tooltip");

            var image = node.append('svg:image').attr('class', 'entityImage').attr('xlink:href', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.imageUrl;
                }
                else {
                    return '../../arup_/Images/Contact.png';
                }
            })
            .attr('width', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.rad * 3;
                }
                else {
                    return d.rad + d.rad * .1;
                }
            })
            .attr('height', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.rad * 3;
                }
                else {
                    return d.rad + d.rad * .1;
                }
            })
            .attr("clip-path", function (d, i) { return "url(#clipCircle_" + i + ")" })
             .on("click", function (d) {
                 tooltip.style("visibility", "hidden");
                 getDataforUser(d.userid, d.id)
             })
             .on("mouseover", function (d) {
                 connectedNodes(d);
                 var tooltipcontent = getToolTipsForConnection(d);
                 tooltip.html(tooltipcontent); return tooltip.style("visibility", "visible");

                 //  tooltip.html(d.name + "<br/>" + d.jobtitleorCountry + "<br/>" + d.phone); return tooltip.style("visibility", "visible");
             })
          .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
          .on("mouseout", function (d) { removehighlighting(d); return tooltip.style("visibility", "hidden"); });

            var nodeText = node.append('svg:text').attr('class', 'nodetext').text(function (d) {
                var name = d.name != undefined ? d.name.normalize('NFD').replace(/[\u0300-\u036f]/g, "") : "";

                if (name.length > 20) {
                    name = name.substring(0, 20) + "...";
                }
                if (isManagedClient) {
                    if (d.id == relationshipManager) {
                        return name + " (RM)";
                    }
                    else if (relTeamMembers.indexOf(d.id) > -1) {
                        return name + " (RT)";
                    }
                    else {
                        return name;
                    }
                }
                return name;
            }).style("text-anchor", "middle");


            //var title = node.append("title")
            //     .text(function (d) { return d.id; });

            simulation
                .nodes(nodelink.nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(nodelink.links);

            function ticked() {
                link
                    .attr("x1", function (d) { return d.source.x; })
                    .attr("y1", function (d) { return d.source.y; })
                    .attr("x2", function (d) { return d.target.x; })
                    .attr("y2", function (d) { return d.target.y; });

                circle
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });

                clipPath
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });

                image
                    .attr("x", function (d) {
                        if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                            return d.x - d.rad - d.rad * .5;
                        }
                        else {
                            return d.x - d.rad + d.rad * .45;
                        }
                    })
                    .attr("y", function (d) {
                        if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                            return d.y - d.rad - d.rad * .5;
                        }
                        else {
                            return d.y - d.rad + d.rad * .45;
                        }

                    });


                nodeText
                    .attr("dx", function (d) { return d.x - function (d) { return d.name.normalize('NFD').replace(/[\u0300-\u036f]/g, "") }.length / 2 * 3; })
                    .attr("dy", function (d) {
                        if (d.group == 1) {
                            return d.y - 11;
                        }
                        else if (d.group == 2) {
                            return d.y - 8;
                        }
                        else if (d.group == 6) {
                            return d.y - 11;
                        }
                        else {
                            return d.y - 5;
                        }
                    });


            }


            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                //d.fx = null;
                //d.fy = null;
                d.fx = d.x;
                d.fy = d.y;
            }

            function releasenode(d) {
                //d.fx = false; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
                //force.resume();
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            ////////////////////////////////////////////////////////////////////////////////

            function connectedNodes(d) {
                var connectedlinks = link.filter(function (e) {
                    //return e.source.id == d.id || e.target.id == d.id; //connected links
                    if (e.source.id == d.id || e.target.id == d.id) {
                        node.filter(function (k) {
                            return k.id != d.id;
                        }).style('stroke-opacity', 0.1);
                        return d.id;
                    }
                }).style('stroke', 'red')
                  .attr('r', 15);


                var disconnectedlinks =
                     link.filter(function (e) {
                         return e.source.id != d.id && e.target.id != d.id; //disconnected links
                     }).style('stroke-opacity', 0.1)
                  .attr('r', 15);
            }
            function removehighlighting(d) {
                var connectedlinks = link.filter(function (e) {
                    if (e.source.id == d.id || e.target.id == d.id) { //connected links
                        node.filter(function (k) {
                            return k.id != d.id;
                        }).style('stroke-opacity', 0.6);
                        return d.id;
                    }
                }).style('stroke', '#999')
                         .attr('r', 15)

                var disconnectedlinks =
                  link.filter(function (e) {
                      return e.source.id != d.id && e.target.id != d.id; //disconnected links
                  }).style('stroke-opacity', 0.6)
               .attr('r', 15);

            }
            /////////////////////////////////////////////////////



        }
        function GetNodeBackGrdStrokeWidth(d)
        {
            if (isManagedClient) {
                if (d.id == relationshipManager) {
                    return 2;
                }
                else if (relTeamMembers.indexOf(d.id) > -1) {
                    return 2;
                }
                else return 1;
            }
            else return 1;

        }
        function GetNodeBackGrdClr(d, color) {
            if (d.empstatus != undefined && d.empstatus != null && d.empstatus == '770000001') {
                return '#666666';
            }
            if (isManagedClient) {
                if (d.id == relationshipManager) {
                    return "#28AF73";
                }
                else if (relTeamMembers.indexOf(d.id) > -1) {
                    return "#A0235F";
                }
            }
            if (d.userid == "100")
            {
                return "#875005";
            }
            else if (d.userid == "200")
            {
                return "#1982AF";
            }
            else if (d.userid == "400") {
                return "#F05023";
            }
            else if (d.userid == "500") {
                return "#1D8657";
            }
            else if(d.userid == "600")
            {
                if (d.OpptyInternal == "Yes") {
                    return '#fcfda5';
                }
                else {
                    return "#FDD7A5";
                }
            }
            else if(d.userid == "700")
            {
                return "#46488C";
            }
            else {
                return "#32325F";
            }

            return color(d.group);
        }

        var ConnectionContactData = "";
        function DrawMatrixForceLayoutContacts(div, conData, ShowMarketingList, ShowActivities) {

            ConnectionContactData = conData;
            var nodelink = Object();
            nodelink.nodes = [];
            nodelink.links = [];
           // nodelink.nodes.push({ id: accName, name: accName, group: 1, rad: 10, imageUrl: '../../arup_/Images/AccountFolder.png', phone: "", jobtitleorCountry: "", userid: "100",createdon : "" });

            //var arupContact = d3.nest()
            //                .key(function (d) { return d['CRM UserId']; })
            //                .entries(conData);
            var clientContact = d3.nest()
                            .key(function (d) { return d['ContactId']; })
                            .entries(conData);

            var marketingcontact = d3.nest()
             .key(function (d) { return d['MemberListId']; })
                            .entries(conData);

            var activities = d3.nest()
             .key(function (d) { return d['ActivityId']; })
                            .entries(conData);

            var contactsids = [];
            clientContact.forEach(function (ac, i) {
                //var contactpro = conData.filter(function (currentValue, index, arr) { if (currentValue['Contact'] == ac.key) return true; });
                var ContactRadius = 5;
                var ContactGroup = 3
                if (ac.values[0].AccountRole == "1")  // Decision Maker
                {
                    ContactRadius = 10;
                    ContactGroup = 6;
                }
                else if (ac.values[0].AccountRole == "3") // Influencer
                {
                    ContactRadius = 10;
                    ContactGroup = 6;
                }
                nodelink.nodes.push({
                    id: ac.key, group: ContactGroup, rad: ContactRadius, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].ContactImage,
                    name: ac.values[0].Contact, phone: ac.values[0].ContactPhone, jobtitleorCountry: ac.values[0].JobTitle, userid: "200", createdon: ""
                    , ContactDepartment: ac.values[0].contactDepartment, ContactEmail: ac.values[0].contactEmail, MLOffice: "", MLOwner: "",MLCampaign: ""

                });
                //  contactsids.push(ac.values[0].ContactId);

            })

            //conData.forEach(function (cc, i) {
            //    nodelink.links.push({ source: accName, target: cc['ContactId'], value: 2 });
            //})
            var hasMarketinglist = false;
            if (ShowMarketingList) {
                marketingcontact.forEach(function (ac, i) {
                    if (ac.key != "") {
                        hasMarketinglist = true;
                        var ContactRadius = 5;
                        var ContactGroup = 5

                        nodelink.nodes.push({
                            id: ac.key, group: ContactGroup, rad: ContactRadius, imageUrl: "../../arup_graphMarketingLists",
                            name: ac.values[0].MemberListName, phone: "", jobtitleorCountry: "", userid: "400", createdon: ac.values[0].MLCreatedon
                            , ContactDepartment: "", ContactEmail: "", MLOffice: ac.values[0].MLOffice, MLOwner: ac.values[0].MLOwner, MLCampaign: ""
                        });
                    }
                })
                if (hasMarketinglist) {
                    conData.forEach(function (cc, i) {
                        nodelink.links.push({ source: cc['ContactId'], target: cc['MemberListId'], value: 1 });
                    })
                }
                else
                {
                    $("#alert-marketing").fadeTo(2000, 500).slideUp(500, function () {
                        $("#alert-marketing").slideUp(500);
                    });

                }

            }


            var hasActivities = false;
            if (ShowActivities) {
                activities.forEach(function (ac, i) {
                    if (ac.key != "") {
                        hasActivities = true;
                        var ContactRadius = 5;
                        var ContactGroup = 7;

                        nodelink.nodes.push({
                            id: ac.key, group: ContactGroup, rad: ContactRadius, imageUrl: "../../arup_graphActivities",
                            name: ac.values[0].ActivitySubject, phone: "", jobtitleorCountry: "", userid: "500", createdon : "",
                            activityduedate:ac.values[0].ActivityDueDate,activityowner :ac.values[0].ActivityOwner,
                            activitypriority: ac.values[0].ActivityPriority, activitystatus: ac.values[0].ActivityStatus,
                            activitytype : ac.values[0].ActivityTypeCode

                        });
                    }
                })
                if (hasActivities) {
                    conData.forEach(function (cc, i) {
                        nodelink.links.push({ source: cc['ContactId'], target: cc['ActivityId'], value: 1 });
                    })
                }
                else
                {
                    $("#alert-activities").fadeTo(2000, 500).slideUp(500, function () {
                        $("#alert-activities").slideUp(500);
                    });
                }
            }
            var svgwidth = $("#connForcelay").width()
            var svg = d3.select("#connForcelay"),
                width = +svgwidth,
                height = +svg.attr("height");
            var zoom = d3.zoom().scaleExtent([1 / 2, 4]).on("zoom", zoomed);
            svg.call(zoom);
            var g = svg.append("g");


            //////////////////////////
            var config = {
                "avatar_size": 10
            }

            var body = d3.select("body");
            var defs = svg.append('svg:defs');
            data = [{
                posx: 30,
                posy: 20,
                posx1: 26,
                posy1: 10,
                img: "../../arup_/Images/Contact.png",
                color: "#1982AF",
                "label": "Arup Contacts",
                width: 8
            }, {
                posx: 170,
                posy: 20,
                posx1: 162,
                posy1: 6,
                img: "../../arup_graphMarketingLists",
                color: "#F05023",
                "label": "Marketing Lists",
                width: 16
            },
             {
                    posx: 310,
                    posy: 20,
                    posx1: 302,
                    posy1: 6,
                    img: "../../arup_graphphonecall",
                    color: "#1D8657",
                    "label": "Phone Calls",
                    width: 16
                },
                {
                    posx: 450,
                    posy: 20,
                    posx1: 442,
                    posy1: 6,
                    img: "../../arup_graphtask",
                    color: "#1D8657",
                    "label": "Tasks",
                    width: 16
                },
                {
                    posx: 590,
                    posy: 20,
                    posx1: 582,
                    posy1: 6,
                    img: "../../arup_graphappointment",
                    color: "#1D8657",
                    "label": "Appointments",
                    width: 16
                },
                 {
                     posx: 730,
                     posy: 20,
                     posx1: 722,
                     posy1: 6,
                     img: "../../arup_graphemail",
                     color: "#1D8657",
                     "label": "Emails",
                     width: 16
                 },
                 {
                     posx: 870,
                     posy: 20,
                     posx1: 862,
                     posy1: 6,
                     img: "../../arup_graphActivities",
                     color: "#1D8657",
                     "label": "Other Activities",
                     width: 20
                 }

            ];

            data.forEach(function (d, i) {
                svg.append("circle")
                .attr('cx', d.posx)
                          .attr('cy', d.posy)
                         .attr('r', config.avatar_size)
                         .style("stroke-width", 1)
                          .attr("fill", d.color)
                     .style("stroke", d.color)

                svg.append('clipPath')
                   .attr('id', 'clipObj' + i)
                        .append('circle')
                         .attr('cx', d.posx)
                          .attr('cy', d.posy)
                         .attr('r', config.avatar_size)

            })

            data.forEach(function (d, i) {
                var xaxis, yaxis, width
                if (d.label == "Marketing Lists" || d.label == "Phone Calls" || d.label == "Tasks" || d.label == "Appointments" || d.label == "Emails" || d.label == "Other Activities") {
                    width = config.avatar_size * 3;
                    xaxis = parseInt(d.posx - (config.avatar_size + config.avatar_size * .5));
                    yaxis = parseInt(d.posy - (config.avatar_size + config.avatar_size * .5));
                }
                else {
                    width = config.avatar_size + config.avatar_size * .1;
                    xaxis = parseInt(d.posx - config.avatar_size + config.avatar_size * .45);
                    yaxis = parseInt(d.posy - config.avatar_size + config.avatar_size * .45)
                }
                svg.append('image')
                   .attr('xlink:href', d.img)
                   .attr('width', width)
                   .attr('height', width)
                    .attr('x', xaxis)
                      .attr('y', yaxis)
                  // .attr('transform', 'translate(' + parseInt(d.posx1) + ',' + parseInt(d.posy1) + ')')
                   // .attr('transform', 'translate(' + parseInt(d.posx - config.avatar_size + config.avatar_size * .45) + ',' + parseInt(d.posy - config.avatar_size + config.avatar_size * .45) + ')')
                   .attr('clip-path', "url(#clipObj" + i + ")")

            })
            var text = svg.selectAll("text")
                 .data(data)
                 .enter()
                 .append("text");


            var textLabels = text
            .attr("x", function (d) { return d.posx + 15; })
            .attr("y", function (d) { return d.posy + 5; })
            .text(function (d) { return d.label; });


            ////////////////////////////

            function zoomed() {
                g.attr('transform', 'translate(' + d3.event.transform.x + ',' + d3.event.transform.y + ') scale(' + d3.event.transform.k + ')');
                currentscale = d3.event.transform.k;
            };

            if (currentscale != "") {
                svg.transition()
                      .delay(100)
                      .duration(700)
                      .call(zoom.scaleTo, currentscale);

            }

            function transition(zoomLevel) {
                svg.transition()
                    .delay(100)
                    .duration(700)
                    .call(zoom.scaleBy, zoomLevel);
                //.call(zoom.transform, transform);
                //.on("end", function() { canvas.call(transition); });
            }

            d3.selectAll('button').on('click', function () {
                if (this.id === 'zoom_in') {
                    transition(1.2); // increase on 0.2 each time
                }
                if (this.id === 'zoom_out') {
                    transition(0.8); // deacrease on 0.2 each time
                }
                if (this.id === 'zoom_init') {
                    svg.transition()
                        .delay(100)
                        .duration(700)
                        .call(zoom.scaleTo, 1.5); // return to initial state
                }
                if (this.id === 'btnresize') {
                    if (sizetoggle == 0) {
                        $(div).css("height", "90%");
                        $('.row').css("width", "100%");
                        $('#connForcelay').css("height", "1100px");
                        //$('#maindivGraph').removeClass('col-md-9 ml-sm-auto col-lg-10').addClass('col-md-9 ml-sm-auto col-lg-12');
                        //$('#seconddivgraph').hide();
                        $('#clientconnectionHelp').hide();
                        $('#showhideNav').hide();
                        $('#seconddivgraph').css({ 'margin-top': '0px' });
                        sizetoggle = 1;
                    }
                    else {
                        $(div).css("height", "75%");
                        $('.row').css("width", "100%");
                        $('#connForcelay').css("height", "800px");
                        //$('#maindivGraph').removeClass('col-md-9 ml-sm-auto col-lg-12').addClass('col-md-9 ml-sm-auto col-lg-10');
                        //$('#seconddivgraph').show();
                        $('#clientconnectionHelp').show();
                        $('#showhideNav').show();
                        $('#seconddivgraph').css({ 'margin-top': '65px' });
                        sizetoggle = 0;
                    }
                }
            });

            var color = d3.scaleOrdinal(d3.schemeCategory20);


            var simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(function (d) { return d.id; }).distance(function (d, i) {
                    if (d.target.createdon != "" && d.target.createdon != undefined)
                    {
                        if (d.target.createdon >= "2017")
                            return 30 + i;
                        else if (d.target.createdon == "2016")
                            return 60 + i;
                        else if (d.target.createdon == "2015")
                            return 90 + i;
                        else
                            return 120 + i;
                    }
                    else {
                        return 30 + i
                    }
                }))
                .force("charge", d3.forceManyBody().strength(-100))
                .force("center", d3.forceCenter(width / 2, height / 2));


            var link = g.append("g")
                .attr("class", "links")
              .selectAll("line")
              .data(nodelink.links)
              .enter().append("line")
                .style("stroke-dasharray", (0, function (d) {
                    if (d.value == 1) {
                        return 3;
                    }
                    else { return 0; }
                }))
                .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

            var node = g.append("g")
               .attr("class", "nodes")
             .selectAll("circle")
             .data(nodelink.nodes)
             .enter().append("g")
             .on('dblclick', releasenode)
             .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            var circle = node.append("circle")
                .attr("r", function (d) { return d.rad; })
                .attr("fill", function (d) { return GetNodeBackGrdClr(d, color) })
                .style("stroke", function (d) { return GetNodeBackGrdClr(d, color) })
                .style("stroke-width", 1)
             .on("click", function (d) {
                 tooltip.style("visibility", "hidden");
                 getDataforUser(d.userid, d.id)
             })
             .on("mouseover", function (d) {
                 var tooltipcontent = getToolTipsForConnectionMarketingLists(d);
                 tooltip.html(tooltipcontent); return tooltip.style("visibility", "visible");
             })
          .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
          .on("mouseout", function () { return tooltip.style("visibility", "hidden"); });

            // add circle clip
            var clipPath = node.append("clipPath")
                                        .attr("id", function (d, i) {
                                            return "clipCircle_" + i
                                        })
                                        .append("circle")
                                        .attr("r", function (d) { return d.rad });

            var tooltip = d3.select("body")
      .append("div")
      .style("position", "absolute")
      .style("z-index", "12")
      .style("visibility", "hidden")
      .style("background", "#5C9BD1")
      .style("color", "white")
      .style("padding", "5px")
      .style("margin", "2px")
      .style("font-size", "12px")
      .style("box-shadow", "0px 5px 15px 0px rgba(0,0,0,0.3)")
      .text("a simple tooltip");



            var image = node.append('svg:image').attr('class', 'entityImage').attr('xlink:href', function (d) {
                if (d.userid == "500")
                {
                    if (d.activitytype == "Appointment")
                    {
                        // appointment
                        return '../../arup_graphappointment'
                    }
                    else if (d.activitytype == "Email") {
                        // Email
                        return '../../arup_graphemail'
                    }
                    else if (d.activitytype == "Task") {
                        // task
                        return '../../arup_graphtask'
                    }
                    else if (d.activitytype == "Phone Call") {
                        // phone call
                        return '../../arup_graphphonecall'
                    }
                    else
                        return '../../arup_graphActivities'
                }
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.imageUrl;
                }
                else {
                    return '../../arup_/Images/Contact.png';
                }
            })
            .attr('width', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.rad * 3;
                }
                else {
                    return d.rad + d.rad * .1;
                }
            })
            .attr('height', function (d) {
                if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                    return d.rad * 3;
                }
                else {
                    return d.rad + d.rad * .1;
                }
            })
            .attr("clip-path", function (d, i) { return "url(#clipCircle_" + i + ")" })
             .on("click", function (d) {
                 tooltip.style("visibility", "hidden");
                 getDataforUser(d.userid, d.id)
             })
             .on("mouseover", function (d) {
                 var tooltipcontent = getToolTipsForConnectionMarketingLists(d);
                 tooltip.html(tooltipcontent); return tooltip.style("visibility", "visible");
             })
          .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
          .on("mouseout", function () { return tooltip.style("visibility", "hidden"); });

            var nodeText = node.append('svg:text').attr('class', 'nodetext').text(function (d) {
                var name = d.name.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                if (name.length > 20)
                {
                    name = name.substring(0, 20) + "...";
                }
                if (isManagedClient) {
                    if (d.id == relationshipManager) {
                        return name + " (RM)";
                    }
                    else if (relTeamMembers.indexOf(d.id) > -1) {
                        return name + " (RT)";
                    }
                    else {
                        return name;
                    }
                }
                return name;
            }).style("text-anchor", "middle");

            //var title = node.append("title")
            //     .text(function (d) { return d.id; });

            simulation
                .nodes(nodelink.nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(nodelink.links);

            function ticked() {
                link
                    .attr("x1", function (d) { return d.source.x; })
                    .attr("y1", function (d) { return d.source.y; })
                    .attr("x2", function (d) { return d.target.x; })
                    .attr("y2", function (d) { return d.target.y; });

                circle
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });

                clipPath
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });

                image
                    .attr("x", function (d) {
                        if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                            return d.x - d.rad - d.rad * .5;
                        }
                        else {
                            return d.x - d.rad + d.rad * .45;
                        }
                    })
                    .attr("y", function (d) {
                        if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                            return d.y - d.rad - d.rad * .5;
                        }
                        else {
                            return d.y - d.rad + d.rad * .45;
                        }

                    });


                nodeText
                    .attr("dx", function (d) { return d.x - function (d) { return d.name.normalize('NFD').replace(/[\u0300-\u036f]/g, "") }.length / 2 * 3; })
                    .attr("dy", function (d) {
                        if (d.group == 1) {
                            return d.y - 11;
                        }
                        else if (d.group == 2) {
                            return d.y - 8;
                        }
                        else if (d.group == 6) {
                            return d.y - 11;
                        }
                        else {
                            return d.y - 7;
                        }
                    })
                 .attr("width", "50");
            }

            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                //d.fx = null;
                //d.fy = null;
                d.fx = d.x;
                d.fy = d.y;
            }

            function releasenode(d) {
                //d.fx = false; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
                //force.resume();
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

        }
        var opportunitiesData = "";
        function PopulateOpportunities(OrganisationId,Opptid,opptystatuscode,showArupInternal) {
            opportunitiesData = "";
            var xmlOpptycondition = "";
            var xmlOpptyInternalcondition = "";
            var xmlOpptyconditionstatus = "";
            if (Opptid == undefined || Opptid == "") {
                xmlOpptycondition = "";
            }
            else {
                xmlOpptycondition = "<condition attribute='opportunityid' operator='eq' value='" + Opptid + "' />"
            }
            if (opptystatuscode == undefined || opptystatuscode == "") {
                xmlOpptyconditionstatus = "";
            }
            else {
                opptystatusresults = opptystatuscode.split(",");
                if (opptystatusresults.length == 1)
                    xmlOpptyconditionstatus = "<condition attribute='statuscode' operator='eq' value='" + opptystatuscode + "' />"
                else
                {
                    xmlOpptyconditionstatus =  "<condition attribute='statuscode' operator='in'>";
                    for (i = 0; i < opptystatusresults.length; i++) {
                        xmlOpptyconditionstatus += "<value>" + opptystatusresults[i] + "</value>";
                    }
                    xmlOpptyconditionstatus += " </condition>";
                }
            }
            if (showArupInternal == undefined || showArupInternal == "" || showArupInternal == "false") {
                xmlOpptyInternalcondition = "<condition attribute='ccrm_arupinternal' operator='eq' value='0' />";
            }
            else {
                xmlOpptyInternalcondition = "";
            }



            //new fectxml -  everything is same just modified to populate user/contact image url
            var fetchXML = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false' >"+
            "<entity name='opportunity' >"+
              "<attribute name='name' alias = 'opptyname' />"+
              "<attribute name='statuscode' alias = 'opptystatus' />" +
               "<attribute name='estimatedvalue' alias = 'opptyestimatedvalue' />" +
              "<attribute name='ccrm_arupbusinessid' alias = 'opptybusiness' />" +
              "<attribute name='opportunityid' alias = 'opptyid' />" +
               "<attribute name='ccrm_arupinternal' alias = 'opptyarupinternal' />" +
              "<order attribute='name' descending='false' />"+
              "<filter type='and' >"+
                "<condition attribute='parentaccountid' operator='eq' uitype='account' value='" + OrganisationId + "' />" +
                   xmlOpptycondition + xmlOpptyconditionstatus + xmlOpptyInternalcondition +
                 "<condition attribute='statecode' operator='eq' value='0' />" +
              "</filter>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_bidmanager_userid' visible='false' link-type='outer' alias='bm' >" +
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_bidmanager_userid' />" +
                "<attribute name='entityimage_url' alias='bidmanager_image' />" +
                "<attribute name='title' alias = 'bidmanager_title' />" +
                 "<attribute name='address1_telephone1' alias = 'bidmanager_phone' />" +
                    "<attribute name='ccrm_accountingcentreid' alias = 'bidmanager_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'bidmanager_region' />" +
              "</link-entity>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_biddirector_userid' visible='false' link-type='outer' alias='bd' >"+
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_biddirector_userid' />" +
                "<attribute name='entityimage_url' alias='biddirector_image' />" +
                  "<attribute name='title' alias = 'biddirector_title' />" +
                 "<attribute name='address1_telephone1' alias = 'biddirector_phone' />" +
                      "<attribute name='ccrm_accountingcentreid' alias = 'biddirector_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'biddirector_region' />" +
              "</link-entity>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_bidreviewchair_userid' visible='false' link-type='outer' alias='brc' >"+
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_bidreviewchair_userid' />" +
                 "<attribute name='entityimage_url' alias='bidreviewchair_image' />" +
                  "<attribute name='title' alias = 'bidreviewchair_title' />" +
                 "<attribute name='address1_telephone1' alias = 'bidreviewchair_phone' />" +
                      "<attribute name='ccrm_accountingcentreid' alias = 'bidreviewchair_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'bidreviewchair_region' />" +
              "</link-entity>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_projectdirector_userid' visible='false' link-type='outer' alias='pd' >"+
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_projectdirector_userid' />" +
                "<attribute name='entityimage_url' alias='projectdirector_image' />" +
                  "<attribute name='title' alias = 'projectdirector_title' />" +
                 "<attribute name='address1_telephone1' alias = 'projectdirector_phone' />" +
                        "<attribute name='ccrm_accountingcentreid' alias = 'projectdirector_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'projectdirector_region' />" +
              "</link-entity>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_projectmanager_userid' visible='false' link-type='outer' alias='pm' >"+
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_projectmanager_userid' />" +
                    "<attribute name='entityimage_url' alias='projectmanager_image' />" +
                       "<attribute name='title' alias = 'projectmanager_title' />" +
                 "<attribute name='address1_telephone1' alias = 'projectmanager_phone' />" +
                       "<attribute name='ccrm_accountingcentreid' alias = 'projectmanager_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'projectmanager_region' />" +
              "</link-entity>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_businessadministrator_userid' visible='false' link-type='outer' alias='ba' >"+
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_businessadministrator_userid' />" +
                   "<attribute name='entityimage_url' alias='businessadministrator_image' />" +
                      "<attribute name='title' alias = 'businessadministrator_title' />" +
                 "<attribute name='address1_telephone1' alias = 'businessadministrator_phone' />" +
                      "<attribute name='ccrm_accountingcentreid' alias = 'businessadministrator_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'businessadministrator_region' />" +
              "</link-entity>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_commercialmanager_userid' visible='false' link-type='outer' alias='cm' >"+
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_commercialmanager_userid' />" +
                 "<attribute name='entityimage_url' alias='commercialmanager_image' />" +
                     "<attribute name='title' alias = 'commercialmanager_title' />" +
                 "<attribute name='address1_telephone1' alias = 'commercialmanager_phone' />" +
                        "<attribute name='ccrm_accountingcentreid' alias = 'commercialmanager_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'commercialmanager_region' />" +
              "</link-entity>"+
              "<link-entity name='contact' from='contactid' to='ccrm_clientcontactid' visible='false' link-type='outer' alias='cc' >"+
                "<attribute name='address1_telephone1' />"+
                "<attribute name='fullname' />"+
                "<attribute name='contactid' alias='ccrm_clientcontactid' />" +
                  "<attribute name='entityimage_url' alias='clientcontact_image' />" +
              "</link-entity>"+
              "<link-entity name='systemuser' from='systemuserid' to='ccrm_aruplocalcontact_userid' visible='false' link-type='outer' alias='alc' >"+
                "<attribute name='mobilephone' />"+
                "<attribute name='fullname' />"+
                "<attribute name='systemuserid' alias='ccrm_aruplocalcontact_userid' />" +
                   "<attribute name='entityimage_url' alias='aruplocalcontact_image' />" +
                                      "<attribute name='title' alias = 'aruplocalcontact_title' />" +
                 "<attribute name='address1_telephone1' alias = 'aruplocalcontact_phone' />" +
                       "<attribute name='ccrm_accountingcentreid' alias = 'aruplocalcontact_accountingcode' />" +
                    "<attribute name='ccrm_arupregionid' alias = 'aruplocalcontact_region' />" +
              "</link-entity>"+
            "</entity>"+
          "</fetch>";


            var connections = XrmServiceToolkit.Soap.Fetch(fetchXML);
            var connectionLst = [];
            var connectionLstTbl = [];
            var contactLst = [];

            if (connections.length > 0) {
                for (var i = 0; i < connections.length; i++) {
                    //debugger;
                    var connection = connections[i];
                    var Opportunityid = connection.attributes.opptyid != undefined ? connection.attributes.opptyid.value : "";
                    var OpportunityName = connection.attributes.opptyname != undefined ? connection.attributes.opptyname.value : "";
                    var Opportunitystatus = connection.attributes.opptystatus != undefined ? connection.attributes.opptystatus.formattedValue : "";
                    var OpportunityBusiness = connection.attributes.opptybusiness != undefined ? connection.attributes.opptybusiness.name : "";
                    var OpportunityFees = connection.attributes.opptyestimatedvalue != undefined ? connection.attributes.opptyestimatedvalue.formattedValue : "";
                    var OpportunityInternal = connection.attributes.opptyarupinternal != undefined ? connection.attributes.opptyarupinternal.formattedValue : "";

                    var bidmanager_userid = connection.attributes.ccrm_bidmanager_userid != undefined ? connection.attributes.ccrm_bidmanager_userid.value + ":bm" + OrganisationId: "";
                    var bidmanager_name = connection.attributes['bm.fullname'] != undefined ? connection.attributes['bm.fullname'].value : "";
                   // var bidmanager_phone = connection.attributes['bm.mobilephone'] != undefined ? connection.attributes['bm.mobilephone'].value : "";
                    var bidmanager_image = connection.attributes.bidmanager_image != undefined ? connection.attributes.bidmanager_image.value : "";
                    var bidmanager_Phone = connection.attributes.bidmanager_phone != undefined ? connection.attributes.bidmanager_phone.value : "";
                  //  var bidmanager_CompanyCode = connection.attributes.bidmanager_companycode != undefined ? connection.attributes.bidmanager_companycode.value : "";
                    var bidmanager_AccountingCode = connection.attributes.bidmanager_accountingcode != undefined ? connection.attributes.bidmanager_accountingcode.name : "";
                    var bidmanager_Region = connection.attributes.bidmanager_region != undefined ? connection.attributes.bidmanager_region.name : "";
                    var bidmanager_Title = connection.attributes.bidmanager_title != undefined ? connection.attributes.bidmanager_title.value : "";

                    var biddirector_userid = connection.attributes.ccrm_biddirector_userid != undefined ? connection.attributes.ccrm_biddirector_userid.value + ":bd" + OrganisationId : "";
                    var biddirector_name = connection.attributes['bd.fullname'] != undefined ? connection.attributes['bd.fullname'].value : "";
                   // var biddirector_phone = connection.attributes['bd.mobilephone'] != undefined ? connection.attributes['bd.mobilephone'].value : "";
                    var biddirector_image = connection.attributes.biddirector_image != undefined ? connection.attributes.biddirector_image.value : "";
                    var biddirector_Phone = connection.attributes.biddirector_phone != undefined ? connection.attributes.biddirector_phone.value : "";
                    //var biddirector_CompanyCode = connection.attributes.biddirector_companycode != undefined ? connection.attributes.biddirector_companycode.value : "";
                    var biddirector_AccountingCode = connection.attributes.biddirector_accountingcode != undefined ? connection.attributes.biddirector_accountingcode.name : "";
                    var biddirector_Region = connection.attributes.biddirector_region != undefined ? connection.attributes.biddirector_region.name : "";
                    var biddirector_Title = connection.attributes.biddirector_title != undefined ? connection.attributes.biddirector_title.value : "";


                    var bidreviewchair_userid = connection.attributes.ccrm_bidreviewchair_userid != undefined ? connection.attributes.ccrm_bidreviewchair_userid.value + ":brc" + OrganisationId : "";
                    var bidreviewchair_name = connection.attributes['brc.fullname'] != undefined ? connection.attributes['brc.fullname'].value : "";
                    //var bidreviewchair_phone = connection.attributes['brc.mobilephone'] != undefined ? connection.attributes['brc.mobilephone'].value : "";
                    var bidreviewchair_image = connection.attributes.bidreviewchair_image != undefined ? connection.attributes.bidreviewchair_image.value : "";
                    var bidreviewchair_Phone = connection.attributes.bidreviewchair_phone != undefined ? connection.attributes.bidreviewchair_phone.value : "";
                   // var bidreviewchair_CompanyCode = connection.attributes.bidreviewchair_companycode != undefined ? connection.attributes.bidreviewchair_companycode.value : "";
                    var bidreviewchair_AccountingCode = connection.attributes.bidreviewchair_accountingcode != undefined ? connection.attributes.bidreviewchair_accountingcode.name : "";
                    var bidreviewchair_Region = connection.attributes.bidreviewchair_region != undefined ? connection.attributes.bidreviewchair_region.name : "";
                    var bidreviewchair_Title = connection.attributes.bidreviewchair_title != undefined ? connection.attributes.bidreviewchair_title.value : "";

                    var projectdirector_userid = connection.attributes.ccrm_projectdirector_userid != undefined ? connection.attributes.ccrm_projectdirector_userid.value + ":pd" + OrganisationId : "";
                    var projectdirector_name = connection.attributes['pd.fullname'] != undefined ? connection.attributes['pd.fullname'].value : "";
                   // var projectdirector_phone = connection.attributes['pd.mobilephone'] != undefined ? connection.attributes['pd.mobilephone'].value : "";
                    var projectdirector_image = connection.attributes.projectdirector_image != undefined ? connection.attributes.projectdirector_image.value : "";
                    var projectdirector_Phone = connection.attributes.projectdirector_phone != undefined ? connection.attributes.projectdirector_phone.value : "";
                    //var projectdirector_CompanyCode = connection.attributes.projectdirector_companycode != undefined ? connection.attributes.projectdirector_companycode.value : "";
                    var projectdirector_AccountingCode = connection.attributes.projectdirector_accountingcode != undefined ? connection.attributes.projectdirector_accountingcode.name : "";
                    var projectdirector_Region = connection.attributes.projectdirector_region != undefined ? connection.attributes.projectdirector_region.name : "";
                    var projectdirector_Title = connection.attributes.projectdirector_title != undefined ? connection.attributes.projectdirector_title.value : "";

                    var projectmanager_userid = connection.attributes.ccrm_projectmanager_userid != undefined ? connection.attributes.ccrm_projectmanager_userid.value + ":pm" + OrganisationId : "";
                    var projectmanager_name = connection.attributes['pm.fullname'] != undefined ? connection.attributes['pm.fullname'].value : "";
                    //var projectmanager_phone = connection.attributes['pm.mobilephone'] != undefined ? connection.attributes['pm.mobilephone'].value : "";
                    var projectmanager_image = connection.attributes.projectmanager_image != undefined ? connection.attributes.projectmanager_image.value : "";
                    var projectmanager_Phone = connection.attributes.projectmanager_phone != undefined ? connection.attributes.projectmanager_phone.value : "";
                    //var projectmanager_CompanyCode = connection.attributes.projectmanager_companycode != undefined ? connection.attributes.projectmanager_companycode.value : "";
                    var projectmanager_AccountingCode = connection.attributes.projectmanager_accountingcode != undefined ? connection.attributes.projectmanager_accountingcode.name : "";
                    var projectmanager_Region = connection.attributes.projectmanager_region != undefined ? connection.attributes.projectmanager_region.name : "";
                    var projectmanager_Title = connection.attributes.projectmanager_title != undefined ? connection.attributes.projectmanager_title.value : "";

                    var businessadministrator_userid = connection.attributes.ccrm_businessadministrator_userid != undefined ? connection.attributes.ccrm_businessadministrator_userid.value + ":ba" + OrganisationId : "";
                    var businessadministrator_name = connection.attributes['ba.fullname'] != undefined ? connection.attributes['ba.fullname'].value : "";
                   // var businessadministrator_phone = connection.attributes['ba.mobilephone'] != undefined ? connection.attributes['ba.mobilephone'].value : "";
                    var businessadministrator_image = connection.attributes.businessadministrator_image != undefined ? connection.attributes.businessadministrator_image.value : "";
                    var businessadministrator_Phone = connection.attributes.businessadministrator_phone != undefined ? connection.attributes.businessadministrator_phone.value : "";
                //    var businessadministrator_CompanyCode = connection.attributes.businessadministrator_companycode != undefined ? connection.attributes.businessadministrator_companycode.value : "";
                    var businessadministrator_AccountingCode = connection.attributes.businessadministrator_accountingcode != undefined ? connection.attributes.businessadministrator_accountingcode.name : "";
                    var businessadministrator_Region = connection.attributes.businessadministrator_region != undefined ? connection.attributes.businessadministrator_region.name : "";
                    var businessadministrator_Title = connection.attributes.businessadministrator_title != undefined ? connection.attributes.businessadministrator_title.value : "";

                    var commercialmanager_userid = connection.attributes.ccrm_commercialmanager_userid != undefined ? connection.attributes.ccrm_commercialmanager_userid.value + ":cm" + OrganisationId : "";
                    var commercialmanager_name = connection.attributes['cm.fullname'] != undefined ? connection.attributes['cm.fullname'].value : "";
                    //var commercialmanager_phone = connection.attributes['cm.mobilephone'] != undefined ? connection.attributes['cm.mobilephone'].value : "";
                    var commercialmanager_image = connection.attributes.commercialmanager_image != undefined ? connection.attributes.commercialmanager_image.value : "";
                    var commercialmanager_Phone = connection.attributes.commercialmanager_phone != undefined ? connection.attributes.commercialmanager_phone.value : "";
                   // var commercialmanager_CompanyCode = connection.attributes.commercialmanager_companycode != undefined ? connection.attributes.commercialmanager_companycode.value : "";
                    var commercialmanager_AccountingCode = connection.attributes.commercialmanager_accountingcode != undefined ? connection.attributes.commercialmanager_accountingcode.name : "";
                    var commercialmanager_Region = connection.attributes.commercialmanager_region != undefined ? connection.attributes.commercialmanager_region.name : "";
                    var commercialmanager_Title = connection.attributes.commercialmanager_title != undefined ? connection.attributes.commercialmanager_title.value : "";

                    var aruplocalcontact_userid = connection.attributes.ccrm_aruplocalcontact_userid != undefined ? connection.attributes.ccrm_aruplocalcontact_userid.value + ":alc" + OrganisationId: "";
                    var aruplocalcontact_name = connection.attributes['alc.fullname'] != undefined ? connection.attributes['alc.fullname'].value : "";
                    var aruplocalcontact_phone = connection.attributes['alc.mobilephone'] != undefined ? connection.attributes['alc.mobilephone'].value : "";
                    var aruplocalcontact_image = connection.attributes.aruplocalcontact_image != undefined ? connection.attributes.aruplocalcontact_image.value : "";
                    var aruplocalcontact_Phone = connection.attributes.aruplocalcontact_phone != undefined ? connection.attributes.aruplocalcontact_phone.value : "";
                   // var aruplocalcontact_CompanyCode = connection.attributes.aruplocalcontact_companycode != undefined ? connection.attributes.aruplocalcontact_companycode.value : "";
                    var aruplocalcontact_AccountingCode = connection.attributes.aruplocalcontact_accountingcode != undefined ? connection.attributes.aruplocalcontact_accountingcode.name : "";
                    var aruplocalcontact_Region = connection.attributes.aruplocalcontact_region != undefined ? connection.attributes.aruplocalcontact_region.name : "";
                    var aruplocalcontact_Title = connection.attributes.aruplocalcontact_title != undefined ? connection.attributes.aruplocalcontact_title.value : "";

                    var clientcontact_userid = connection.attributes.ccrm_clientcontactid != undefined ? connection.attributes.ccrm_clientcontactid.value + ":cc" + OrganisationId : "";
                    var clientcontact_name = connection.attributes['cc.fullname'] != undefined ? connection.attributes['cc.fullname'].value : "";
                    var clientcontact_phone = connection.attributes['cc.address1_telephone1'] != undefined ? connection.attributes['cc.address1_telephone1'].value : "";
                    var clientcontact_image = connection.attributes.clientcontact_image != undefined ? connection.attributes.clientcontact_image.value : "";

                    var conn = {
                        "Opportunityid": Opportunityid,
                        "OpportunityName": OpportunityName,
                        "Opportunitystatus": Opportunitystatus,
                        "OpportunityBusiness": OpportunityBusiness,
                        "OpportunityFees": OpportunityFees,
                        "OpportunityInternal" : OpportunityInternal,

                        "bidmanager_userid": bidmanager_userid,
                        "bidmanager_name": bidmanager_name,
                        //"bidmanager_phone": bidmanager_phone,
                        "bidmanager_image": bidmanager_image,
                        "bidmanager_Phone" : bidmanager_Phone,
                        //"bidmanager_CompanyCode" : bidmanager_CompanyCode,
                        "bidmanager_AccountingCode" : bidmanager_AccountingCode,
                        "bidmanager_Region" : bidmanager_Region,
                        "bidmanager_Title" : bidmanager_Title,

                        "biddirector_userid": biddirector_userid,
                        "biddirector_name": biddirector_name,
                        //"biddirector_phone": biddirector_phone,
                        "biddirector_image": biddirector_image,
                        "biddirector_Phone": biddirector_Phone,
                        //"biddirector_CompanyCode": biddirector_CompanyCode,
                        "biddirector_AccountingCode": biddirector_AccountingCode,
                        "biddirector_Region": biddirector_Region,
                        "biddirector_Title": biddirector_Title,

                        "bidreviewchair_userid": bidreviewchair_userid,
                        "bidreviewchair_name": bidreviewchair_name,
                        //"bidreviewchair_phone": bidreviewchair_phone,
                        "bidreviewchair_image": bidreviewchair_image,
                        "bidreviewchair_Phone": bidreviewchair_Phone,
                       // "bidreviewchair_CompanyCode": bidreviewchair_CompanyCode,
                        "bidreviewchair_AccountingCode": bidreviewchair_AccountingCode,
                        "bidreviewchair_Region": bidreviewchair_Region,
                        "bidreviewchair_Title": bidreviewchair_Title,

                        "projectdirector_userid": projectdirector_userid,
                        "projectdirector_name": projectdirector_name,
                        //"projectdirector_phone": projectdirector_phone,
                        "projectdirector_image": projectdirector_image,
                        "projectdirector_Phone": projectdirector_Phone,
                       // "projectdirector_CompanyCode": projectdirector_CompanyCode,
                        "projectdirector_AccountingCode": projectdirector_AccountingCode,
                        "projectdirector_Region": projectdirector_Region,
                        "projectdirector_Title": projectdirector_Title,

                        "projectmanager_userid": projectmanager_userid,
                        "projectmanager_name": projectmanager_name,
                        //"projectmanager_phone": projectmanager_phone,
                        "projectmanager_image": projectmanager_image,
                        "projectmanager_Phone": projectmanager_Phone,
                       // "projectmanager_CompanyCode": projectmanager_CompanyCode,
                        "projectmanager_AccountingCode": projectmanager_AccountingCode,
                        "projectmanager_Region": projectmanager_Region,
                        "projectmanager_Title": projectmanager_Title,

                        "businessadministrator_userid": businessadministrator_userid,
                        "businessadministrator_name": businessadministrator_name,
                        //"businessadministrator_phone": businessadministrator_phone,
                        "businessadministrator_image": businessadministrator_image,
                        "businessadministrator_Phone": businessadministrator_Phone,
                        //"businessadministrator_CompanyCode": businessadministrator_CompanyCode,
                        "businessadministrator_AccountingCode": businessadministrator_AccountingCode,
                        "businessadministrator_Region": businessadministrator_Region,
                        "businessadministrator_Title": businessadministrator_Title,

                        "commercialmanager_userid": commercialmanager_userid,
                        "commercialmanager_name": commercialmanager_name,
                        //"commercialmanager_phone": commercialmanager_phone,
                        "commercialmanager_image": commercialmanager_image,
                        "commercialmanager_Phone": commercialmanager_Phone,
                       // "commercialmanager_CompanyCode": commercialmanager_CompanyCode,
                        "commercialmanager_AccountingCode": commercialmanager_AccountingCode,
                        "commercialmanager_Region": commercialmanager_Region,
                        "commercialmanager_Title": commercialmanager_Title,

                        "aruplocalcontact_userid": aruplocalcontact_userid,
                        "aruplocalcontact_name": aruplocalcontact_name,
                       // "aruplocalcontact_phone": aruplocalcontact_phone,
                        "aruplocalcontact_image": aruplocalcontact_image,
                        "aruplocalcontact_Phone": aruplocalcontact_Phone,
                        //"aruplocalcontact_CompanyCode": aruplocalcontact_CompanyCode,
                        "aruplocalcontact_AccountingCode": aruplocalcontact_AccountingCode,
                        "aruplocalcontact_Region": aruplocalcontact_Region,
                        "aruplocalcontact_Title": aruplocalcontact_Title,

                        "clientcontact_userid": clientcontact_userid,
                        "clientcontact_name": clientcontact_name,
                        "clientcontact_phone": clientcontact_phone,
                        "clientcontact_image": clientcontact_image
                    };

                    connectionLst.push(conn);
                }
                return connectionLst;
              //  $('#chkMarketingList').prop('checked', false);
              //  $('#chkContactActivities').prop('checked', false);
              //  DrawMatrixForceLayoutOpportunities("#connectionMatrix", connectionLst);
            }
        }

        function loadChildOpportunityData(currentaccId, opportunityid, showBidTeams, opptystatuscode,showInternal)
        {
            //Child org Opportunities data
            var fetchxml = "<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false'>" +
                               "<entity name='account'>" +
                               "<attribute name='name' alias ='orgname' />" +
                               "<attribute name='accountid' alias = 'orgid' />" +
                               "<attribute name='address1_city' />" +
                                "<attribute name='ccrm_address1attentiondepartment' alias = 'orgdepartment' />" +
                                "<attribute name='arup_openopportunitiescalc' alias = 'orgopenopptys' />" +
                               "<order attribute='name' descending='false' />" +
                               "<filter type='and'>" +
                                   "<condition attribute='parentaccountid' operator='eq' uitype='account' value='" + currentaccId + "' />" +
                                   "<condition attribute='arup_openopportunitiescalc' operator='gt' value='0' />" +
                               "</filter>" +
                               "</entity>" +
                           "</fetch>"
            var Organisations = XrmServiceToolkit.Soap.Fetch(fetchxml);
            if (Organisations.length > 0) {
                for (var i = 0; i < Organisations.length; i++) {
                    var connection = Organisations[i];
                    var childOrgName = connection.attributes.orgname != undefined ? connection.attributes.orgname.value : "";
                    var childOrgid = connection.attributes.orgid != undefined ? connection.attributes.orgid.value : "";
                    var childTownCity = connection.attributes.address1_city != undefined ? connection.attributes.address1_city.value : "";
                    var childDepartment = connection.attributes.orgdepartment != undefined ? connection.attributes.orgdepartment.value : "";
                    var childOpenOpptys = connection.attributes.orgopenopptys != undefined ? connection.attributes.orgopenopptys.value : "";

                    Opportunitynodelink.nodes.push({
                        id: childOrgid, name: childOrgName, NodeName: childOrgName, group: 1, rad: 8, imageUrl: '../../arup_graphOrg', phone: "", jobtitleorCountry: "", userid: "100"
                        ,orgTownCity: childTownCity, orgDepartment: childDepartment,orgOpenOpptys: childOpenOpptys
                    });
                    Opportunitynodelink.links.push({ source: currentaccId, target: childOrgid, value: 2 });
                    var childOpporutnityData = PopulateOpportunities(childOrgid, opportunityid, opptystatuscode, showInternal);
                    if (childOpporutnityData != undefined) {
                        NodesOrgOpportunities(childOrgid, childOpporutnityData, showBidTeams);
                    }

                    if(childOrgid != "")
                    {
                        loadChildOpportunityData(childOrgid, opportunityid, showBidTeams, opptystatuscode, showInternal);
                    }
                }
            }
        }

        var Opportunitynodelink = Object();
        function OpportunityMatrix(curaccid,curOrgName,curOpptyid,showBidTeams,opportunitystatuscode,showInternal)
        {
            if (curaccid == undefined || curaccid == "")
                curaccid = accId;
            if (curOrgName == undefined || curOrgName == "")
                curOrgName = accName;
            if (showBidTeams == undefined)
                showBidTeams = false;
            if (showInternal == undefined || showInternal == "")
                showInternal = false;


            $("#Connectionfilters").hide();
            $("#Accountfilters").show();
            InititializeGraphDivs();
            InitializeHomeButtonClick();
            Opportunitynodelink = Object();
            Opportunitynodelink.nodes = [];
            Opportunitynodelink.links = [];

            OpporutnityData = PopulateOpportunities(curaccid, curOpptyid, opportunitystatuscode,showInternal);

            Opportunitynodelink.nodes.push({
                id: curaccid, name: curOrgName, NodeName: curOrgName, group: 8, rad: 12, imageUrl: '../../arup_graphOrg', phone: "", jobtitleorCountry: "",
                userid: "100", orgTownCity: accTownCity, orgDepartment: accDepartment,orgOpenOpptys: accOpenOpptys
            });
            if(OpporutnityData != undefined)
                NodesOrgOpportunities(curaccid, OpporutnityData, showBidTeams);

            loadChildOpportunityData(curaccid, curOpptyid, showBidTeams, opportunitystatuscode,showInternal);

            var svgwidth = $("#connForcelay").width()

            var svg = d3.select("#connForcelay"),
            width = +svgwidth,
            height = +svg.attr("height");
            var zoom = d3.zoom().scaleExtent([1 / 2, 4]).on("zoom", zoomed);
            svg.call(zoom);


                svg.append("rect")
                    .attr("width", width)
                    .attr("height", height)
                    .style("fill", "none")
                    .style("pointer-events", "all");

                var g = svg.append("g");



            /////////
                var config = {
                    "avatar_size": 10
                }

                var body = d3.select("body");
                var defs = svg.append('svg:defs');
                data = [{
                    posx: 30,
                    posy: 20,
                    posx1: 22,
                    posy1: 6,
                    img: "../../arup_graphOrg",
                    color: "#875005",
                    "label": "Organisations",
                    width: 16
                }, {
                    posx: 170,
                    posy: 20,
                    posx1: 161,
                    posy1: 5,
                    img: "../../arup_graphOpportunities",
                    color: "#FDD7A5",
                    "label": "Opportunities",
                    width: 16
                },
        {
            posx: 310,
            posy: 20,
            posx1: 161,
            posy1: 5,
            img: "../../arup_graphOpportunities",
            color: "#fcfda5",
            "label": "Internal Opportunities",
            width: 16
        },
        {
                    posx: 450,
                    posy: 20,
                    posx1: 306,
                    posy1: 10,
                    img: "../../arup_/Images/Contact.png",
                    color: "#46488C",
                    "label": "Bid Teams",
                    width: 8
                }

                ];
                data.forEach(function (d, i) {
                    svg.append("circle")
                    .attr('cx', d.posx)
                              .attr('cy', d.posy)
                             .attr('r', config.avatar_size)
                             .style("stroke-width", 1)
                              .attr("fill", d.color)
                         .style("stroke", d.color)

                    svg.append('clipPath')
                       .attr('id', 'clipObj' + i)
                            .append('circle')
                             .attr('cx', d.posx)
                              .attr('cy', d.posy)
                             .attr('r', config.avatar_size)

                })

                data.forEach(function (d, i) {
                    var xaxis, yaxis, width
                    if (d.label == "Organisations" || d.label == "Opportunities" || d.label == "Internal Opportunities") {
                        width = config.avatar_size * 3;
                        xaxis = parseInt(d.posx - (config.avatar_size + config.avatar_size * .5));
                        yaxis = parseInt(d.posy - (config.avatar_size + config.avatar_size * .5));
                    }
                    else {
                        width = config.avatar_size + config.avatar_size * .1;
                        xaxis = parseInt(d.posx - config.avatar_size + config.avatar_size * .45);
                        yaxis = parseInt(d.posy - config.avatar_size + config.avatar_size * .45)
                    }
                    svg.append('image')
                       .attr('xlink:href', d.img)
                       .attr('width', width)
                       .attr('height', width)
                        .attr('x', xaxis)
                          .attr('y', yaxis)
                      // .attr('transform', 'translate(' + parseInt(d.posx1) + ',' + parseInt(d.posy1) + ')')
                       // .attr('transform', 'translate(' + parseInt(d.posx - config.avatar_size + config.avatar_size * .45) + ',' + parseInt(d.posy - config.avatar_size + config.avatar_size * .45) + ')')
                       .attr('clip-path', "url(#clipObj" + i + ")")

                })
                var text = svg.selectAll("text")
                     .data(data)
                     .enter()
                     .append("text");


                var textLabels = text
                .attr("x", function (d) { return d.posx + 15; })
                .attr("y", function (d) { return d.posy + 5; })
                .text(function (d) { return d.label; });



            //////


                function zoomed() {
                    g.attr('transform', 'translate(' + d3.event.transform.x + ',' + d3.event.transform.y + ') scale(' + d3.event.transform.k + ')');
                    currentscale = d3.event.transform.k;
                };

                if (currentscale != "") {
                    svg.transition()
                          .delay(100)
                          .duration(700)
                          .call(zoom.scaleTo, currentscale);

                }

                function transition(zoomLevel) {
                    svg.transition()
                        .delay(100)
                        .duration(700)
                        .call(zoom.scaleBy, zoomLevel);
                }

                d3.selectAll('button').on('click', function () {
                    if (this.id === 'zoom_in') {
                        transition(1.2); // increase on 0.2 each time
                    }
                    if (this.id === 'zoom_out') {
                        transition(0.8); // deacrease on 0.2 each time
                    }
                    if (this.id === 'zoom_init') {
                        svg.transition()
                            .delay(100)
                            .duration(700)
                            .call(zoom.scaleTo, 1.5); // return to initial state
                    }
                    if (this.id === 'btnresize') {
                        //$('#maindivGraph').toggleClass('col-md-9 ml-sm-auto col-lg-10').toggleClass('col-md-12 ml-sm-auto col-lg-12');
                        //$('#seconddivgraph').toggle();
                        if (sizetoggle == 0) {
                            $('#connectionMatrix').css("height", "90%");
                            $('.row').css("width", "100%");
                            $('#connForcelay').css("height", "1100px");
                            //$('#maindivGraph').removeClass('col-md-9 ml-sm-auto col-lg-10').addClass('col-md-12 ml-sm-auto col-lg-12').addClass("important");
                            //$('#seconddivgraph').hide();
                            $('#clientconnectionHelp').hide();
                            $('#showhideNav').hide();
                            $('#seconddivgraph').css({ 'margin-top': '0px' });
                            sizetoggle = 1;
                        }
                        else {
                            $('#connectionMatrix').css("height", "75%");
                            $('#connForcelay').css("height", "800px");
                            $('#clientconnectionHelp').show();
                            $('#showhideNav').show();
                            $('#seconddivgraph').css({ 'margin-top': '65px' });

                            //$('#maindivGraph').removeClass('col-md-12 ml-sm-auto col-lg-12').addClass('col-md-9 ml-sm-auto col-lg-10').addClass("important");
                            //$('#seconddivgraph').show();
                            //InitializeHomeButtonClick();
                            sizetoggle = 0;
                        }
                    }
                });

                var color = d3.scaleOrdinal(d3.schemeCategory20);


                var simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(function (d) { return d.id; }).distance(function (d, i) { return 20 + i }))
                    .force("charge", d3.forceManyBody().strength(-120))
                    .force("center", d3.forceCenter(width / 2, height / 2));


                var link = g.append("g")
                    .attr("class", "links")
                  .selectAll("line")
                  .data(Opportunitynodelink.links)
                  .enter().append("line")
                    .style("stroke-dasharray", (0, function (d) {
                        if (d.value == 1) {
                            return 3;
                        }
                        else { return 0; }
                    }))
                    .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

                var node = g.append("g")
                   .attr("class", "nodes")
                 .selectAll("circle")
                 .data(Opportunitynodelink.nodes)
                 .enter().append("g")
                 .on('dblclick', releasenode)
                 .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                var circle = node.append("circle")
                    .attr("r", function (d) { return d.rad; })
                    .attr("fill", function (d) { return GetNodeBackGrdClr(d, color) })
                    .style("stroke", function (d) { return GetNodeBackGrdClr(d, color) })
                    .style("stroke-width", 1)
                 .on("click", function (d) {
                     tooltip.style("visibility", "hidden");
                     getDataforOpportunity(d.userid, d.id,d.name);
                 })
                 .on("mouseover", function (d) {
                     connectedNodes(d);
                     var tooltipcontent = getToolTipsForOpportunities(d);
                     tooltip.html(tooltipcontent);
                     return tooltip.style("visibility", "visible");
                 })
              .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
              .on("mouseout", function (d) {
                  removehighlighting(d);
                  return tooltip.style("visibility", "hidden");
              });

                // add circle clip
                var clipPath = node.append("clipPath")
                                            .attr("id", function (d, i) {
                                                return "clipCircle_" + i
                                            })
                                            .append("circle")
                                            .attr("r", function (d) { return d.rad });


                var tooltip = d3.select("body")
         .append("div")
         .style("position", "absolute")
         .style("z-index", "12")
         .style("visibility", "hidden")
         .style("background", "#5C9BD1")
         .style("color", "white")
         .style("padding", "5px")
         .style("margin", "2px")
         .style("font-size", "12px")
         .style("box-shadow", "0px 5px 15px 0px rgba(0,0,0,0.3)")
         .text("a simple tooltip");

                var image = node.append('svg:image').attr('class', 'entityImage').attr('xlink:href', function (d) {
                    if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                        return d.imageUrl;
                    }
                    else {
                        return '../../arup_/Images/Contact.png';
                    }
                })
                .attr('width', function (d) {
                    if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                        return d.rad * 3;
                    }
                    else {
                        return d.rad + d.rad * .1;
                    }
                })
                .attr('height', function (d) {
                    if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                        return d.rad * 3;
                    }
                    else {
                        return d.rad + d.rad * .1;
                    }
                })
                .attr("clip-path", function (d, i) { return "url(#clipCircle_" + i + ")" })
                 .on("click", function (d) {
                     tooltip.style("visibility", "hidden");
                      getDataforOpportunity(d.userid, d.id,d.name);
                 })
                 .on("mouseover", function (d) {
                     connectedNodes(d);
                     var tooltipcontent = getToolTipsForOpportunities(d);
                     tooltip.html(tooltipcontent);
                     return tooltip.style("visibility", "visible");
                 })
              .on("mousemove", function () { return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); })
              .on("mouseout", function (d) {
                  removehighlighting(d)
                  return tooltip.style("visibility", "hidden");
              });

                var nodeText = node.append('svg:text').attr('class', 'nodetext').text(function (d) {
                    var name = d.NodeName.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                    if (name.length > 35) {
                        name = name.substring(0, 35) + "...";
                    }
                    if (isManagedClient) {
                        if (d.id == relationshipManager) {
                            return name + " (RM)";
                        }
                        else if (relTeamMembers.indexOf(d.id) > -1) {
                            return name + " (RT)";
                        }
                        else {
                            return name;
                        }
                    }
                    return name;
                }).style("text-anchor", "middle");

                //var title = node.append("title")
                //     .text(function (d) { return d.id; });

                simulation
                    .nodes(Opportunitynodelink.nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(Opportunitynodelink.links);

                function ticked() {
                    link
                        .attr("x1", function (d) { return d.source.x; })
                        .attr("y1", function (d) { return d.source.y; })
                        .attr("x2", function (d) { return d.target.x; })
                        .attr("y2", function (d) { return d.target.y; });

                    circle
                        .attr("cx", function (d) { return d.x; })
                        .attr("cy", function (d) { return d.y; });

                    clipPath
                        .attr("cx", function (d) { return d.x; })
                        .attr("cy", function (d) { return d.y; });

                    image
                        .attr("x", function (d) {
                            if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                                return d.x - d.rad - d.rad * .5;
                            }
                            else {
                                return d.x - d.rad + d.rad * .45;
                            }
                        })
                        .attr("y", function (d) {
                            if (d.imageUrl != GetGlobalContext().getClientUrl()) {
                                return d.y - d.rad - d.rad * .5;
                            }
                            else {
                                return d.y - d.rad + d.rad * .45;
                            }

                        });


                    nodeText
                        .attr("dx", function (d) { return d.x - function (d) { return d.name.normalize('NFD').replace(/[\u0300-\u036f]/g, "") }.length / 2 * 3; })
                        .attr("dy", function (d) {
                            if (d.group == 1) {
                                return d.y - 11;
                            }
                            else if (d.group == 2) {
                                return d.y - 8;
                            }
                            else if (d.group == 6) {
                                return d.y - 11;
                            }
                            else if (d.group == 8) {
                                return d.y - 15;
                            }
                            else {
                                return d.y - 8;
                            }
                        })
                     .attr("width", "50");
                }


                function dragstarted(d) {
                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(d) {
                    d.fx = d3.event.x;
                    d.fy = d3.event.y;
                }

                function dragended(d) {
                    if (!d3.event.active) simulation.alphaTarget(0);
                    //d.fx = null;
                    //d.fy = null;
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function releasenode(d) {
                    //d.fx = false; // of course set the node to fixed so the force doesn't include the node in its auto positioning stuff
                    //force.resume();
                    if (!d3.event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }

            ////////////////////////////////////////////////////////////////////////////////

                function connectedNodes(d) {
                    var connectedlinks = link.filter(function (e) {
                        //return e.source.id == d.id || e.target.id == d.id; //connected links
                        if (e.source.id == d.id || e.target.id == d.id) {
                            node.filter(function (k) {
                                var res1 = k.id.split(":");
                                var res2 = d.id.split(":");
                                if (res2.length > 1)
                                {

                                }
                                else
                                return k.id != d.id;
                            }).style('stroke-opacity', 0.1);
                            node.filter(function (p) {
                                var res1 = p.id.split(":");
                                var res2 = d.id.split(":");
                                if(res2.length > 1)
                                return res1[0] == res2[0];
                            }).style('stroke-width', 1).style('stroke', 'red').style('r', 8);
                            return d.id;
                        }
                    }).style('stroke', 'red')
                      .attr('r', 15);


                    var disconnectedlinks =
                         link.filter(function (e) {
                             return e.source.id != d.id && e.target.id != d.id; //disconnected links
                         }).style('stroke-opacity', 0.1)
                      .attr('r', 15);
                }
                function removehighlighting(d) {
                    var connectedlinks = link.filter(function (e) {
                        if (e.source.id == d.id || e.target.id == d.id) { //connected links
                            node.filter(function (k) {
                                return k.id != d.id;
                            }).style('stroke-opacity', 0.6);
                            node.filter(function (p) {
                                var res1 = p.id.split(":");
                                var res2 = d.id.split(":");
                                if (res2.length > 1)
                                return res1[0] == res2[0];
                            }).style('stroke-width', 0).style('stroke', 'black');
                            return d.id;
                        }
                    }).style('stroke', '#999')
                             .attr('r', 15)

                    var disconnectedlinks =
                      link.filter(function (e) {
                          return e.source.id != d.id && e.target.id != d.id; //disconnected links
                      }).style('stroke-opacity', 0.6)
                   .attr('r', 15);

                }
            /////////////////////////////////////////////////////
            }

        function NodesOrgOpportunities(curaccId, conData, showBidTeams)
        {

            // var nodelink = Opportunitynodelink;
            //  nodelink.nodes.push({ id: curaccId, name: curaccName, NodeName: curaccName, group: 1, rad: 10, imageUrl: '../../arup_/Images/AccountFolder.png', phone: "", jobtitleorCountry: "", userid: "100" });
            var Opportunitydata = d3.nest()
                            .key(function (d) { return d['Opportunityid']; })
                            .entries(conData);
            var bidmanager = d3.nest()
                            .key(function (d) { return d['bidmanager_userid']; })
                            .entries(conData);
            var biddirector = d3.nest()
                           .key(function (d) { return d['biddirector_userid']; })
                           .entries(conData);
            var bidreviewchair = d3.nest()
                           .key(function (d) { return d['bidreviewchair_userid']; })
                           .entries(conData);
            var projectdirector = d3.nest()
                           .key(function (d) { return d['projectdirector_userid']; })
                           .entries(conData);
            var projectmanager = d3.nest()
                           .key(function (d) { return d['projectmanager_userid']; })
                           .entries(conData);
            var businessadministrator = d3.nest()
                           .key(function (d) { return d['businessadministrator_userid']; })
                           .entries(conData);
            var commercialmanager = d3.nest()
                           .key(function (d) { return d['commercialmanager_userid']; })
                           .entries(conData);
            var aruplocalcontact = d3.nest()
                           .key(function (d) { return d['aruplocalcontact_userid']; })
                           .entries(conData);
            var clientcontact = d3.nest()
                           .key(function (d) { return d['clientcontact_userid']; })
                           .entries(conData);

            Opportunitydata.forEach(function (ac, i) {
                Opportunitynodelink.nodes.push({
                    id: ac.key, group: 2, rad: 7, imageUrl: '../../arup_graphOpportunities', empstatus: "", name: ac.values[0].OpportunityName
                    , NodeName: ac.values[0].OpportunityName, phone: "", jobtitleorCountry: "", userid: "600"
                    ,OpptyStatus : ac.values[0].Opportunitystatus, OpptyBusiness : ac.values[0].OpportunityBusiness
                    , OpptyFees: ac.values[0].OpportunityFees, OpptyInternal: ac.values[0].OpportunityInternal
                });
                Opportunitynodelink.links.push({ source: curaccId, target: ac.key, value: 2 });
            })
            if (showBidTeams)
            {
            bidmanager.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].bidmanager_image,
                name: ac.values[0].bidmanager_name, NodeName: ac.values[0].bidmanager_name + " (BM)", jobtitleorCountry: "Bid Manager", userid: "700",
                phone : ac.values[0].bidmanager_Phone,
                companycode : "",
                region :ac.values[0].bidmanager_Region,
                jobtitle :ac.values[0].bidmanager_Title,
                accountcode : ac.values[0].bidmanager_AccountingCode
            });
            }
            })
                conData.forEach(function (cc, i) {
                    if (cc['bidmanager_userid'] != "") {
                        Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['bidmanager_userid'], value: 1 });
                    }
                })

            biddirector.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].biddirector_image,
                        name: ac.values[0].biddirector_name, NodeName: ac.values[0].biddirector_name + " (BD)",  jobtitleorCountry: "Bid Director", userid: "700",
                        phone: ac.values[0].biddirector_Phone,
                        companycode: "",
                        region: ac.values[0].biddirector_Region,
                        jobtitle: ac.values[0].biddirector_Title,
                        accountcode: ac.values[0].biddirector_AccountingCode
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['biddirector_userid'] != "") {
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['biddirector_userid'], value: 1 });
                }
            })

            bidreviewchair.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].bidreviewchair_image,
                        name: ac.values[0].bidreviewchair_name, NodeName: ac.values[0].bidreviewchair_name + " (BRC)",  jobtitleorCountry: "Bid Review Chair", userid: "700"
                        , phone: ac.values[0].bidreviewchair_Phone,
                        companycode: "",
                        region: ac.values[0].bidreviewchair_Region,
                        jobtitle: ac.values[0].bidreviewchair_Title,
                        accountcode: ac.values[0].bidreviewchair_AccountingCode
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['bidreviewchair_userid'] != "")
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['bidreviewchair_userid'], value: 1 });
            })

            projectdirector.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].projectdirector_image,
                        name: ac.values[0].projectdirector_name, NodeName: ac.values[0].projectdirector_name + " (PD)", jobtitleorCountry: "Project Director", userid: "700"
                         , phone: ac.values[0].projectdirector_Phone,
                         companycode: "",
                         region: ac.values[0].projectdirector_Region,
                         jobtitle: ac.values[0].projectdirector_Title,
                         accountcode: ac.values[0].projectdirector_AccountingCode
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['projectdirector_userid'] != "")
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['projectdirector_userid'], value: 1 });
            })

            projectmanager.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].projectmanager_image,
                        name: ac.values[0].projectmanager_name, NodeName: ac.values[0].projectmanager_name + " (PM)",  jobtitleorCountry: "Project Manager", userid: "700"
                            , phone: ac.values[0].projectmanager_Phone,
                            companycode: "",
                            region: ac.values[0].projectmanager_Region,
                            jobtitle: ac.values[0].projectmanager_Title,
                            accountcode: ac.values[0].projectmanager_AccountingCode
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['projectmanager_userid'] != "")
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['projectmanager_userid'], value: 1 });
            })

            businessadministrator.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].businessadministrator_image,
                        name: ac.values[0].businessadministrator_name, NodeName: ac.values[0].businessadministrator_name + " (BA)",  jobtitleorCountry: "Business Administrator", userid: "700"
                            , phone: ac.values[0].businessadministrator_Phone,
                            companycode: "",
                            region: ac.values[0].businessadministrator_Region,
                            jobtitle: ac.values[0].businessadministrator_Title,
                            accountcode: ac.values[0].businessadministrator_AccountingCode
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['businessadministrator_userid'] != "")
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['businessadministrator_userid'], value: 1 });
            })

            commercialmanager.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].commercialmanager_image,
                        name: ac.values[0].commercialmanager_name, NodeName: ac.values[0].commercialmanager_name + " (CM)",  jobtitleorCountry: "Commercial Manager", userid: "700"
                          , phone: ac.values[0].commercialmanager_Phone,
                          companycode: "",
                          region: ac.values[0].commercialmanager_Region,
                          jobtitle: ac.values[0].commercialmanager_Title,
                          accountcode: ac.values[0].commercialmanager_AccountingCode
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['commercialmanager_userid'] != "")
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['commercialmanager_userid'], value: 1 });
            })

            aruplocalcontact.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 6, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].aruplocalcontact_image,
                        name: ac.values[0].aruplocalcontact_name, NodeName: ac.values[0].aruplocalcontact_name + " (ALC)", jobtitleorCountry: "Arup Local Contact", userid: "700"
                          , phone: ac.values[0].aruplocalcontact_Phone,
                          companycode: "",
                          region: ac.values[0].aruplocalcontact_Region,
                          jobtitle: ac.values[0].aruplocalcontact_Title,
                          accountcode: ac.values[0].aruplocalcontact_AccountingCode
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['aruplocalcontact_userid'] != "")
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['aruplocalcontact_userid'], value: 1 });
            })

            clientcontact.forEach(function (ac, i) {
                if (ac.key != "") {
                    Opportunitynodelink.nodes.push({
                        id: ac.key, group: 3, rad: 4, imageUrl: GetGlobalContext().getClientUrl() + ac.values[0].clientcontact_image,
                        name: ac.values[0].clientcontact_name, NodeName: ac.values[0].clientcontact_name + " (CC)", phone: ac.values[0].clientcontact_phone, jobtitleorCountry: "Client Contact", userid: "700"
                         , phone: "",
                        companycode: "",
                        region: "",
                        jobtitle: "",
                        accountcode: ""
                    });
                }
            })
            conData.forEach(function (cc, i) {
                if (cc['clientcontact_userid'] != "")
                    Opportunitynodelink.links.push({ source: cc['Opportunityid'], target: cc['clientcontact_userid'], value: 1 });
            })
        }
        }
        function getToolTipsForOpportunities(d) {
            var tooltipcontent = "";
            if (d.userid == "100") {
                // organisations
                tooltipcontent += d.name;
                if (d.orgDepartment != "")
                    tooltipcontent += "<br/>" + d.orgDepartment;
                if (d.orgTownCity != "")
                    tooltipcontent += "<br/>" + d.orgTownCity;
                if (d.orgOpenOpptys != "")
                    tooltipcontent += "<br/> Open Opps : " + d.orgOpenOpptys;
            }
            else if(d.userid == "600")
            {
                tooltipcontent += d.name;
                tooltipcontent += "<br/>" + d.OpptyFees + " | " + d.OpptyBusiness + " | " + d.OpptyStatus

            }
            else {
                //users
                tooltipcontent += d.name + " | " + d.jobtitleorCountry + "<br/>";
                if (d.jobtitle != "")
                    tooltipcontent += "<br/>" + d.jobtitle
                if (d.accountcode != "" || d.region != "")
                    tooltipcontent += "<br/>" + d.accountcode + " | " + d.region;
                if (d.phone != "" )
                    tooltipcontent += "<br/>" + d.phone;
            }

            return tooltipcontent;

        }
        function getToolTipsForConnectionMarketingLists(d) {
            var tooltipcontent = "";
             if (d.userid == "200") {
                //contacts
                tooltipcontent += d.name;
                if (d.jobtitleorCountry != "")
                    tooltipcontent += "<br/>" + d.jobtitleorCountry;
                if (d.contactDepartment != "") {
                    tooltipcontent += "<br/>" + d.contactDepartment;
                }
                else {
                    if (d.contactEmail != "")
                        tooltipcontent += "<br/>" + d.contactEmail;
                }
             }
             else if (d.userid == "500") {
                 // activities
                 tooltipcontent += d.name;
                 if (d.activityowner != "")
                     tooltipcontent += "<br/>" + d.activityowner;
                 if (d.activityduedate != "") {
                     tooltipcontent += "<br/> Due Date : " + d.activityduedate;
                 }
                 if (d.activitypriority != "") {
                     tooltipcontent += "<br/> " + d.activitypriority + " | " + d.activitystatus;
                 }


             }
            else {
                 //Marketinglist
                tooltipcontent += d.name;
                if (d.MLCampaign != "")
                    tooltipcontent += "<br/>" + d.MLCampaign ;
                if (d.MLOwner!= "")
                    tooltipcontent += "<br/>" + d.MLOwner + " | " + d.MLOffice;
            }

            return tooltipcontent;

        }
        function getToolTipsForConnection(d)
        {
            var tooltipcontent = "";
            if (d.userid == "100" || d.userid =="1000")
            {
                // organisations
                tooltipcontent += d.name;
                if(d.orgDepartment != "")
                    tooltipcontent += "<br/>" + d.orgDepartment;
                if(d.orgTownCity != "")
                    tooltipcontent += "<br/>" + d.orgTownCity;
                if(d.orgOpenOpptys != "")
                    tooltipcontent += "<br/> Open Opps : " + d.orgOpenOpptys;
            }
            else if (d.userid == "200")
            {
                //contacts
                tooltipcontent += d.name;
                if(d.jobtitleorCountry != "")
                    tooltipcontent += "<br/>" + d.jobtitleorCountry;
                if (d.contactDepartment != "") {
                    tooltipcontent += "<br/>" + d.contactDepartment;
                }
                else {
                    if (d.contactEmail != "")
                        tooltipcontent += "<br/>" + d.contactEmail;
                }
            }
            else {
                //users
                if (d.empstatus != undefined && d.empstatus != null && d.empstatus == '770000001') {
                    tooltipcontent += d.name + " | Ex-Employee";
                    if (d.userTitle != "")
                        tooltipcontent += "<br/>" + d.userTitle;
                    if (d.userAccountingCode != "")
                        tooltipcontent += "<br/>" + d.userCompanyCode + "-" + d.userAccountingCode + " | " + d.userRegion;
                }
                else {
                    tooltipcontent += d.name;
                    if (d.userTitle != "")
                        tooltipcontent += "<br/>" + d.userTitle
                    if (d.userAccountingCode != "")
                        tooltipcontent += "<br/>" + d.userCompanyCode + "-" + d.userAccountingCode + " | " + d.userRegion;
                    if (d.phone != "" || d.userRegion != "")
                        tooltipcontent += "<br/>" + d.phone;
                }




              }

            return tooltipcontent;

        }
        function InitializeHomeButtonClick() {
            $('#homeButton').on('click', function () {
                var selection = $("input[name='RadOrg']:checked").val();
                $('#chkShowAllConnectionsforUser').prop('checked', false);
                $("#Userfilters").hide();
                if (selection == "O") {
                    $('#chkDecisonMaker').prop('checked', false);
                    $('#chkShowBidTeam').prop('checked', false);
                    $('#chkShowInternal').prop('checked', false);
                    $('#chkShowInternal').prop('disabled', false);
                    currentorgid = "";
                    currentorgname = "";
                    currentOpportunityid = "";
                    currentselectedUserid = "";
                    OpportunityMatrix();
                    $('#chkDecisonMaker').prop('disabled', true);
                    $('input[name="opportunitystatus"]').prop('disabled', false);
                    $('#chkShowBidTeam').prop('disabled', false);
                    $("input[name=opportunitystatus]").prop("checked", false);
                }
                else {
                    $('#chkShowBidTeam').prop('checked', false);
                    $('#chkDecisonMaker').prop('checked', false);
                    $('#chkShowBidTeam').prop('disabled', true);
                    $('#chkShowInternal').prop('disabled', true);
                    $('input[name="opportunitystatus"]').prop('disabled', true);
                    PopulateConnection(true, true, true, true, true);
                    $('#chkDecisonMaker').prop('disabled', false);
                }
            });


            $('#print').on('click', function () {
                debugger;


                var title = "Connection Matrix";
                var mywindow = window.open('', 'PRINT', "width=1200%,height=800px");
                mywindow.document.write('<html><head><title>' + title + '</title>');
                mywindow.document.write("</head><body style='background:none !important; margin-left:-0px;font-size:6pt !important' >");

                var htmlcontent = document.getElementById("connectionMatrix").innerHTML;
                mywindow.document.write(htmlcontent);
                mywindow.document.write('</body></html>');
               // mywindow.focus();

               // myWindow.resizeBy(-300, -300);
                mywindow.document.close(); // necessary for IE >= 10
                mywindow.focus(); // necessary for IE >= 10*/
                mywindow.print();
                mywindow.close();
                return true;
            });

            var angle = 0;
            //$('#ButtonRotate').on('click', function () {
            //    angle += 90;
            //    debugger;
            //    $("#connForcelay").animate({
            //        transform: "r" + angle + ",400,250"
            //    }, 500);

            //});

        }
        $("#chkMarketingList").change(function () {
            if (ConnectionContactData != "") {
               var chkAct =  $("#chkContactActivities").is(':checked') ? true : false;
               InititializeGraphDivs();
                InitializeHomeButtonClick();
                if (this.checked) {
                    DrawMatrixForceLayoutContacts("#connectionMatrix", ConnectionContactData,true, chkAct);
                }
                else {
                    DrawMatrixForceLayoutContacts("#connectionMatrix", ConnectionContactData,false, chkAct);
                }
            }
        });

        $("#chkShowAllConnectionsforUser").change(function () {
            InititializeGraphDivs();
                InitializeHomeButtonClick();
                if (this.checked) {
                    PopulateConnectionForuser(currentselectedUserid, false);
                }
                else {
                    PopulateConnectionForuser(currentselectedUserid);
                }

        });
        $("#chkContactActivities").change(function () {
            if (ConnectionContactData != "") {
                var chkAct = $("#chkMarketingList").is(':checked') ? true : false;
                InititializeGraphDivs();
                InitializeHomeButtonClick();
                if (this.checked) {
                    DrawMatrixForceLayoutContacts("#connectionMatrix", ConnectionContactData, chkAct, true);
                }
                else {
                    DrawMatrixForceLayoutContacts("#connectionMatrix", ConnectionContactData, chkAct, false);
                }
            }
        });
        $("input[name='opportunitystatus']").change(function () {
            var selection = $(this).val();
            var chkShowBidTeam = $("#chkShowBidTeam").is(':checked') ? true : false;
            var chkShowInternal = $("#chkShowInternal").is(':checked') ? true : false;
            OpportunityMatrix(currentorgid, currentorgname, currentOpportunityid, chkShowBidTeam, selection, chkShowInternal);
        });
        $("input[name='RadOrg']").change(function () {
                var selection = $(this).val();
                if (selection == "O") {
                    $('#chkDecisonMaker').prop('checked', false);
                    //$('#chkInfluencer').prop('checked', false);
                    //$('#chkEmployee').prop('checked', false);
                    //$('#chkOthers').prop('checked', false);

                    //  PopulateOpportunities();
                    currentorgid = "";
                    currentorgname = "";
                    currentOpportunityid = "";
                    OpportunityMatrix();
                    $('#chkDecisonMaker').prop('disabled', true);
                    $('input[name="opportunitystatus"]').prop('disabled', false);
                    $('#chkShowBidTeam').prop('disabled', false);
                    $('#chkShowInternal').prop('disabled', false);
                    $("input[name=opportunitystatus]").prop("checked", false);
                    //$('#chkInfluencer').prop('disabled', true);
                    //$('#chkEmployee').prop('disabled', true);
                    //$('#chkOthers').prop('disabled', true);
                }
                else {
                    // $('#chkDecisonMaker').prop('checked', true);
                    //$('#chkInfluencer').prop('checked', true);
                    //$('#chkEmployee').prop('checked', true);
                    //$('#chkOthers').prop('checked', true);
                    $('#chkShowBidTeam').prop('checked', false);
                    $('#chkShowBidTeam').prop('disabled', true);
                    $('#chkShowInternal').prop('checked', false);
                    $('#chkShowInternal').prop('disabled', true);
                    $('input[name="opportunitystatus"]').prop('disabled', true);
                    PopulateConnection(true, true, true, true, true);
                    $('#chkDecisonMaker').prop('disabled', false);
                    //$('#chkInfluencer').prop('disabled', false);
                    //$('#chkEmployee').prop('disabled', false);
                    //$('#chkOthers').prop('disabled', false);
                }
            });
        $("#chkDecisonMaker").change(function () {
                if (this.checked) {
                    PopulateConnection(true, false, false, false, false);
                }
                else {
                    PopulateConnection(true, true, true, true, true);
                }
            });
        $("#chkShowBidTeam").change(function () {
            var statusvalue = $("input[name='opportunitystatus']:checked").val();
            var chkShowInternal = $("#chkShowInternal").is(':checked') ? true : false;
                if (this.checked) {
                    OpportunityMatrix(currentorgid, currentorgname, currentOpportunityid, true, statusvalue,chkShowInternal);
                }
                else {
                    OpportunityMatrix(currentorgid, currentorgname, currentOpportunityid, false, statusvalue, chkShowInternal);
                }
        });

        $("#chkShowInternal").change(function () {
            var statusvalue = $("input[name='opportunitystatus']:checked").val();
            var showbidteams = $("#chkShowBidTeam").is(':checked') ? true : false;
            if (this.checked) {
                OpportunityMatrix(currentorgid, currentorgname, currentOpportunityid, showbidteams, statusvalue,"1");
            }
            else {
                OpportunityMatrix(currentorgid, currentorgname, currentOpportunityid, showbidteams, statusvalue,"");
            }
        });

    </script>

</body>
</html>