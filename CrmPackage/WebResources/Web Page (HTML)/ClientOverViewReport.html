<html><head><meta><meta><meta><meta><meta><title>	CRM Report - Client Overview Report</title></head><body style="width: 1050px; -webkit-print-color-adjust: exact; word-wrap: break-word;" onload="OnLoad()" onfocusout="parent.setEmailRange();">﻿


    <meta charset="utf-8">
    <script src="../../ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="../../ccrm_/JavaScripts/D3V4.js"></script>
    <script src="../../ccrm_/JavaScripts/Lib/jquery_3.2.0.min"></script>


    <style>
        #top10OpenOportunities table {
            width: 100%;
        }

        #leadsList table {
            width: 100%;
        }

        #childorganizations table {
            width: 100%;
        }

        #top5WonOpps {
            width: 100%;
        }

            #top5WonOpps table {
                width: 100%;
            }

        #recentActivities table {
            width: 100%;
        }

        #pastActivities table {
            width: 100%;
        }

        #recentNotes table {
            width: 100%;
        }

        #connectionMatrix table {
            width: 100%;
        }

        #top5BidLossReason div {
            width: 100%;
        }

        bidHistory div {
            width: 100%;
        }

        .arc text {
            font: 10px sans-serif;
            text-anchor: middle;
        }

        .arc path {
            stroke: #fff;
        }

        .bar rect {
            /* fill: steelblue; */
        }

        .bar text {
            fill: black;
            font: 10px sans-serif;
            text-anchor: start;
        }

        div {
            background-color: #f2f2f2;
            float: left;
        }

        #OpportunityForAccChart {
            width: 450px;
            height: 200px;
        }

        #OpenOpportunityChart {
            width: 580px;
            height: 200px;
        }

        .axis .domain {
            display: none;
        }

        body {
            font: 10px sans-serif;
        }

        table {
            font: inherit;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        /*.bar {
            fill: steelblue;
        }*/

        .x.axis path {
            display: none;
        }

        .print {
            width: 90px;
            background-color: rgb(77, 144, 254);
            background-image: linear-gradient(to bottom, rgb(77, 144, 254), rgb(71, 135, 237));
            border: 1px solid rgb(48, 121, 237);
            color: #fff;
            vertical-align: middle;
            text-shadow: 0 1px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .printimg {
            color: #fff;
            vertical-align: middle;
            text-shadow: 0 1px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }
    </style>



    <table style="WIDTH:100%">
        <tbody>
            <tr>
                <td>
                    <table>
                        <tbody>
                            <tr style="margin-bottom:140px;">
                                <td id="accountName" style="font-weight:bold;font-size:18pt;"></td>

                            </tr>
                            <tr></tr>
                            <tr>
                                <td style="width: 930px;font-style: normal; font-family: 'Times New Roman'; font-size: 12pt; font-weight: 400;"><div id="currencytext">ORGANISATION OVERVIEW </div></td>
                                <td style="width: 111px;">
                                    <div>
                                        <input type="image" src="../../ccrm_/Images/Print_ico_16.gif" onclick="window.print()" class="printimg">
                                        <input type="button" class="print" value="Print Report" onclick="window.print()">
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>

            </tr>
        </tbody>
    </table>
    <table style="width:100%">
        <tbody>
            <tr>
                <td>
                    <table style="background-color: lightgray; font-size: 10pt; font-family: Arial;">
                        <tbody>
                            <tr height="0">
                                <td style="WIDTH:10%"></td>
                                <td style="WIDTH:18%"></td>
                                <td style="WIDTH:12%"></td>
                                <td style="WIDTH:12%"></td>
                                <td style="WIDTH:12%"></td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold">Website:</td>
                                <td id="website"></td>
                                <td style="font-weight:bold">Relationship Manager:</td>
                                <td id="relationshipmanager"></td>
                                <td style="font-weight:bold">Parent Organization:</td>
                                <td id="parentOrg"></td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold">Relationship Team:</td>
                                <td id="relationshipteam"></td>
                                <td style="font-weight:bold">Phone Number:</td>
                                <td id="phonenum"></td>
                                <td style="font-weight:bold">Address:</td>
                                <td id="address"></td>
                            </tr>
                        </tbody>
                    </table>

                </td>
            </tr>
        </tbody>
    </table>
    <table style="width:100%">
        <tbody>
            <tr>
                <td style="border-bottom:2pt solid black;">CLIENT TYPE</td>
                <td style="border-bottom:2pt solid black;">CLIENT SECTORS</td>
                <td style="border-bottom:2pt solid black;">DESCRIPTION/SUMMARY</td>
            </tr>
            <tr>
                <td id="clientType" style="background-color:lightgray"></td>
                <td id="clientSector" style="background-color:lightgray"></td>
                <td id="clientDesc" style="background-color:lightgray"></td>
            </tr>
        </tbody>
    </table>
    <table style="width:100%">
        <tbody>
            <tr>
                <td style="vertical-align:top;">
                    <table>
                        <tbody>
                            <tr>
                                <td style="height:25px;border-bottom: 2pt solid Black; font-weight:bold;">
                                    <span>RELATIONSHIP TEAM</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="relationshipTeamMembers"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
                <td style="vertical-align:top;">
                    <table>
                        <tbody>
                            <tr>
                                <td style="height:25px;border-bottom: 2pt solid Black; font-weight:bold;">
                                    <span style="margin-right:10px;font-weight:bold;">
                                        CHILD ORGANISATIONS <a id="childOrgs">
                                            <span>Click here to see all child records</span>
                                        </a>
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="childorganizations" style="width:100%"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
                <td style="vertical-align:top;">
                    <table style="width:100%;">
                        <tbody>
                            <tr>
                                <td style="height:25px;border-bottom: 2pt solid Black; font-weight:bold;">
                                    <div>
                                        <span style="margin-right:10px;font-weight:bold;">5 MOST RECENT WINS</span><span id="top5OppWonCnt"></span><span>
                                            <a id="recentWins">
                                                <span>Click here to see all child records, Opportunities and Contacts</span>
                                            </a>
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="top5WonOpps"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
    <table style="width:100%">
        <tbody>
            <tr>
                <td>
                    <table style="width:100%">
                        <tbody>
                            <tr>
                                <td>
                                    <b> OPEN OPPORTUNITIES </b>
                                </td>

                            </tr>
                            <tr>
                                <td>
                                    Illustration of the value of Opportunities associated to this Organisation and in the Organisation's wider hierarchy. Hover over the pie chart for more details.
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="OpportunityForAccChart"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>

                <td>
                    <table style="width:100%">
                        <tbody>
                            <tr>
                                <td>
                                    <b>  FORECAST WORK </b>
                                </td>
                            </tr>
                            <tr>

                                <td style="height: 24px;vertical-align: top;">
                                    The value of active Opportunities associated with this Organisation by phase. Hover over the bar chart for more details.
                                </td>
                            </tr>
                            <tr>

                                <td style="width:50%;">
                                    <div id="OpenOpportunityChart" style="border: 1px solid gray;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
    <table style="width:100%;">
        <tbody>
            <tr style="width:100%;">
                <td style="border-bottom: 2pt solid Black; font-weight:bold;">
                    <span style="margin-right:10px;font-weight:bold;">TOP 10 OPEN OPPORTUNITIES</span>&nbsp;<span id="top10OpenOpporCnt"></span>
                    <a id="top10OpenOppList">
                        <span>Click here to view a complete list</span>
                    </a>
                </td>
            </tr>
            <tr style="width:100%;">
                <td id="top10OpenOportunities" style="width:100%;"></td>
            </tr>
        </tbody>
    </table>
    <table style="width:100%;">
        <tbody>
            <tr style="width:100%;">
                <td style="border-bottom: 2pt solid Black; font-weight:bold;">
                    <span style="margin-right:10px;font-weight:bold;">Active Leads</span>&nbsp;<span id="activeLeadsCnt"></span>
                </td>
            </tr>
            <tr style="width:100%;">
                <td id="leadsList" style="width:100%;"></td>
            </tr>
        </tbody>
    </table>
    <table style="width:100%">

        <tbody>
            <tr>
                <td><div><span style="margin-right:10px;font-weight:bold;">TOP 5 BID LOSS REASONS</span></div></td>
                <td><div><span style="margin-right:10px;font-weight:bold;">BID HISTORY</span></div></td>
            </tr>
            <tr>
                <td style="width:50%;"><div id="top5BidLossReason"></div></td>
                <td style="width:50%;"> <div id="bidHistory"></div></td>
            </tr>
        </tbody>
    </table>
    <table style="width:100%">
        <tbody>
            <tr>
                <td style="border-bottom: 2pt solid Black;">
                    <div>
                        <span style="margin-right: 10px; font-weight: bold;">CONNECTION MATRIX</span>
                        <a id="connMatrix"><span>Click here for a complete matrix</span></a>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="connectionMatrix" style="width:100%"></div>
                </td>
            </tr>

        </tbody>
    </table>
    <table style="width:100%">
        <tbody>
            <tr>
                <td style="vertical-align:top;width:33%;">
                    <table style="width:100%;">
                        <tbody>
                            <tr>
                                <td style="border-bottom: 2pt solid Black; font-weight:bold;">
                                    <span>RECENT ACTIVITIES </span><a id="recentActivis">Click here to view a complete list</a>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="recentActivities" style="width:100%"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
                <td style="vertical-align:top;width:33%;">
                    <table style="width:100%;">
                        <tbody>
                            <tr>
                                <td style="border-bottom: 2pt solid Black; font-weight:bold;">
                                    <span style="font-weight:bold;">
                                        PLANNED ACTIVITIES <a id="planedActivis">Click here to view a complete list</a>

                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="pastActivities" style="width:100%"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
                <td style="vertical-align:top;width:33%;">
                    <table style="width:100%;">
                        <tbody>
                            <tr>
                                <td style="border-bottom: 2pt solid Black; font-weight:bold;">
                                    <div>
                                        <span style="font-weight:bold;">RECENT NOTES</span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div id="recentNotes" style="width:100%"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>



    <script>
        var accId, accName, parentaccountid, clientURL, exchangeratevalue = 1, currencyname = "UK Pound Sterling", dateformat = 'dd MMM yy', currencyid = '%7bE83F8C2A-1F39-E011-8CBD-D8D385B829F8%7d';
        var data = [];
        var childOrgAccIds = [];
        var basicProfile = [];
        var childOrgs = [];


        function OnLoad() {
            //if we need to display report within form:Starts
           var queryString = location.search.substring(1);
           var params = {};
			var queryStringParts = queryString.split("&");
			for (var i = 0; i < queryStringParts.length; i++) {
				var pieces = queryStringParts[i].split("=");
				params[pieces[0]] = pieces.length == 1 ? null : decodeURIComponent(pieces[1]);
			}
            var parameters = decodeURIComponent(params.data);//GetGlobalContext().data.attributes();
            if (parameters != undefined) {
                accId = parameters.split('&')[0].split('=')[1];
                parentaccountid = parameters.split('&')[1].split('=')[1];
                clientURL = parameters.split('&')[2].split('=')[1];
                systemUser = parameters.split('&')[3].split('=')[1];
                var accounts;
                if (accId != parentaccountid) {
                    $.ajax({
                        type: "GET",
                        contentType: "application/json; charset=utf-8",
                        datatype: "json",
                        url: clientURL + "/api/data/v9.1/accounts?fetchXml=%3Cfetch%3E%3Centity%20name%3D%22account%22%20%3E%3Cattribute%20name%3D%22accountid%22%20%2F%3E%3Cfilter%3E%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22eq-or-above%22%20value%3D%224e196e94-a366-e111-b7c5-78e7d16510d0%22%20%2F%3E%3Ccondition%20attribute%3D%22parentaccountid%22%20operator%3D%22null%22%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                        beforeSend: function(XMLHttpRequest) {
                            XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                            XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                            XMLHttpRequest.setRequestHeader("Accept", "application/json");
                            XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                        },
                        async: false,
                        success: function(data, textStatus, xhr) {
                            accounts = data.value;
                        },
                        error: function(xhr, textStatus, errorThrown) {
                            var alertStrings = { confirmButtonLabel: "OK", text: textStatus, title: "Alert" };
                            var alertOptions = { height: 120, width: 260 };
                            AlertDialog( alertStrings, alertOptions);
                        }
                    });
                    if (accounts.length > 0) {
                        parentaccountid = accounts[0].accountid;
                    }
                }
            }
            else {

                accId = "29616C21-7745-E011-9CF6-78E7D16510D0";
                parentaccountid = accId;
            }

            // debugger;

            Promise.all([
                PopulateBasicAccProfile(),
                GetExchangeRate().then(() => {
                    var div = document.getElementById('currencytext');
                    div.innerHTML += '(All currencies are in ' + currencyname + ')';
                }),
                GetUserDateSettings(),
                PopulateManagingTeamMembers(),
                PopulateChildOrganizations(),
                Populate5MostRecentWins(),
                GetOpenOpportunities(),
                PopulateLeads(false),
                PopulateTop5LostOppors(),
                PopulateBidHistory(),
                PopulateRecentActivities(),
                PopulateNotes()
            ]).then(() => {
                BindSubReport();
            });
            //try {
            //    PopulateManagingTeamMembers();
            //}
            //catch (err) { }
            //try {
            //    PopulateChildOrganizations();
            //}
            //catch (err) { }
            //try {
            //    Populate5MostRecentWins();
            //}
            //catch (err) { }
            //try {
            //    GetOpenOpportunities();
            //}
            //catch (err) { }
            ////GetForCastOpportunities();}

            ////PopulateTop10OpenOppors();}
            //try {
            //    PopulateLeads(false);
            //}
            //catch (err) { }
            //try {
            //    PopulateTop5LostOppors();
            //}
            //catch (err) { }
            //try {
            //    PopulateBidHistory();
            //}
            //catch (err) { }
            //try {
            //    PopulateRecentActivities();
            //}
            //catch (err) { }
            //try {
            //    PopulateRecentActivities();
            //}
            //catch (err) { }
            //try {
            //    PopulateNotes();
            //}
            //catch (err) { }
            //try {
            //    BindSubReport();
            //}
            //catch (err) { }
        }

        function GetExchangeRate() {
            var query = "transactioncurrencies?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22true%22%20%3E%3Centity%20name%3D%22transactioncurrency%22%20%3E%3Cattribute%20name%3D%22transactioncurrencyid%22%20%2F%3E%3Cattribute%20name%3D%22exchangerate%22%20%2F%3E%3Cattribute%20name%3D%22isocurrencycode%22%20%2F%3E%3Cattribute%20name%3D%22currencyname%22%20%2F%3E%3Cattribute%20name%3D%22currencyprecision%22%20%2F%3E%3Corder%20attribute%3D%22currencyname%22%20descending%3D%22false%22%20%2F%3E%3Clink-entity%20name%3D%22ccrm_arupcompany%22%20from%3D%22ccrm_currencyid%22%20to%3D%22transactioncurrencyid%22%20alias%3D%22av%22%20%3E%3Clink-entity%20name%3D%22systemuser%22%20from%3D%22ccrm_arupcompanyid%22%20to%3D%22ccrm_arupcompanyid%22%20alias%3D%22aw%22%20%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22systemuserid%22%20operator%3D%22eq-userid%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E";
            return GetCRMData(query,
                function (fetchexchangerates ) {
                    if (fetchexchangerates.length > 0) {
                        for (var i = 0; i < fetchexchangerates.length; i++) {
                            var exchangeNode = fetchexchangerates[i];
                            if (exchangeNode.exchangerate != undefined) {
                                exchangeratevalue = exchangeNode.exchangerate;
                                currencyname = exchangeNode.currencyname;
                                currencyid = exchangeNode.transactioncurrencyid;
                            }
                        }
                    }
                },
                "Getting Exchange Rate data");
            //var fetchexchangerates;
            //$.ajax({
            //    type: "GET",
            //    contentType: "application/json; charset=utf-8",
            //    datatype: "json",
            //    url: clientURL + "/api/data/v9.1/transactioncurrencies?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22true%22%20%3E%3Centity%20name%3D%22transactioncurrency%22%20%3E%3Cattribute%20name%3D%22transactioncurrencyid%22%20%2F%3E%3Cattribute%20name%3D%22exchangerate%22%20%2F%3E%3Cattribute%20name%3D%22isocurrencycode%22%20%2F%3E%3Cattribute%20name%3D%22currencyname%22%20%2F%3E%3Cattribute%20name%3D%22currencyprecision%22%20%2F%3E%3Corder%20attribute%3D%22currencyname%22%20descending%3D%22false%22%20%2F%3E%3Clink-entity%20name%3D%22ccrm_arupcompany%22%20from%3D%22ccrm_currencyid%22%20to%3D%22transactioncurrencyid%22%20alias%3D%22av%22%20%3E%3Clink-entity%20name%3D%22systemuser%22%20from%3D%22ccrm_arupcompanyid%22%20to%3D%22ccrm_arupcompanyid%22%20alias%3D%22aw%22%20%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22systemuserid%22%20operator%3D%22eq-userid%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
            //    beforeSend: function(XMLHttpRequest) {
            //        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
            //        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
            //        XMLHttpRequest.setRequestHeader("Accept", "application/json");
            //        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //    },
            //    async: false,
            //    success: function(data, textStatus, xhr) {
            //        fetchexchangerates = data.value;
            //    },
            //    error: function (xhr, textStatus, errorThrown) {
            //        var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
            //        var alertOptions = { height: 120, width: 260 };
            //        AlertDialog( alertStrings, alertOptions);
            //    }
            //});

            //if (fetchexchangerates.length > 0) {
            //    for (var i = 0; i < fetchexchangerates.length; i++) {
            //        var exchangeNode = fetchexchangerates[i];
            //        if (exchangeNode.exchangerate != undefined) {

            //            exchangeratevalue = exchangeNode.exchangerate;
            //            currencyname = exchangeNode.currencyname;
            //            currencyid = exchangeNode.transactioncurrencyid;
            //        }
            //    }
            //}
        }

        function GetUserDateSettings() {

            return GetCRMData("usersettingscollection?fetchXml=%3Cfetch%20mapping%3D%22logical%22%20%3E%3Centity%20name%3D%22usersettings%22%20%3E%3Cattribute%20name%3D%22dateseparator%22%20%2F%3E%3Cattribute%20name%3D%22dateformatstring%22%20%2F%3E%3Cfilter%3E%3Ccondition%20attribute%3D%22systemuserid%22%20operator%3D%22eq-userid%22%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(fetchdatesettings) {
                    if (fetchdatesettings.length > 0) {
                        for (var i = 0; i < fetchdatesettings.length; i++) {
                            var datesettingNode = fetchdatesettings[i];
                            if (datesettingNode.dateformatstring != undefined) {

                                var dateseperator = datesettingNode.dateseparator;
                                dateformat = datesettingNode.dateformatstring.replace("/", dateseperator).replace("/", dateseperator);

                            }
                        }
                    }
                },
                "Get User Date Settings"
            );
            //var fetchdatesettings;
            //$.ajax({
            //    type: "GET",
            //    contentType: "application/json; charset=utf-8",
            //    datatype: "json",
            //    url: clientURL + "/api/data/v9.1/usersettingscollection?fetchXml=%3Cfetch%20mapping%3D%22logical%22%20%3E%3Centity%20name%3D%22usersettings%22%20%3E%3Cattribute%20name%3D%22dateseparator%22%20%2F%3E%3Cattribute%20name%3D%22dateformatstring%22%20%2F%3E%3Cfilter%3E%3Ccondition%20attribute%3D%22systemuserid%22%20operator%3D%22eq-userid%22%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
            //    beforeSend: function(XMLHttpRequest) {
            //        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
            //        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
            //        XMLHttpRequest.setRequestHeader("Accept", "application/json");
            //        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //    },
            //    async: false,
            //    success: function(data, textStatus, xhr) {
            //        fetchdatesettings = data.value;
            //    },
            //    error: function (xhr, textStatus, errorThrown) {
            //        var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
            //        var alertOptions = { height: 120, width: 260 };
            //        AlertDialog( alertStrings, alertOptions);
            //    }
            //});

            //if (fetchdatesettings.length > 0) {
            //    for (var i = 0; i < fetchdatesettings.length; i++) {
            //        var datesettingNode = fetchdatesettings[i];
            //        if (datesettingNode.dateformatstring != undefined) {

            //            var dateseperator = datesettingNode.dateseparator;
            //            dateformat = datesettingNode.dateformatstring.replace("/", dateseperator).replace("/", dateseperator);

            //        }
            //    }
            //}
        }

        function BindSubReport() {
            var currid = currencyid;
            var rdlName = "Record+Hierarchy+Organisation";
            var rdlID; 
            var userID = systemUser;

            var reportBaseURL = clientURL + "/crmreports/viewer/viewer.aspx?action=run&helpID=";
            var sqlreportbaseurl;
            if (clientURL.toLowerCase().includes("arupdev")) {
                sqlreportbaseurl = "https://azpsrsd365d01.global.arup.com/ReportServer/Pages/ReportViewer.aspx?/Paginated%20Reports/";
            }
            else {
                sqlreportbaseurl = "https://azpsrsd365p01.global.arup.com/ReportServer/Pages/ReportViewer.aspx?/Paginated%20Reports/";
            }
            var childOrgURL = sqlreportbaseurl + rdlName + "&recordid=" + accId + "&CRM_URL=" + crmurl + "&OrgName=" + encodeURIComponent(accName);
            var crmurl = encodeURIComponent(clientURL);
            d3.select('#childOrgs').attr('href', childOrgURL).attr('target', '_blank');

            rdlName = "Client+Overview+Won+Opportunities";
            var recentWinsURL = sqlreportbaseurl + rdlName +  "&UserId=" + userID + "&CRM_URL=" + crmurl + "&CRM_CustomerID=" + accId + "&OrgName=" + encodeURIComponent(accName) + "&CurrencyID=" + currid;
            d3.select('#recentWins').attr('href', recentWinsURL).attr('target', '_blank');

            rdlName = "Client+Overview+Open+Opportunities";
            var top10OpenOppList = sqlreportbaseurl + rdlName + "&UserId=" + userID + "&CRM_URL=" + crmurl + "&CRM_CustomerID=" + accId + "&OrgName=" + encodeURIComponent(accName) + "&CurrencyID=" + currid;
            d3.select('#top10OpenOppList').attr('href', top10OpenOppList).attr('target', '_blank');

            rdlName = encodeURIComponent("Client Activities Sub-Report.rdl");
            rdlID = "%7b" + encodeURIComponent("8D4E3BA7-0306-E511-940D-005056B5174A") + "%7d";
            var recentActivis = reportBaseURL + rdlName + "&id=" + rdlID + "&p:CRM_CustomerID=" + accId + "&p:ReturnPastActivities=true";
            var planedActivis = reportBaseURL + rdlName + "&id=" + rdlID + "&p:CRM_CustomerID=" + accId + "&p:ReturnPastActivities=false";

            d3.select('#recentActivis').attr('href', recentActivis).attr('target', '_blank');
            d3.select('#planedActivis').attr('href', planedActivis).attr('target', '_blank');

            rdlName = "Client+Overview+Complete+Matrix";
            var connMatrix = sqlreportbaseurl + rdlName + "&UserId=" + userID + "&CRM_URL=" + crmurl + "&CRM_CustomerID=" + accId + "&OrgName=" + encodeURIComponent(accName);
            d3.select('#connMatrix').attr('href', connMatrix).attr('target', '_blank');

        }

        function PopulateNotes() {
            return GetCRMData("annotations?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%20count%3D%225%22%20%3E%3Centity%20name%3D%22annotation%22%20%3E%3Cattribute%20name%3D%22annotationid%22%20%2F%3E%3Cattribute%20name%3D%22subject%22%20%2F%3E%3Cattribute%20name%3D%22annotationid%22%20%2F%3E%3Cattribute%20name%3D%22notetext%22%20%2F%3E%3Cattribute%20name%3D%22createdon%22%20%2F%3E%3Cattribute%20name%3D%22createdby%22%20%2F%3E%3Corder%20attribute%3D%22createdon%22%20descending%3D%22true%22%20%2F%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22createdbyname%22%20operator%3D%22not-like%22%20value%3D%22%25CRM%20Admin%25%22%20%2F%3E%3Ccondition%20attribute%3D%22notetext%22%20operator%3D%22not-like%22%20value%3D%22%25credit%25%22%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22accountid%22%20to%3D%22objectid%22%20alias%3D%22ab%22%20%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22eq%22%20uitype%3D%22account%22%20value%3D%22" + accId + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(notes) {
                    var noteLst = [];
                    if (notes.length > 0) {
                        for (var i = 0; i < notes.length; i++) {
                            var note = notes[i];
                            if (note.notetext != undefined && note.notetext.length > 0) {

                                var text = note.notetext;
                                var createdBy = note["_createdby_value@OData.Community.Display.V1.FormattedValue"];
                                var createdOn = note["createdon@OData.Community.Display.V1.FormattedValue"];

                                var comment = {
                                    "Note": text,
                                    "Created By": createdBy,
                                    "Created On": createdOn
                                };
                                noteLst.push(comment);
                            }
                        }
                        if (noteLst.length > 0) {
                            DrawTable("#recentNotes", noteLst, Object.keys(noteLst[0]));
                        }
                    }
                },
                "Get Notes data");
            //var notes;
            //$.ajax({
            //    type: "GET",
            //    contentType: "application/json; charset=utf-8",
            //    datatype: "json",
            //    url: clientURL + "/api/data/v9.1/annotations?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%20count%3D%225%22%20%3E%3Centity%20name%3D%22annotation%22%20%3E%3Cattribute%20name%3D%22annotationid%22%20%2F%3E%3Cattribute%20name%3D%22subject%22%20%2F%3E%3Cattribute%20name%3D%22annotationid%22%20%2F%3E%3Cattribute%20name%3D%22notetext%22%20%2F%3E%3Cattribute%20name%3D%22createdon%22%20%2F%3E%3Cattribute%20name%3D%22createdby%22%20%2F%3E%3Corder%20attribute%3D%22createdon%22%20descending%3D%22true%22%20%2F%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22createdbyname%22%20operator%3D%22not-like%22%20value%3D%22%25CRM%20Admin%25%22%20%2F%3E%3Ccondition%20attribute%3D%22notetext%22%20operator%3D%22not-like%22%20value%3D%22%25credit%25%22%20%2F%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22accountid%22%20to%3D%22objectid%22%20alias%3D%22ab%22%20%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22eq%22%20uitype%3D%22account%22%20value%3D%22" + accId + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
            //    beforeSend: function(XMLHttpRequest) {
            //        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
            //        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
            //        XMLHttpRequest.setRequestHeader("Accept", "application/json");
            //        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //    },
            //    async: false,
            //    success: function(data, textStatus, xhr) {
            //        notes = data.value;
            //    },
            //    error: function(xhr, textStatus, errorThrown) {
            //        var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
            //        var alertOptions = { height: 120, width: 260 };
            //        AlertDialog( alertStrings, alertOptions);
            //    }
            //});
            //var noteLst = [];
            //if (notes.length > 0) {
            //    for (var i = 0; i < notes.length; i++) {
            //        var note = notes[i];
            //        if (note.notetext != undefined && note.notetext.length > 0) {

            //            var text = note.notetext;
            //            var createdBy = note["_createdby_value@OData.Community.Display.V1.FormattedValue"];
            //            var createdOn = note["createdon@OData.Community.Display.V1.FormattedValue"];

            //            var comment = {
            //                "Note": text, "Created By": createdBy, "Created On": createdOn
            //            };
            //            noteLst.push(comment);
            //        }
            //    }
            //    if (noteLst.length > 0) {
            //        DrawTable("#recentNotes", noteLst, Object.keys(noteLst[0]));
            //    }
            //}
        }

        function PopulateConnection() {
            var query = "connections?fetchXml=%3Cfetch%20distinct%3D%22true%22%20%3E%0A%20%20%3Centity%20name%3D%22connection%22%20%3E%0A%20%20%20%20%3Cattribute%20name%3D%22record1id%22%20alias%3D%22Contact%22%20%2F%3E%0A%20%20%20%20%3Cattribute%20name%3D%22record2id%22%20alias%3D%22CRM_User%22%20%2F%3E%0A%20%20%20%20%3Corder%20attribute%3D%22record1id%22%20descending%3D%22false%22%20%2F%3E%0A%20%20%20%20%3Cfilter%3E%0A%20%20%20%20%20%20%3Ccondition%20attribute%3D%22statuscode%22%20operator%3D%22eq%22%20value%3D%221%22%20%2F%3E%0A%20%20%20%20%20%20%3Ccondition%20attribute%3D%22record1objecttypecode%22%20operator%3D%22eq%22%20value%3D%222%22%20%2F%3E%0A%20%20%20%20%20%20%3Ccondition%20attribute%3D%22record2objecttypecode%22%20operator%3D%22eq%22%20value%3D%228%22%20%2F%3E%0A%20%20%20%20%3C%2Ffilter%3E%0A%20%20%20%20%3Clink-entity%20name%3D%22contact%22%20from%3D%22contactid%22%20to%3D%22record1id%22%20link-type%3D%22inner%22%20alias%3D%22co%22%20%3E%0A%20%20%20%20%20%20%3Cattribute%20name%3D%22fullname%22%20%2F%3E%0A%20%20%20%20%20%20%3Cattribute%20name%3D%22accountrolecode%22%20%2F%3E%0A%20%20%20%20%20%20%3Cattribute%20name%3D%22jobtitle%22%20%2F%3E%0A%20%20%20%20%20%20%3Cattribute%20name%3D%22emailaddress1%22%20%2F%3E%0A%20%20%20%20%20%20%3Cattribute%20name%3D%22accountrolecodename%22%20%2F%3E%0A%20%20%20%20%20%20%3Cattribute%20name%3D%22contactid%22%20%2F%3E%0A%20%20%20%20%20%20%3Cfilter%20type%3D%22and%22%20%3E%0A%20%20%20%20%20%20%20%20%3Ccondition%20attribute%3D%22statuscode%22%20operator%3D%22eq%22%20value%3D%221%22%20%2F%3E%0A%20%20%20%20%20%20%3C%2Ffilter%3E%0A%20%20%20%20%20%20%3Clink-entity%20name%3D%22account%22%20from%3D%22accountid%22%20to%3D%22parentcustomerid%22%20link-type%3D%22inner%22%20alias%3D%22ac%22%20%3E%0A%20%20%20%20%20%20%20%20%3Cattribute%20name%3D%22accountid%22%20%2F%3E%0A%20%20%20%20%20%20%20%20%3Cattribute%20name%3D%22name%22%20%2F%3E%0A%20%20%20%20%20%20%20%20%3Cfilter%20type%3D%22and%22%20%3E%0A%20%20%20%20%20%20%20%20%20%20%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22eq%22%20value%3D%22" + accId+"%22%20%2F%3E%0A%20%20%20%20%20%20%20%20%20%20%3Ccondition%20attribute%3D%22statuscode%22%20operator%3D%22eq%22%20value%3D%221%22%20%2F%3E%0A%20%20%20%20%20%20%20%20%3C%2Ffilter%3E%0A%20%20%20%20%20%20%3C%2Flink-entity%3E%0A%20%20%20%20%3C%2Flink-entity%3E%0A%20%20%3C%2Fentity%3E%0A%3C%2Ffetch%3E";
            var connectionList = [];
            GetCRMData(query,
                    function(results) {
                        for (var i = 0; i < results.length; i++) {
                            var connection = results[i];
                            var contact = connection["co.fullname"] || "";
                            var jobTitle = connection['co.jobtitle'] || "";
                            var userName = connection["CRM_User@OData.Community.Display.V1.FormattedValue"] || "";

                            var conn = {
                                "Contact": contact, "Job Title": jobTitle, "CRM User": userName
                            };
                            connectionList.push(conn);
                        }
                    },
                    "Getting connections")
                .then(function() {
                    DrawMatrixTable("#connectionMatrix", connectionList);
                });
        }

        function PopulateRecentActivities() {
            var recentActivitylst = [], planedActivitylst = [];
            return GetCRMData(
                "activitypointers?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22true%22%20count%3D%225%22%20%3E%3Centity%20name%3D%22activitypointer%22%20%3E%3Cattribute%20name%3D%22activitytypecode%22%20%2F%3E%3Cattribute%20name%3D%22subject%22%20%2F%3E%3Cattribute%20name%3D%22activityid%22%20%2F%3E%3Cattribute%20name%3D%22instancetypecode%22%20%2F%3E%3Cattribute%20name%3D%22ownerid%22%20%2F%3E%3Cattribute%20name%3D%22createdon%22%20%2F%3E%3Cattribute%20name%3D%22statecode%22%20%2F%3E%3Corder%20attribute%3D%22createdon%22%20descending%3D%22true%22%20%2F%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22accountid%22%20to%3D%22regardingobjectid%22%20alias%3D%22aj%22%20link-type%3D%22outer%22%20%2F%3E%3Clink-entity%20name%3D%22contact%22%20from%3D%22contactid%22%20to%3D%22regardingobjectid%22%20alias%3D%22ac%22%20link-type%3D%22outer%22%20%2F%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22isworkflowcreated%22%20operator%3D%22eq%22%20value%3D%220%22%20%2F%3E%3Ccondition%20attribute%3D%22statecode%22%20operator%3D%22in%22%20%3E%3Cvalue%3E1%3C%2Fvalue%3E%3Cvalue%3E3%3C%2Fvalue%3E%3Cvalue%3E0%3C%2Fvalue%3E%3C%2Fcondition%3E%3Ccondition%20attribute%3D%22activitytypecode%22%20operator%3D%22in%22%20%3E%3Cvalue%3E4201%3C%2Fvalue%3E%3Cvalue%3E4202%3C%2Fvalue%3E%3Cvalue%3E4204%3C%2Fvalue%3E%3Cvalue%3E4207%3C%2Fvalue%3E%3Cvalue%3E4210%3C%2Fvalue%3E%3Cvalue%3E4212%3C%2Fvalue%3E%3C%2Fcondition%3E%3Cfilter%20type%3D%22or%22%20%3E%3Ccondition%20entityname%3D%22aj%22%20attribute%3D%22accountid%22%20operator%3D%22under%22%20uitype%3D%22account%22%20value%3D%22" + accId + "%22%20%2F%3E%3Ccondition%20entityname%3D%22aj%22%20attribute%3D%22accountid%22%20operator%3D%22eq%22%20uitype%3D%22account%22%20value%3D%22" + accId + "%22%20%2F%3E%3Ccondition%20entityname%3D%22ac%22%20attribute%3D%22parentcustomerid%22%20operator%3D%22eq%22%20uitype%3D%22account%22%20value%3D%22" + accId + "%22%20%2F%3E%3Ccondition%20attribute%3D%22regardingobjectid%22%20operator%3D%22eq%22%20uitype%3D%22account%22%20value%3D%22" + parentaccountid + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(results) {
                    for (var i = 0; i < results.length; i++) {
                        var activity = results[i];
                        var subject = activity.subject || "";
                        var createdDate = activity.createdon != undefined ? activity["createdon@OData.Community.Display.V1.FormattedValue"] : "";
                        var owner = activity._ownerid_value != undefined ? activity["_ownerid_value@OData.Community.Display.V1.FormattedValue"] : "";

                        var acc = {
                            "Description": subject,
                            "Date": createdDate,
                            "Owner": owner
                        };
                        if (activity.statecode == 1) {
                            recentActivitylst.push(acc);
                        } else {
                            planedActivitylst.push(acc);
                        }
                    }
                },
                "Getting recent activities"
            ).then(function() {
                if (recentActivitylst.length > 0) {
                    DrawTable("#recentActivities", recentActivitylst.filter(function(currentValue, index, arr) { if (index < 5) return currentValue; }), Object.keys(recentActivitylst[0]));
                }
                if (planedActivitylst.length > 0) {
                    DrawTable("#pastActivities", planedActivitylst.filter(function(currentValue, index, arr) { if (index < 5) return currentValue; }), Object.keys(planedActivitylst[0]));
                }
            });
        }

        function PopulateBidHistory() {
            var opportRecords;
            var opportRecordsUlt;
            var  bids1= GetCRMData("opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'customerid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee_base'%20%2F%3E%3Cattribute%20name%3D'statecode'%20alias%3D'StateCode'%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'in'%3E%3Cvalue%3E2%3C%2Fvalue%3E%3Cvalue%3E1%3C%2Fvalue%3E%3C%2Fcondition%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(data) {
                    opportRecords = data;
                },
                "Get Bid History 1"
            );
            var bids2 = GetCRMData("opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'ccrm_ultimateendclientid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee_base'%20%2F%3E%3Cattribute%20name%3D'statecode'%20alias%3D'StateCode'%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'ccrm_ultimateendclientid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'in'%3E%3Cvalue%3E2%3C%2Fvalue%3E%3Cvalue%3E1%3C%2Fvalue%3E%3C%2Fcondition%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(data) {
                    opportRecordsUlt = data;
                },
                "Get Bid History 2");

            return Promise.all([bids1, bids2])
                .then(function(done) {
                    var opporLst = [];
                    if (opportRecords.length > 0 || opportRecordsUlt.length > 0) {
                        if (opportRecords.length > 0) {
                            for (var i = 0; i < opportRecords.length; i++) {
                                var clientName = opportRecords[i].ClientName.toUpperCase() == parentaccountid.toUpperCase() ? opportRecords[i]['ClientName@OData.Community.Display.V1.FormattedValue'] : "Related Child Org";
                                var opportunityId = opportRecords[i].opportunityid;
                                var status = opportRecords[i]['StateCode@OData.Community.Display.V1.FormattedValue'];
                                var fee = opportRecords[i].fee_base != undefined ? opportRecords[i].fee_base * exchangeratevalue : 0.00;

                                var oppor = {
                                    "ClientName": clientName,
                                    "OpportunityId": opportunityId,
                                    "Status": status,
                                    "Fee": fee
                                };
                                opporLst.push(oppor);
                            }
                        }

                        if (opportRecordsUlt.length > 0) {
                            for (var i = 0; i < opportRecordsUlt.length; i++) {
                                var clientName = opportRecordsUlt[i].ClientName.toUpperCase() == parentaccountid.toUpperCase() ? opportRecordsUlt[i]['ClientName@OData.Community.Display.V1.FormattedValue'] : "Related Child Org";
                                var opportunityId = opportRecordsUlt[i].opportunityid;
                                var status = opportRecordsUlt[i]['StateCode@OData.Community.Display.V1.FormattedValue'];
                                var fee = opportRecordsUlt[i].fee_base != undefined ? opportRecordsUlt[i].fee_base * exchangeratevalue : 0.00;

                                var opporUlt = {
                                    "ClientName": clientName,
                                    "OpportunityId": opportunityId,
                                    "Status": status,
                                    "Fee": fee
                                };

                                var oppFound = oppExists(opportunityId);

                                if (!oppFound) {
                                    opporLst.push(opporUlt);
                                }

                                function oppExists(oppid) {
                                    return opporLst.some(function(el) {
                                        return el.OpportunityId === oppid;
                                    });
                                }

                            }
                        }

                        var x = d3.nest()
                            .key(function(d) { return d.Status })
                            .key(function(d) { return d.ClientName })
                            .rollup(function(d) { return { "Count": d.length, "Sum": d3.sum(d, function(d) { return parseFloat(d.Fee) }) } })
                            .entries(opporLst);

                        var bidHist = [];
                        x.forEach(function(d) {
                            d.values.forEach(function(e) {
                                bidHist.push({ "label": d.key + " (" + e.value.Count + ") - " + e.key, "value": e.value.Sum });
                            })
                        });

                        DrawPieChart("#bidHistory", bidHist, true);
                    }
                });

            //var opportRecords;
            //var opportRecordsUlt;
            //var req = new XMLHttpRequest();
            //req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'customerid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee_base'%20%2F%3E%3Cattribute%20name%3D'statecode'%20alias%3D'StateCode'%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'in'%3E%3Cvalue%3E2%3C%2Fvalue%3E%3Cvalue%3E1%3C%2Fvalue%3E%3C%2Fcondition%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
            //req.setRequestHeader("OData-MaxVersion", "4.0");
            //req.setRequestHeader("OData-Version", "4.0");
            //req.setRequestHeader("Accept", "application/json");
            //req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //req.onreadystatechange = function() {
            //    if (this.readyState === 4) {
            //        req.onreadystatechange = null;
            //        if (this.status === 200) {
            //            opportRecords = JSON.parse(this.response).value;
            //        } else {
            //            var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
            //            var alertOptions = { height: 120, width: 260 };
            //            AlertDialog( alertStrings, alertOptions);
            //        }
            //    }
            //};
            //req.send();

            //var req = new XMLHttpRequest();
            //req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'ccrm_ultimateendclientid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee_base'%20%2F%3E%3Cattribute%20name%3D'statecode'%20alias%3D'StateCode'%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'ccrm_ultimateendclientid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'in'%3E%3Cvalue%3E2%3C%2Fvalue%3E%3Cvalue%3E1%3C%2Fvalue%3E%3C%2Fcondition%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
            //req.setRequestHeader("OData-MaxVersion", "4.0");
            //req.setRequestHeader("OData-Version", "4.0");
            //req.setRequestHeader("Accept", "application/json");
            //req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //req.onreadystatechange = function() {
            //    if (this.readyState === 4) {
            //        req.onreadystatechange = null;
            //        if (this.status === 200) {
            //            opportRecordsUlt = JSON.parse(this.response).value;
            //        } else {
            //            var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
            //            var alertOptions = { height: 120, width: 260 };
            //            AlertDialog( alertStrings, alertOptions);
            //        }
            //    }
            //};
            //req.send();

            //var opporLst = [];
            //if (opportRecords.length > 0 || opportRecordsUlt.length > 0) {
            //    if (opportRecords.length > 0) {
            //        for (var i = 0; i < opportRecords.length; i++) {
            //            var clientName = opportRecords[i].ClientName.toUpperCase() == parentaccountid.toUpperCase() ? opportRecords[i]['ClientName@OData.Community.Display.V1.FormattedValue'] : "Related Child Org";
            //            var opportunityId = opportRecords[i].opportunityid;
            //            var status = opportRecords[i]['StateCode@OData.Community.Display.V1.FormattedValue'];
            //            var fee = opportRecords[i].fee_base != undefined ? opportRecords[i].fee_base * exchangeratevalue : 0.00;

            //            var oppor = {
            //                "ClientName": clientName, "OpportunityId": opportunityId, "Status": status, "Fee": fee
            //            };
            //            opporLst.push(oppor);
            //        }
            //    }

            //    if (opportRecordsUlt.length > 0) {
            //        for (var i = 0; i < opportRecordsUlt.length; i++) {
            //            var clientName = opportRecordsUlt[i].ClientName.toUpperCase() == parentaccountid.toUpperCase() ? opportRecordsUlt[i]['ClientName@OData.Community.Display.V1.FormattedValue'] : "Related Child Org";
            //            var opportunityId = opportRecordsUlt[i].opportunityid;
            //            var status = opportRecordsUlt[i]['StateCode@OData.Community.Display.V1.FormattedValue'];
            //            var fee = opportRecordsUlt[i].fee_base != undefined ? opportRecordsUlt[i].fee_base * exchangeratevalue : 0.00;

            //            var opporUlt = {
            //                "ClientName": clientName, "OpportunityId": opportunityId, "Status": status, "Fee": fee
            //            };

            //            var oppFound = oppExists(opportunityId);

            //            if (!oppFound) {
            //                opporLst.push(opporUlt);
            //            }

            //            function oppExists(oppid) {
            //                return opporLst.some(function (el) {
            //                    return el.OpportunityId === oppid;
            //                });
            //            }

            //        }
            //    }

            //    var x = d3.nest()
            //        .key(function (d) { return d.Status })
            //        .key(function (d) { return d.ClientName })
            //        .rollup(function (d) { return { "Count": d.length, "Sum": d3.sum(d, function (d) { return parseFloat(d.Fee) }) } })
            //        .entries(opporLst);

            //    var bidHist = [];
            //    x.forEach(function (d) {
            //        d.values.forEach(function (e) {
            //            bidHist.push({ "label": d.key + " (" + e.value.Count + ") - " + e.key, "value": e.value.Sum });
            //        })
            //    });

            //    DrawPieChart("#bidHistory", bidHist, true);
            //}
        }

        function PopulateHierOrganizationIds() {
            var accountRecords;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: clientURL + "/api/data/v9.1/accounts?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%20%3E%3Centity%20name%3D%22account%22%20%3E%3Cattribute%20name%3D%22accountid%22%20%2F%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22eq-or-under%22%20uitype%3D%22account%22%20value%3D%2214b80354-a481-ea11-a811-002248003e25%22%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    accountRecords = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
                    var alertOptions = { height: 120, width: 260 };
                    AlertDialog( alertStrings, alertOptions);
                }
            });

            if (accountRecords.length > 0) {
                for (var i = 0; i < accountRecords.length; i++) {
                    var accountId = accountRecords[i].accountid;

                    var acc = { "AccountId": accountId };
                    childOrgAccIds.push(acc);
                }
            }
        }

        function PopulateTop5LostOppors() {
            var opportRecords;
            var req = new XMLHttpRequest();
            req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%20top%3D'5'%20aggregate%3D'true'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'opportunityid'%20alias%3D'LostOpp_count'%20aggregate%3D'count'%2F%3E%3Cattribute%20name%3D'statuscode'%20alias%3D'StatusCode'%20groupby%3D'true'%2F%3E%3Corder%20alias%3D'LostOpp_count'%20descending%3D'true'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'outer'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'ccrm_ultimateendclientid'%20alias%3D'bj'%20link-type%3D'outer'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'2'%20%2F%3E%3Cfilter%20type%3D'or'%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3Ccondition%20entityname%3D%20'bj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
            req.setRequestHeader("OData-MaxVersion", "4.0");
            req.setRequestHeader("OData-Version", "4.0");
            req.setRequestHeader("Accept", "application/json");
            req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            req.onreadystatechange = function() {
                if (this.readyState === 4) {
                    req.onreadystatechange = null;
                    if (this.status === 200) {
                        opportRecords = JSON.parse(this.response).value;
                    } else {
                        var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
                        var alertOptions = { height: 120, width: 260 };
                        AlertDialog( alertStrings, alertOptions);
                    }
                }
            };
            req.send();

            var opporLst = [];

            if (opportRecords.length > 0) {
                for (var i = 0; i < opportRecords.length; i++) {
                    var count = opportRecords[i].LostOpp_count != undefined ? opportRecords[i].LostOpp_count : 0;
                    var status = opportRecords[i].StatusCode != undefined ? opportRecords[i]["StatusCode@OData.Community.Display.V1.FormattedValue"] : "";

                    var oppor = {
                        "label": status, "value": count
                    };
                    opporLst.push(oppor);
                }
            }

                    DrawPieChart("#top5BidLossReason", opporLst);
                },
                "Populate Top 5 lost opportunities");
        //    var opportRecords;
        //    var req = new XMLHttpRequest();
        //    req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%20top%3D'5'%20aggregate%3D'true'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'opportunityid'%20alias%3D'LostOpp_count'%20aggregate%3D'count'%2F%3E%3Cattribute%20name%3D'statuscode'%20alias%3D'StatusCode'%20groupby%3D'true'%2F%3E%3Corder%20alias%3D'LostOpp_count'%20descending%3D'true'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'outer'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'ccrm_ultimateendclientid'%20alias%3D'bj'%20link-type%3D'outer'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'2'%20%2F%3E%3Cfilter%20type%3D'or'%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3Ccondition%20entityname%3D%20'bj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
        //    req.setRequestHeader("OData-MaxVersion", "4.0");
        //    req.setRequestHeader("OData-Version", "4.0");
        //    req.setRequestHeader("Accept", "application/json");
        //    req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
        //    req.onreadystatechange = function() {
        //        if (this.readyState === 4) {
        //            req.onreadystatechange = null;
        //            if (this.status === 200) {
        //                opportRecords = JSON.parse(this.response).value;
        //            } else {
        //                var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
        //                var alertOptions = { height: 120, width: 260 };
        //                AlertDialog( alertStrings, alertOptions);
        //            }
        //        }
        //    };
        //    req.send();

        //    var opporLst = [];

        //    if (opportRecords.length > 0) {
        //        for (var i = 0; i < opportRecords.length; i++) {
        //            var count = opportRecords[i].LostOpp_count != undefined ? opportRecords[i].LostOpp_count : 0;
        //            var status = opportRecords[i].StatusCode != undefined ? opportRecords[i]["StatusCode@OData.Community.Display.V1.FormattedValue"] : "";

        //            var oppor = {
        //                "label": status, "value": count
        //            };
        //            opporLst.push(oppor);
        //        }
        //    }

        //    DrawPieChart("#top5BidLossReason", opporLst);
        }

        function PopulateTop10OpenOppors() {
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%20count%3D%2210%22%20%3E%3Centity%20name%3D%22opportunity%22%20%3E%3Cattribute%20name%3D%22opportunityid%22%20%2F%3E%3Cattribute%20name%3D%22name%22%20%2F%3E%3Cattribute%20name%3D%22estimatedvalue_base%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_projectmanager_userid%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_projectdirector_userid%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_probabilityofprojectproceeding%22%20alias%3D%22Probability_of_Proceeding%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_estarupinvolvementstart%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_closeprobability_synced%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_bidmanager_userid%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_biddirector_userid%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_arupregionid%22%20%2F%3E%3Cattribute%20name%3D%22statuscode%22%20alias%3D%22StatusCode%22%20%2F%3E%3Cattribute%20name%3D%22statecode%22%20%2F%3E%3Corder%20attribute%3D%22estimatedvalue_base%22%20descending%3D%22true%22%20%2F%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22accountid%22%20to%3D%22customerid%22%20alias%3D%22aj%22%20link-type%3D%22inner%22%20%2F%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22statecode%22%20operator%3D%22eq%22%20value%3D%220%22%20%2F%3E%3Ccondition%20attribute%3D%22statuscode%22%20operator%3D%22ne%22%20value%3D%223%22%20%2F%3E%3Ccondition%20attribute%3D%22statuscode%22%20operator%3D%22not-null%22%20%2F%3E%3Cfilter%20type%3D%22or%22%20%3E%3Ccondition%20entityname%3D%22aj%22%20attribute%3D%22accountid%22%20operator%3D%22under%22%20uitype%3D%22account%22%20value%3D%22" + parentaccountid + "%22%20%2F%3E%3Ccondition%20entityname%3D%22aj%22%20attribute%3D%22accountid%22%20operator%3D%22eq%22%20uitype%3D%22account%22%20value%3D%22" + parentaccountid + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    opportRecords = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
                    var alertOptions = { height: 120, width: 260 };
                    AlertDialog( alertStrings, alertOptions);
                }
            });
            var opporLst = [];
            if (opportRecords.length > 0) {
                for (var i = 0; i < opportRecords.length; i++) {
                    var name = opportRecords[i].name != undefined ? opportRecords[i].name : "";
                    var projectDirector = opportRecords[i]._ccrm_projectdirector_userid_value != undefined ? opportRecords[i]["_ccrm_projectdirector_userid_value@OData.Community.Display.V1.FormattedValue"] : "";
                    var status = opportRecords[i]["StatusCode@OData.Community.Display.V1.FormattedValue"];
                    var fee = opportRecords[i].estimatedvalue_base != undefined ? opportRecords[i].estimatedvalue_base * exchangeratevalue : 0.00;
                    var probWin = opportRecords[i].ccrm_closeprobability_synced != undefined ? opportRecords[i].ccrm_closeprobability_synced : "";
                    var probPros = opportRecords[i].Probability_of_Proceeding != undefined ? opportRecords[i].Probability_of_Proceeding : "";
                    var arupStartDate = opportRecords[i].ccrm_estarupinvolvementstart != undefined ? opportRecords[i]["ccrm_estarupinvolvementstart@OData.Community.Display.V1.FormattedValue"] : "";


                    var oppor = {
                        "Title": name, "Project Director": projectDirector, "Status": status, "Total Fee Income": Math.round(fee / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), "Probability of Win %": probWin, "Probability of Proceeding %": probPros, "Arup Start Date": arupStartDate
                    };
                    opporLst.push(oppor);
                }
                var o = opporLst.filter(function(currentValue, index, arr) { if (index < 10) return currentValue; });
                DrawTable("#top10OpenOportunities", o, Object.keys(o[0]));
                $("#top10OpenOpporCnt").text("( " + opporLst.length + " in Total)");
            }
        }

        function Populate5MostRecentWins() {
            var opportRecords;
            var opportRecordsUlt;
            var wins = GetCRMData("opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'true'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'customerid'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'1'%20%2F%3E%3Cfilter%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'opportunityclose'%20from%3D'opportunityid'%20to%3D'opportunityid'%20alias%3D'ab'%3E%3Cattribute%20name%3D'actualend'%20%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(winData) {
                    opportRecords = winData;
                },
                "Get most recent wins");

            var ultClient = GetCRMData("opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'true'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'customerid'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'1'%20%2F%3E%3Cfilter%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid +"'%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'opportunityclose'%20from%3D'opportunityid'%20to%3D'opportunityid'%20alias%3D'ab'%3E%3Cattribute%20name%3D'actualend'%20%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(ultRecs) {
                    opportRecordsUlt = ultRecs;
                }, "Get Ultimate clients");

            return Promise.all([wins, ultClient]).then(
                function(done) {
                    var opporLst = [];
                    if (opportRecords.length > 0 || opportRecordsUlt.length > 0) {
                        if (opportRecords.length > 0) {
                            for (var i = 0; i < opportRecords.length; i++) {
                                var oppId = opportRecords[i].id;
                                var name = opportRecords[i].name != undefined ? opportRecords[i].name : "";
                                var projectDirector = opportRecords[i]._ccrm_projectdirector_userid_value != undefined ? opportRecords[i]["_ccrm_projectdirector_userid_value@OData.Community.Display.V1.FormattedValue"] : "";
                                var fee = opportRecords[i].estimatedvalue_base != undefined ? opportRecords[i].estimatedvalue_base * exchangeratevalue : 0.00;
                                var arupStartDate = opportRecords[i].ccrm_estarupinvolvementstart != undefined ? opportRecords[i].ccrm_estarupinvolvementstart : "";
                                var actualWonDate = opportRecords[i]['ab.actualend'] != undefined ? opportRecords[i]['ab.actualend'] : "";

                                var oppor = {
                                    "Title": name,
                                    "Project Director": projectDirector,
                                    "Total Fee Income": fee,
                                    "Arup Start Date": arupStartDate,
                                    "Date Won": actualWonDate,
                                    "OppId": oppId
                                };
                                opporLst.push(oppor);
                            }
                        }

                        if (opportRecordsUlt.length > 0) {
                            for (var i = 0; i < opportRecordsUlt.length; i++) {
                                var oppId = opportRecordsUlt[i].id;
                                var name = opportRecordsUlt[i].name != undefined ? opportRecordsUlt[i].name : "";
                                var projectDirector = opportRecordsUlt[i].ccrm_projectdirector_userid != undefined ? opportRecordsUlt[i].ccrm_projectdirector_userid : "";
                                var fee = opportRecordsUlt[i].estimatedvalue_base != undefined ? opportRecordsUlt[i].estimatedvalue_base * exchangeratevalue : 0.00;
                                var arupStartDate = opportRecordsUlt[i].ccrm_estarupinvolvementstart != undefined ? opportRecordsUlt[i].ccrm_estarupinvolvementstart : "";
                                var actualWonDate = opportRecordsUlt[i]['ab.actualend'] != undefined ? opportRecordsUlt[i]['ab.actualend'] : "";

                                var opporUlt = {
                                    "Title": name,
                                    "Project Director": projectDirector,
                                    "Total Fee Income": fee,
                                    "Arup Start Date": arupStartDate,
                                    "Date Won": actualWonDate,
                                    "OppId": oppId
                                };
                                var oppFound = oppExists(oppId);

                                if (!oppFound) {
                                    opporLst.push(opporUlt);
                                }

                                function oppExists(oppid) {
                                    return opporLst.some(function(el) {
                                        return el.OppId === oppid;
                                    });
                                }
                            }
                        }

                        var depOpps = [];

                        var sortOpp = opporLst.sort(function(a, b) {
                            var datea = $(a).attr("Date Won") != "" ? $(a).attr("Date Won") : $(a).attr("Arup Start Date");
                            var dateb = $(b).attr("Date Won") != "" ? $(b).attr("Date Won") : $(b).attr("Arup Start Date");
                            return new Date(dateb) - new Date(datea);
                        }).filter(function(currentValue, index, arr) {
                            if (depOpps.length == 5) {
                                return false;
                            }
                            if (depOpps.indexOf(currentValue.OppId) > -1) {
                                return false;
                            } else {
                                depOpps.push(currentValue.OppId);
                                return true;
                            }
                        });

                        var o = sortOpp.map(function(currentValue, index, arr) {
                            var options = {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            };
                            return { "Title": currentValue["Title"], "Project Director": currentValue["Project Director"], "Total Fee Income": Math.round(currentValue["Total Fee Income"] / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), "Arup Start Date": currentValue["Arup Start Date"] == "" ? currentValue["Arup Start Date"] : new Date(currentValue["Arup Start Date"]).toLocaleDateString('en-US', options), "Date Won": currentValue["Date Won"] == "" ? currentValue["Date Won"] : new Date(currentValue["Date Won"]).toLocaleDateString('en-US', options) };
                            //}
                        });

                        DrawTable("#top5WonOpps", o, Object.keys(o[0]));
                        $("#top5OppWonCnt").text("( " + opporLst.length + " in Total )");
                    }
                }
            );

            // var opportRecords;
            //var opportRecordsUlt;
            //var req = new XMLHttpRequest();
            //req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'true'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'customerid'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'1'%20%2F%3E%3Cfilter%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'"+parentaccountid+"'%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'opportunityclose'%20from%3D'opportunityid'%20to%3D'opportunityid'%20alias%3D'ab'%3E%3Cattribute%20name%3D'actualend'%20%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
            //req.setRequestHeader("OData-MaxVersion", "4.0");
            //req.setRequestHeader("OData-Version", "4.0");
            //req.setRequestHeader("Accept", "application/json");
            //req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //req.onreadystatechange = function() {
            //    if (this.readyState === 4) {
            //        req.onreadystatechange = null;
            //        if (this.status === 200) {
            //            opportRecords = JSON.parse(this.response).value;
            //        } else {
            //            var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
            //            var alertOptions = { height: 120, width: 260 };
            //            AlertDialog( alertStrings, alertOptions);
            //        }
            //    }
            //};
            //req.send();

            ////Fetch XML for ultimate client
            //var req = new XMLHttpRequest();
            //req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'true'%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'customerid'%20%2F%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'ccrm_ultimateendclientid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'1'%20%2F%3E%3Cfilter%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Ffilter%3E%3Clink-entity%20name%3D'opportunityclose'%20from%3D'opportunityid'%20to%3D'opportunityid'%20alias%3D'ab'%3E%3Cattribute%20name%3D'actualend'%20%20%2F%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
            //req.setRequestHeader("OData-MaxVersion", "4.0");
            //req.setRequestHeader("OData-Version", "4.0");
            //req.setRequestHeader("Accept", "application/json");
            //req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //req.onreadystatechange = function() {
            //    if (this.readyState === 4) {
            //        req.onreadystatechange = null;
            //        if (this.status === 200) {
            //            opportRecordsUlt = JSON.parse(this.response).value;
            //        } else {
            //            var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
            //            var alertOptions = { height: 120, width: 260 };
            //            AlertDialog( alertStrings, alertOptions);
            //        }
            //    }
            //};
            //req.send();

            //var opporLst = [];
            //if (opportRecords.length > 0 || opportRecordsUlt.length > 0) {
            //    if (opportRecords.length > 0) {
            //        for (var i = 0; i < opportRecords.length; i++) {
            //            var oppId = opportRecords[i].id;
            //            var name = opportRecords[i].name != undefined ? opportRecords[i].name : "";
            //            var projectDirector = opportRecords[i]._ccrm_projectdirector_userid_value != undefined ? opportRecords[i]["_ccrm_projectdirector_userid_value@OData.Community.Display.V1.FormattedValue"] : "";
            //            var fee = opportRecords[i].estimatedvalue_base != undefined ? opportRecords[i].estimatedvalue_base * exchangeratevalue : 0.00;
            //            var arupStartDate = opportRecords[i].ccrm_estarupinvolvementstart != undefined ? opportRecords[i].ccrm_estarupinvolvementstart : "";
            //            var actualWonDate = opportRecords[i]['ab.actualend'] != undefined ? opportRecords[i]['ab.actualend'] : "";

            //            var oppor = {
            //                "Title": name, "Project Director": projectDirector, "Total Fee Income": fee, "Arup Start Date": arupStartDate, "Date Won": actualWonDate, "OppId": oppId
            //            };
            //            opporLst.push(oppor);
            //        }
            //    }

            //    if (opportRecordsUlt.length > 0) {
            //        for (var i = 0; i < opportRecordsUlt.length; i++) {
            //            var oppId = opportRecordsUlt[i].id;
            //            var name = opportRecordsUlt[i].name != undefined ? opportRecordsUlt[i].name : "";
            //            var projectDirector = opportRecordsUlt[i].ccrm_projectdirector_userid != undefined ? opportRecordsUlt[i].ccrm_projectdirector_userid : "";
            //            var fee = opportRecordsUlt[i].estimatedvalue_base != undefined ? opportRecordsUlt[i].estimatedvalue_base * exchangeratevalue : 0.00;
            //            var arupStartDate = opportRecordsUlt[i].ccrm_estarupinvolvementstart != undefined ? opportRecordsUlt[i].ccrm_estarupinvolvementstart : "";
            //            var actualWonDate = opportRecordsUlt[i]['ab.actualend'] != undefined ? opportRecordsUlt[i]['ab.actualend'] : "";

            //            var opporUlt = {
            //                "Title": name, "Project Director": projectDirector, "Total Fee Income": fee, "Arup Start Date": arupStartDate, "Date Won": actualWonDate, "OppId": oppId
            //            };
            //            var oppFound = oppExists(oppId);

            //            if (!oppFound) {
            //                opporLst.push(opporUlt);
            //            }

            //            function oppExists(oppid) {
            //                return opporLst.some(function (el) {
            //                    return el.OppId === oppid;
            //                });
            //            }
            //        }
            //    }

            //    var depOpps = [];

            //    var sortOpp = opporLst.sort(function (a, b) {
            //        var datea = $(a).attr("Date Won") != "" ? $(a).attr("Date Won") : $(a).attr("Arup Start Date");
            //        var dateb = $(b).attr("Date Won") != "" ? $(b).attr("Date Won") : $(b).attr("Arup Start Date");
            //        return new Date(dateb) - new Date(datea);
            //    }).filter(function (currentValue, index, arr) {
            //        if (depOpps.length == 5) {
            //            return false;
            //        }
            //        if (depOpps.indexOf(currentValue.OppId) > -1) {
            //            return false;
            //        }
            //        else {
            //            depOpps.push(currentValue.OppId);
            //            return true;
            //        }
            //        //if (index <= 4) {
            //        //    return true;
            //        //}
            //    });

            //    var o = sortOpp.map(function (currentValue, index, arr) {
            //        //if (index <= 4) {
            //        var options = {year: 'numeric',
            //                        month: 'long', day: 'numeric' };
            //        return { "Title": currentValue["Title"], "Project Director": currentValue["Project Director"], "Total Fee Income": Math.round(currentValue["Total Fee Income"] / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","), "Arup Start Date": currentValue["Arup Start Date"] == "" ? currentValue["Arup Start Date"] : new Date(currentValue["Arup Start Date"]).toLocaleDateString('en-US', options), "Date Won": currentValue["Date Won"] == "" ? currentValue["Date Won"] : new Date(currentValue["Date Won"]).toLocaleDateString('en-US', options) };
            //        //}
            //    });

            //    DrawTable("#top5WonOpps", o, Object.keys(o[0]));
            //    $("#top5OppWonCnt").text("( " + opporLst.length + " in Total )");
            //}
        }

        function PopulateChildOrganizations() {
            return GetCRMData("accounts?$select=accountid,address1_city,address1_line1,name,telephone1&$filter=_parentaccountid_value eq '" + accId + "'  and  statecode ne 1&$orderby=name asc",
                    function(orgs) {
                        childOrgs = $.merge(data,
                            $.map(orgs,
                                function(account) {
                                    return {
                                        Name: account.name,
                                        "Town/City": account.address1_city,
                                        AccountId: account.accountid,
                                        Address1_Line1: account.address1_line1,
                                        Telephone1: account.telephone1
                                    }
                                }));
                    },
                    "Populate Child Organizations",
                    { maxpagesize: 5 })
                .then(function() {
                    if (childOrgs.length > 0) {
                        DrawTable("#childorganizations", childOrgs, Object.keys(childOrgs[0]).slice(0, 2));
                    }
                    return GetCRMData("systemusers?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20top%3D%225%22%20distinct%3D%22true%22%20%3E%3Centity%20name%3D%22systemuser%22%20%3E%3Cattribute%20name%3D%22fullname%22%20%2F%3E%3Cattribute%20name%3D%22systemuserid%22%20%2F%3E%3Cattribute%20name%3D%22title%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_arupofficeid%22%20alias%3D%22Office%22%20%2F%3E%3Cattribute%20name%3D%22businessunitid%22%20alias%3D%22Business%22%20%2F%3E%3Corder%20attribute%3D%22fullname%22%20descending%3D%22false%22%20%2F%3E%3Clink-entity%20name%3D%22teammembership%22%20from%3D%22systemuserid%22%20to%3D%22systemuserid%22%20visible%3D%22false%22%20intersect%3D%22true%22%20%3E%3Clink-entity%20name%3D%22team%22%20from%3D%22teamid%22%20to%3D%22teamid%22%20alias%3D%22af%22%20%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22ccrm_managingteamid%22%20to%3D%22teamid%22%20alias%3D%22ag%22%20%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22eq%22%20value%3D%22" + accId + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                        function(users) {
                            userRecords = users;
                        }
                    );
                })
            //$.ajax({
            //    type: "GET",
            //    contentType: "application/json; charset=utf-8",
            //    datatype: "json",
            //    url: clientURL + "/api/data/v9.1/accounts?$select=accountid,address1_city,address1_line1,name,telephone1&$filter=_parentaccountid_value eq '"+ accId + "'  and  statecode ne 1&$orderby=name asc",
            //    beforeSend: function (XMLHttpRequest) {
            //        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
            //        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
            //        XMLHttpRequest.setRequestHeader("Accept", "application/json");
            //        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\",odata.maxpagesize=5");
            //    },
            //    success: function (r) {
            //        childOrgs = $.merge(data,
            //            $.map(r.value,
            //                function (account) {
            //                    return {
            //                        Name: account.name,
            //                        "Town/City": account.address1_city,
            //                        AccountId: account.accountid,
            //                        Address1_Line1: account.address1_line1,
            //                        Telephone1: account.telephone1
            //                    }
            //                }));
            //    },
            //    error: function (r) {
            //        $("#dashboard").text("Ad error occurred: " + r);
            //    }
            //}).done( function() {
            //    if (childOrgs.length > 0) {
            //        DrawTable("#childorganizations", childOrgs, Object.keys(childOrgs[0]).slice(0, 2));
            //    }
            //});

            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: clientURL + "/api/data/v9.1/systemusers?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20top%3D%225%22%20distinct%3D%22true%22%20%3E%3Centity%20name%3D%22systemuser%22%20%3E%3Cattribute%20name%3D%22fullname%22%20%2F%3E%3Cattribute%20name%3D%22systemuserid%22%20%2F%3E%3Cattribute%20name%3D%22title%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_arupofficeid%22%20alias%3D%22Office%22%20%2F%3E%3Cattribute%20name%3D%22businessunitid%22%20alias%3D%22Business%22%20%2F%3E%3Corder%20attribute%3D%22fullname%22%20descending%3D%22false%22%20%2F%3E%3Clink-entity%20name%3D%22teammembership%22%20from%3D%22systemuserid%22%20to%3D%22systemuserid%22%20visible%3D%22false%22%20intersect%3D%22true%22%20%3E%3Clink-entity%20name%3D%22team%22%20from%3D%22teamid%22%20to%3D%22teamid%22%20alias%3D%22af%22%20%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22ccrm_managingteamid%22%20to%3D%22teamid%22%20alias%3D%22ag%22%20%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22eq%22%20value%3D%22" + accId + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                success: function(data, textStatus, xhr) {
                    userRecords = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
                    var alertOptions = { height: 120, width: 260 };
                    AlertDialog( alertStrings, alertOptions);

                }
            });
        }

        function PopulateManagingTeamMembers() {
            var userList = [];
            GetCRMData(
                "accounts(" + accId + ")?$select=name&$expand=ccrm_managingteamid($select=name)",
                function(result) {
                    var teamid = result.ccrm_managingteamid.teamid;
                    GetCRMData("teams(" + teamid + ")?$select=name&$expand=teammembership_association($select=fullname,title,_ccrm_arupofficeid_value;$expand=ccrm_arupofficeid($select=ccrm_name),businessunitid($select=name))",
                            function(members) {
                                for (var i = 0; i < members.teammembership_association.length; i++) {
                                    var member = members.teammembership_association[i];
                                    var user = {
                                        Name: member.fullname,
                                       // "Arup Office": member.ccrm_arupofficeid["__DisplayName__"],
                                        Title: member.title,
                                        // Business: "?"
                                    };
                                    userList.push(user);
                                }
                            },
                            "Getting relationship team members")
                        .then(function() {
                            DrawTable("#relationshipTeamMembers", userList, Object.keys(userList[0]));
                        });
                },
                "Getting relationship team");
        }

        /**
         * Generic function to fetch data from CRM and display it.
         * @param {string} query - Odata query string such as accounts(guid)?$select=name
         * @param {function} onData - called each time data is retrieved.
         * @param {string} errorMessage - message to be displayed in the event of an error.
         * @returns {Promise} promise -  a promise that will complete when all data has been returned. If the promise is rejected/ an error occurs an error dialog will be displayed.
         */
        function GetCRMData(query, onData, errorMessage, options ) {
            options = options || {};
            var p = new Promise(function(success, reject) {
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: clientURL + "/api/data/v9.1/" + query,
                    beforeSend: function(xmlHttpRequest) {
                        xmlHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        xmlHttpRequest.setRequestHeader("OData-Version", "4.0");
                        xmlHttpRequest.setRequestHeader("Accept", "application/json");
                        xmlHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"" + (!!options.maxpagesize  ? ",odata.maxpagesize="+ options.maxpagesize : ""));
                    },
                    async: true,
                    success : function(data, testStatus, xhr) {
                        onData(data.value || data );
                    },
                    error : function(xhr, textStatus, errorThrown) {
                        var message = errorThrown;
                        if (!!xhr.responseJSON && !!xhr.responseJSON.error) message = xhr.responseJSON.error.message; 
                        var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + message, title: "Alert "  + errorMessage};
                        var alertOptions = { height: 120, width: 260 };
                        AlertDialog( alertStrings, alertOptions);
                        reject();
                    }
                }).done(function() {
                    success();
                });
            });
            return p;
        }

        function PopulateBasicAccProfile() {
            var query = "accounts("+accId+")?$select=address1_addressid,address1_city,address1_country,address1_line1,address1_line2,address1_line3,address1_postalcode,arup_clientscovid19bcadvised,ccrm_clienttype,_ccrm_keyaccountmanagerid_value,_ccrm_managingteamid_value,description,name,_parentaccountid_value,statuscode,telephone1,websiteurl,arup_clientsector";
            var basicProfile = {};
            return GetCRMData(query,
                function(result) {
                    basicProfile = {
                        accountId: result.accountid,
                        address_comosite: result.address1_composite != undefined ? result.address1_composite : "",
                        address1_City: result.address1_city != undefined ? result.address1_city : "",
                        address1_Line1: result.address1_line1 != undefined ? result.address1_line1 : "",
                        address1_Line2: result.address1_line2 != undefined ? result.address1_line2 : "",
                        address1_Line3: result.address1_line3 != undefined ? result.address1_line3 : "",
                        address1_PostalCode: result.address1_postalcode != undefined ? result.address1_postalcode : "",
                        ccrm_ClientSectorValue: result["arup_clientsector@OData.Community.Display.V1.FormattedValue"] || "",
                        ccrm_ClientType: result["ccrm_clienttype@OData.Community.Display.V1.FormattedValue"] || "",
                        ccrm_keyaccountmanager: result["_ccrm_keyaccountmanagerid_value@OData.Community.Display.V1.FormattedValue"],
                        ccrm_managingteam: result["_ccrm_managingteamid_value@OData.Community.Display.V1.FormattedValue"] || "",
                        description: result.description || "",
                        name: result.name || "",
                        parentAccount: result["_parentaccountid_value@OData.Community.Display.V1.FormattedValue"] || "",
                        statusCode: result.status,
                        telephone1: result.telephone1 || "",
                        webSiteURL:  result.websiteurl || "" // ??
                    };
                },
                "Getting Basic profile data")
                .then(function() {
                     AssociateProfileDataWithReport(basicProfile)
                });
        }
   

        function AssociateProfileDataWithReport(profileData) {
            var address = '';
            if (profileData.address1_Line1 != null && profileData.address1_Line1.length > 0) {
                address = address + profileData.address1_Line1.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
            }
            if (profileData.address1_Line2 != null && profileData.address1_Line2.length > 0) {
                address = address + profileData.address1_Line2.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
            }
            if (profileData.address1_Line3 != null && profileData.address1_Line3.length > 0) {
                address = address + profileData.address1_Line3.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
            }
            if (profileData.address1_City != null && profileData.address1_City.length > 0) {
                address = address + profileData.address1_City.replace('\t', '').replace('\r', '').replace('\f', '') + " ";
            }
            if (profileData.address1_PostalCode != null && profileData.address1_PostalCode.length > 0) {
                address = address + profileData.address1_PostalCode.replace('\t', '').replace('\r', '').replace('\f', '');
            }
            accName = profileData.name;
            $("#accountName").text(profileData.name);
            $("#website").text(profileData.webSiteURL);
            $("#relationshipmanager").text(profileData.ccrm_keyaccountmanager);
            // TODO - change 
            if (profileData.parentAccount != null) {
                $("#parentOrg").text(profileData.parentAccount);
            }
            $("#relationshipteam").text(profileData.ccrm_managingteam);
            $("#phonenum").text(profileData.telephone1);
            $("#address").text(address);
            $("#clientType").text(profileData.ccrm_ClientType);
            $("#clientSector").text(profileData.ccrm_ClientSectorValue);
            $("#clientDesc").text(profileData.description);
        }

        function GetForCastOpportunities() {
            var opportRecords;
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%20%3E%3Centity%20name%3D%22opportunity%22%20%3E%3Cattribute%20name%3D%22customerid%22%20alias%3D%22ClientName%22%20%2F%3E%3Cattribute%20name%3D%22statuscode%22%20alias%3D%22StatusCode%22%20%2F%3E%3Cattribute%20name%3D%22estimatedvalue_base%22%20alias%3D%22fee%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_proj_factoredincome_curr_base%22%20alias%3D%22Factored_fee%22%20%2F%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22accountid%22%20to%3D%22customerid%22%20alias%3D%22aj%22%20link-type%3D%22inner%22%20%2F%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22statecode%22%20operator%3D%22eq%22%20value%3D%220%22%20%2F%3E%3Ccondition%20attribute%3D%22statuscode%22%20operator%3D%22ne%22%20value%3D%223%22%20%2F%3E%3Ccondition%20attribute%3D%22statuscode%22%20operator%3D%22not-null%22%20%2F%3E%3Ccondition%20entityname%3D%22aj%22%20attribute%3D%22accountid%22%20operator%3D%22eq-or-under%22%20uitype%3D%22account%22%20value%3D%22" + parentaccountid + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                beforeSend: function(XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                    XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                },
                async: false,
                success: function(data, textStatus, xhr) {
                    opportRecords = data.value;
                },
                error: function(xhr, textStatus, errorThrown) {
                    var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
                    var alertOptions = { height: 120, width: 260 };
                    AlertDialog( alertStrings, alertOptions);
                }
            });
            var opporLst = [];
            if (opportRecords.length > 0) {
                for (var i = 0; i < opportRecords.length; i++) {

                    var clientName = opportRecords[i].ClientName.toUpperCase() == parentaccountid.toUpperCase() ? opportRecords[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "Related Child Org";
                    var feeBase = opportRecords[i].fee != undefined ? opportRecords[i].fee * exchangeratevalue : 0.00;
                    var factoredFee = opportRecords[i].Factored_fee != undefined ? opportRecords[i].Factored_fee : "";
                    var phase = GetPhase(opportRecords[i].StatusCode);
                    var oppor = { phase: phase, clientName: clientName, feeBase: feeBase, factoredFee: factoredFee };
                    opporLst.push(oppor);
                }
                DrawBarChart("#OpenOpportunityChart", opporLst);
            }
        }

        function GetOpenOpportunities() {
            var opportRecords;
            var opportRecordsUlt;
            var opp1 = GetCRMData("opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%20%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_probabilityofprojectproceeding'%20alias%3D'Probability_of_Proceeding'%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Cattribute%20name%3D'closeprobability'%20%2F%3E%3Cattribute%20name%3D'ccrm_bidmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_biddirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_arupregionid'%20%2F%3E%3Cattribute%20name%3D'statuscode'%20alias%3D'StatusCode'%2F%3E%3Cattribute%20name%3D'statecode'%20%2F%3E%3Cattribute%20name%3D'customerid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee'%20%2F%3E%3Cattribute%20name%3D'ccrm_proj_factoredincome_curr_base'%20alias%3D'Factored_fee'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'0'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'ne'%20value%3D'3'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'not-null'%2F%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(oppData) {
                    opportRecords = oppData;
                },
                "Get Open Opportunitites"
            );
            var opp2 = GetCRMData("opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%20%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_probabilityofprojectproceeding'%20alias%3D'Probability_of_Proceeding'%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Cattribute%20name%3D'closeprobability'%20%2F%3E%3Cattribute%20name%3D'ccrm_bidmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_biddirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_arupregionid'%20%2F%3E%3Cattribute%20name%3D'statuscode'%20alias%3D'StatusCode'%2F%3E%3Cattribute%20name%3D'statecode'%20%2F%3E%3Cattribute%20name%3D'ccrm_ultimateendclientid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee'%20%2F%3E%3Cattribute%20name%3D'ccrm_proj_factoredincome_curr_base'%20alias%3D'Factored_fee'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'ccrm_ultimateendclientid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'0'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'ne'%20value%3D'3'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'not-null'%2F%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                function(oppData) {
                    opportRecordsUlt = oppData;
                },
                "Get Open Opportunities ult"
            );

            return Promise.all([opp1, opp2]).then(
                function(done) {
                    var opporLst = [];
                    if (opportRecords.length > 0 || opportRecordsUlt.length > 0) {
                        if (opportRecords.length > 0) {
                            for (var i = 0; i < opportRecords.length; i++) {

                                var clientName = opportRecords[i].ClientName.toUpperCase() == accId.toUpperCase() ? opportRecords[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "Related Child Org";
                                var actualClientName = opportRecords[i].ClientName != undefined ? opportRecords[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "";
                                var feeBase = opportRecords[i].fee != undefined ? opportRecords[i].fee * exchangeratevalue : 0.00;
                                var factoredFee = opportRecords[i].Factored_fee != undefined ? opportRecords[i].Factored_fee : 0.00;
                                var PhaseOrder = GetPhase(opportRecords[i].StatusCode);
                                var phase = PhaseOrder.Phase;
                                var sortOrder = PhaseOrder.SortOrder;
                                var name = opportRecords[i].name != undefined ? opportRecords[i].name : "";
                                var projectDirector = opportRecords[i]._ccrm_projectdirector_userid_value != undefined ? opportRecords[i]["_ccrm_projectdirector_userid_value@OData.Community.Display.V1.FormattedValue"] : "";
                                var status = opportRecords[i]["StatusCode@OData.Community.Display.V1.FormattedValue"];
                                var probWin = opportRecords[i].closeprobability != undefined ? opportRecords[i].closeprobability : "";
                                var probPros = opportRecords[i].Probability_of_Proceeding != undefined ? opportRecords[i].Probability_of_Proceeding : "";
                                var arupStartDate = opportRecords[i].ccrm_estarupinvolvementstart != undefined ? opportRecords[i]["ccrm_estarupinvolvementstart@OData.Community.Display.V1.FormattedValue"] : "";
                                var opportunityid = opportRecords[i].opportunityid;

                                var oppor = {
                                    Client: clientName,
                                    ActualClientName: actualClientName,
                                    Fee: feeBase,
                                    FactoredFee: factoredFee,
                                    Phase: phase,
                                    Name: name,
                                    ProjectDirector: projectDirector,
                                    Status: status,
                                    ProbWin: probWin,
                                    ProbPros: probPros,
                                    ArupStartDate: arupStartDate,
                                    SortOrder: sortOrder,
                                    OpportunityId: opportunityid
                                };
                                opporLst.push(oppor);
                            }
                        }

                        if (opportRecordsUlt.length > 0) {
                            for (var i = 0; i < opportRecordsUlt.length; i++) {

                                var clientName = opportRecordsUlt[i].ClientName.toUpperCase() == accId.toUpperCase() ? opportRecordsUlt[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "Related Child Org";
                                var actualClientName = opportRecordsUlt[i].ClientName != undefined ? opportRecordsUlt[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "";
                                var feeBase = opportRecordsUlt[i].fee != undefined ? opportRecordsUlt[i].fee * exchangeratevalue : 0.00;
                                var factoredFee = opportRecordsUlt[i].Factored_fee != undefined ? opportRecordsUlt[i].Factored_fee : 0.00;
                                var PhaseOrder = GetPhase(opportRecordsUlt[i].StatusCode);
                                var phase = PhaseOrder.Phase;
                                var sortOrder = PhaseOrder.SortOrder;
                                var name = opportRecordsUlt[i].name != undefined ? opportRecordsUlt[i].name : "";
                                var projectDirector = opportRecordsUlt[i]._ccrm_projectdirector_userid_value != undefined ? opportRecordsUlt[i]["_ccrm_projectdirector_userid_value@OData.Community.Display.V1.FormattedValue"] : "";
                                var status = opportRecordsUlt[i]["StatusCode@OData.Community.Display.V1.FormattedValue"];
                                var probWin = opportRecordsUlt[i].closeprobability != undefined ? opportRecordsUlt[i].closeprobability : "";
                                var probPros = opportRecordsUlt[i].Probability_of_Proceeding != undefined ? opportRecordsUlt[i].Probability_of_Proceeding : "";
                                var arupStartDate = opportRecordsUlt[i].ccrm_estarupinvolvementstart != undefined ? opportRecordsUlt[i]["ccrm_estarupinvolvementstart@OData.Community.Display.V1.FormattedValue"] : "";
                                var opportunityid = opportRecordsUlt[i].opportunityid;

                                var opporUlt = {
                                    Client: clientName,
                                    ActualClientName: actualClientName,
                                    Fee: feeBase,
                                    FactoredFee: factoredFee,
                                    Phase: phase,
                                    Name: name,
                                    ProjectDirector: projectDirector,
                                    Status: status,
                                    ProbWin: probWin,
                                    ProbPros: probPros,
                                    ArupStartDate: arupStartDate,
                                    SortOrder: sortOrder,
                                    OpportunityId: opportunityid
                                };


                                var oppFound = oppExists(opportunityid);

                                if (!oppFound) {
                                    opporLst.push(opporUlt);
                                }

                                function oppExists(oppid) {
                                    return opporLst.some(function(el) {
                                        return el.OpportunityId === oppid;
                                    });
                                }


                            }
                        }
                        var opporLstThisOrg = opporLst.filter(function(orgRecord) {
                            return orgRecord.Client != 'Related Child Org'
                        });

                        OpenOppPieChart(opporLst, 'Fee');
                        ForecastOpporBarChart(opporLst, false);
                        OpenOppTop10Table(opporLstThisOrg);
                    }
                }
            );

            //var req = new XMLHttpRequest();
            //req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%20%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_probabilityofprojectproceeding'%20alias%3D'Probability_of_Proceeding'%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Cattribute%20name%3D'closeprobability'%20%2F%3E%3Cattribute%20name%3D'ccrm_bidmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_biddirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_arupregionid'%20%2F%3E%3Cattribute%20name%3D'statuscode'%20alias%3D'StatusCode'%2F%3E%3Cattribute%20name%3D'statecode'%20%2F%3E%3Cattribute%20name%3D'customerid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee'%20%2F%3E%3Cattribute%20name%3D'ccrm_proj_factoredincome_curr_base'%20alias%3D'Factored_fee'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'customerid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'0'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'ne'%20value%3D'3'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'not-null'%2F%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
            //req.setRequestHeader("OData-MaxVersion", "4.0");
            //req.setRequestHeader("OData-Version", "4.0");
            //req.setRequestHeader("Accept", "application/json");
            //req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //req.onreadystatechange = function() {
            //    if (this.readyState === 4) {
            //        req.onreadystatechange = null;
            //        if (this.status === 200) {
            //            opportRecords = JSON.parse(this.response).value;
            //        } else {
            //            var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
            //            var alertOptions = { height: 120, width: 260 };
            //            AlertDialog( alertStrings, alertOptions);
            //        }
            //    }
            //};
            //req.send();

            ////Fetch for ultimate client
            //var req = new XMLHttpRequest();
            //req.open("GET", clientURL + "/api/data/v9.1/opportunities?fetchXml=%3Cfetch%20version%3D'1.0'%20output-format%3D'xml-platform'%20mapping%3D'logical'%20distinct%3D'false'%20%3E%3Centity%20name%3D'opportunity'%3E%3Cattribute%20name%3D'opportunityid'%20%2F%3E%3Cattribute%20name%3D'name'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_projectdirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_probabilityofprojectproceeding'%20alias%3D'Probability_of_Proceeding'%2F%3E%3Cattribute%20name%3D'ccrm_estarupinvolvementstart'%20%2F%3E%3Cattribute%20name%3D'closeprobability'%20%2F%3E%3Cattribute%20name%3D'ccrm_bidmanager_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_biddirector_userid'%20%2F%3E%3Cattribute%20name%3D'ccrm_arupregionid'%20%2F%3E%3Cattribute%20name%3D'statuscode'%20alias%3D'StatusCode'%2F%3E%3Cattribute%20name%3D'statecode'%20%2F%3E%3Cattribute%20name%3D'ccrm_ultimateendclientid'%20alias%3D'ClientName'%20%2F%3E%3Cattribute%20name%3D'estimatedvalue_base'%20alias%3D'fee'%20%2F%3E%3Cattribute%20name%3D'ccrm_proj_factoredincome_curr_base'%20alias%3D'Factored_fee'%20%2F%3E%3Clink-entity%20name%3D'account'%20from%3D'accountid'%20to%3D'ccrm_ultimateendclientid'%20alias%3D'aj'%20link-type%3D'inner'%20%2F%3E%3Cfilter%20type%3D'and'%3E%3Ccondition%20attribute%3D'statecode'%20operator%3D'eq'%20value%3D'0'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'ne'%20value%3D'3'%20%2F%3E%3Ccondition%20attribute%3D'statuscode'%20operator%3D'not-null'%2F%3E%3Ccondition%20entityname%3D%20'aj'%20attribute%3D'accountid'%20operator%3D'eq-or-under'%20uitype%3D'account'%20value%3D'" + parentaccountid + "'%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E", false);
            //req.setRequestHeader("OData-MaxVersion", "4.0");
            //req.setRequestHeader("OData-Version", "4.0");
            //req.setRequestHeader("Accept", "application/json");
            //req.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
            //req.onreadystatechange = function() {
            //    if (this.readyState === 4) {
            //        req.onreadystatechange = null;
            //        if (this.status === 200) {
            //            opportRecordsUlt = JSON.parse(this.response).value;
            //        } else {
            //            var alertStrings = { confirmButtonLabel: "OK", text: this.statusText, title: "Alert" };
            //            var alertOptions = { height: 120, width: 260 };
            //            AlertDialog( alertStrings, alertOptions);
            //        }
            //    }
            //};
            //req.send();

            //var opporLst = [];
            //if (opportRecords.length > 0 || opportRecordsUlt.length > 0) {
            //    if (opportRecords.length > 0) {
            //        for (var i = 0; i < opportRecords.length; i++) {

            //            var clientName = opportRecords[i].ClientName.toUpperCase() == accId.toUpperCase() ? opportRecords[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "Related Child Org";
            //            var actualClientName = opportRecords[i].ClientName != undefined ? opportRecords[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "";
            //            var feeBase = opportRecords[i].fee != undefined ? opportRecords[i].fee * exchangeratevalue : 0.00;
            //            var factoredFee = opportRecords[i].Factored_fee != undefined ? opportRecords[i].Factored_fee : 0.00;
            //            var PhaseOrder = GetPhase(opportRecords[i].StatusCode);
            //            var phase = PhaseOrder.Phase;
            //            var sortOrder = PhaseOrder.SortOrder;
            //            var name = opportRecords[i].name != undefined ? opportRecords[i].name : "";
            //            var projectDirector = opportRecords[i]._ccrm_projectdirector_userid_value != undefined ? opportRecords[i]["_ccrm_projectdirector_userid_value@OData.Community.Display.V1.FormattedValue"] : "";
            //            var status = opportRecords[i]["StatusCode@OData.Community.Display.V1.FormattedValue"];
            //            var probWin = opportRecords[i].closeprobability != undefined ? opportRecords[i].closeprobability : "";
            //            var probPros = opportRecords[i].Probability_of_Proceeding != undefined ? opportRecords[i].Probability_of_Proceeding : "";
            //            var arupStartDate = opportRecords[i].ccrm_estarupinvolvementstart != undefined ? opportRecords[i]["ccrm_estarupinvolvementstart@OData.Community.Display.V1.FormattedValue"] : "";
            //            var opportunityid = opportRecords[i].opportunityid;

            //            var oppor = {
            //                Client: clientName, ActualClientName: actualClientName, Fee: feeBase, FactoredFee: factoredFee, Phase: phase, Name: name, ProjectDirector: projectDirector,
            //                Status: status, ProbWin: probWin, ProbPros: probPros, ArupStartDate: arupStartDate, SortOrder: sortOrder, OpportunityId: opportunityid
            //            };
            //            opporLst.push(oppor);
            //        }
            //    }

            //    if (opportRecordsUlt.length > 0) {
            //        for (var i = 0; i < opportRecordsUlt.length; i++) {

            //            var clientName = opportRecordsUlt[i].ClientName.toUpperCase() == accId.toUpperCase() ? opportRecordsUlt[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "Related Child Org";
            //            var actualClientName = opportRecordsUlt[i].ClientName != undefined ? opportRecordsUlt[i]["ClientName@OData.Community.Display.V1.FormattedValue"] : "";
            //            var feeBase = opportRecordsUlt[i].fee != undefined ? opportRecordsUlt[i].fee * exchangeratevalue : 0.00;
            //            var factoredFee = opportRecordsUlt[i].Factored_fee != undefined ? opportRecordsUlt[i].Factored_fee : 0.00;
            //            var PhaseOrder = GetPhase(opportRecordsUlt[i].StatusCode);
            //            var phase = PhaseOrder.Phase;
            //            var sortOrder = PhaseOrder.SortOrder;
            //            var name = opportRecordsUlt[i].name != undefined ? opportRecordsUlt[i].name : "";
            //            var projectDirector = opportRecordsUlt[i]._ccrm_projectdirector_userid_value != undefined ? opportRecordsUlt[i]["_ccrm_projectdirector_userid_value@OData.Community.Display.V1.FormattedValue"] : "";
            //            var status = opportRecordsUlt[i]["StatusCode@OData.Community.Display.V1.FormattedValue"];
            //            var probWin = opportRecordsUlt[i].closeprobability != undefined ? opportRecordsUlt[i].closeprobability : "";
            //            var probPros = opportRecordsUlt[i].Probability_of_Proceeding != undefined ? opportRecordsUlt[i].Probability_of_Proceeding : "";
            //            var arupStartDate = opportRecordsUlt[i].ccrm_estarupinvolvementstart != undefined ? opportRecordsUlt[i]["ccrm_estarupinvolvementstart@OData.Community.Display.V1.FormattedValue"] : "";
            //            var opportunityid = opportRecordsUlt[i].opportunityid;

            //            var opporUlt = {
            //                Client: clientName, ActualClientName: actualClientName, Fee: feeBase, FactoredFee: factoredFee, Phase: phase, Name: name, ProjectDirector: projectDirector,
            //                Status: status, ProbWin: probWin, ProbPros: probPros, ArupStartDate: arupStartDate, SortOrder: sortOrder, OpportunityId: opportunityid
            //            };



            //            var oppFound = oppExists(opportunityid);

            //            if (!oppFound) {
            //                opporLst.push(opporUlt);
            //            }

            //            function oppExists(oppid) {
            //                return opporLst.some(function (el) {
            //                    return el.OpportunityId === oppid;
            //                });
            //            }


            //        }
            //    }
            //    var opporLstThisOrg = opporLst.filter(function (orgRecord) {
            //        return orgRecord.Client != 'Related Child Org'
            //    });

            //    OpenOppPieChart(opporLst, 'Fee');
            //    ForecastOpporBarChart(opporLst, false);
            //    OpenOppTop10Table(opporLstThisOrg);
            //}
        }

        function PopulateLeads(opporlist) {
            var acctid;
            acctid = parentaccountid;
            var o = [];
            if (!opporlist) {
                o = fetchLeads(acctid, false);
            }
            else {
                if (opporlist[0].Client == opporlist[0].ActualClientName) 
                o = fetchLeads(acctid, false);
                else
                o = fetchLeads(acctid, true);
            }

            if (o.length > 0) {
                DrawTable("#leadsList", o, Object.keys(o[0]).filter(function(d) { return d !== 'leadid'; }));
            }
        }

        function fetchLeads(acctid, op) {
            var leads;
            if (op) {
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: clientURL + "/api/data/v9.1/leads?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%20%3E%3Centity%20name%3D%22lead%22%20%3E%3Cattribute%20name%3D%22fullname%22%20%2F%3E%3Cattribute%20name%3D%22statecode%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_arupinternal%22%20%2F%3E%3Cattribute%20name%3D%22ownerid%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_country%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_client%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_arupbusiness%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_accountingcentreid%22%20%2F%3E%3Cattribute%20name%3D%22leadid%22%20%2F%3E%3Corder%20attribute%3D%22fullname%22%20descending%3D%22false%22%20%2F%3E%3Clink-entity%20name%3D%22account%22%20from%3D%22accountid%22%20to%3D%22ccrm_client%22%20alias%3D%22ab%22%20link-type%3D%22inner%22%20%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22accountid%22%20operator%3D%22under%22%20value%3D%22" + acctid + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Flink-entity%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                    beforeSend: function(XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    },
                    async: false,
                    success: function(data, textStatus, xhr) {
                        leads = data.value;
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
                        var alertOptions = { height: 120, width: 260 };
                        AlertDialog( alertStrings, alertOptions);
                    }
                });
            }
            else {
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: clientURL + "/api/data/v9.1/leads?fetchXml=%3Cfetch%20version%3D%221.0%22%20output-format%3D%22xml-platform%22%20mapping%3D%22logical%22%20distinct%3D%22false%22%20%3E%3Centity%20name%3D%22lead%22%20%3E%3Cattribute%20name%3D%22fullname%22%20%2F%3E%3Cattribute%20name%3D%22statecode%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_arupinternal%22%20%2F%3E%3Cattribute%20name%3D%22ownerid%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_country%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_client%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_arupbusiness%22%20%2F%3E%3Cattribute%20name%3D%22ccrm_accountingcentreid%22%20%2F%3E%3Cattribute%20name%3D%22leadid%22%20%2F%3E%3Corder%20attribute%3D%22fullname%22%20descending%3D%22false%22%20%2F%3E%3Cfilter%20type%3D%22and%22%20%3E%3Ccondition%20attribute%3D%22ccrm_client%22%20operator%3D%22eq%22%20value%3D%22" + acctid + "%22%20%2F%3E%3C%2Ffilter%3E%3C%2Fentity%3E%3C%2Ffetch%3E",
                    beforeSend: function(XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("OData-MaxVersion", "4.0");
                        XMLHttpRequest.setRequestHeader("OData-Version", "4.0");
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                        XMLHttpRequest.setRequestHeader("Prefer", "odata.include-annotations=\"*\"");
                    },
                    async: false,
                    success: function(data, textStatus, xhr) {
                        leads = data.value;
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        var alertStrings = { confirmButtonLabel: "OK", text: textStatus + " " + errorThrown, title: "Alert" };
                        var alertOptions = { height: 120, width: 260 };
                        AlertDialog( alertStrings, alertOptions);
                    }
                });
            }
            var leadsList = [];

            for (var i = 0; i < leads.length; i++) {
                var fullname = leads[i].fullname != undefined ? leads[i].fullname : " ";
                var status = leads[i].statecode != undefined ? leads[i].statecode : " ";
                var arupbusiness = leads[i]._ccrm_arupbusiness_value != undefined ? leads[i]["_ccrm_arupbusiness_value@OData.Community.Display.V1.FormattedValue"] : " ";
                var accountcentreid = leads[i]._ccrm_accountingcentreid_value != undefined ? leads[i]["_ccrm_accountingcentreid_value@OData.Community.Display.V1.FormattedValue"] : " ";
                var leadid = leads[i].leadid != undefined ? leads[i].leadid : " ";
                var ld = { "Name": fullname, "Status": status, "Arup Business": arupbusiness, "Accounting Centre": accountcentreid, "leadid": leadid };
                leadsList.push(ld);
            }
            var o = leadsList.filter(function (currentValue, index, arr) {
                if (currentValue.status == 0) {
                    delete currentValue.status;
                    return currentValue;
                }
            });

            return o;
        }

        function OpenOppPieChart(allOpenOppor, feeKey, actualOrg) {

            var grpOpp = [];
            d3.nest()
                .key(function (d) {
                    if (actualOrg)
                        return d.ActualClientName;
                    else
                        return d.Client;
                })
                .rollup(function (leaves) {
                    var lab;
                    if (actualOrg)
                        lab = leaves[0].ActualClientName;
                    else
                        lab = leaves[0].Client;

                    var feeValue = d3.sum(leaves, function (leave) {
                        return leave[feeKey];
                    });

                    if (feeValue > 0) {
                        grpOpp.push({
                            label: lab, count: " (" + leaves.length + ")", value: d3.sum(leaves, function (leave) {
                                return leave[feeKey];
                            })
                        })
                    }
                })
                .entries(allOpenOppor);

            DrawPieChartOpp("#OpportunityForAccChart", grpOpp.sort(function (x, y) {
                return d3.ascending(x.label, y.label);
            }), true, allOpenOppor);
        }

        function ForecastOpporBarChart(allOpenOppor, transitionRequired) {
            var keys = ["Fee Base", "Factored Fee"];
            var sortOpp = allOpenOppor.sort(function (a, b) {

                if (a.SortOrder < b.SortOrder) {
                    return 1;
                }
                if (a.SortOrder > b.SortOrder) {
                    return -1;
                }
                // a must be equal to b
                return 0;
            })

            var nested = d3.nest()
                .key(function (d) {
                    return d.Phase;
                })
                .key(function (d) {
                    return d.Client;
                })
                .rollup(function (leaves) {
                    return [{
                        key: keys[0],
                        value: Math.round(d3.sum(leaves, function (leave) { return leave.Fee }) / 1000)
                    }, {
                        key: keys[1],
                        value: Math.round(d3.sum(leaves, function (leave) { return leave.FactoredFee }) / 1000)
                    }];
                })
                .entries(sortOpp);

            DrawBarChart("#OpenOpportunityChart", nested, allOpenOppor, transitionRequired);
        }
        function OpenOppTop10Table(allOpenOppor) {

            var sortOpp = allOpenOppor.sort(function (a, b) {

                if (a.Fee < b.Fee) {
                    return 1;
                }
                if (a.Fee > b.Fee) {
                    return -1;
                }
                // a must be equal to b
                return 0;
            })
            var filOpp = sortOpp.filter(function (currVal, index, arr) { if (index < 10) return currVal; });

            var finalOpp = filOpp.map(function (d) {
                return {
                    "Title": d.Name, "Project Director": d.ProjectDirector, "Status": d.Status, "Total Fee Income": Math.round(d.Fee / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","),
                    "Probability of Win %": d.ProbWin, "Prob. Proj Proceed %": d.ProbPros, "Arup Start Date": d.ArupStartDate, "OpportunityId": d.OpportunityId
                };
            });

            $("#top10OpenOpporCnt").text("( " + allOpenOppor.length + " in Total)");

            if (finalOpp.length > 0) {
                DrawTable("#top10OpenOportunities", finalOpp, Object.keys(finalOpp[0]).filter(function(d) { return d !== 'OpportunityId'; }));
            }
        }
        function GetPhase(status) {
            var statusCode = status.value;
            var Status = new Object();
            if (statusCode == 200013) {
                Status.Phase = "Pre-Bids";
                Status.SortOrder = 4;
            }
            else if (statusCode == 200016 || statusCode == 200017 || statusCode == 200014) {
                Status.Phase = "Possible Jobs";
                Status.SortOrder = 3;
            }
            else if (statusCode == 200005 || statusCode == 200006 || statusCode == 200015 || statusCode == 200020) {
                Status.Phase = "Bids";
                Status.SortOrder = 2;
            }
            else if (statusCode == 200040 || statusCode == 200042 || statusCode == 200041
                || statusCode == 200031 || statusCode == 200032 || statusCode == 200033
                || statusCode == 200021 || statusCode == 200022 || statusCode == 200023
                || statusCode == 100000000 || statusCode == 100000001 || statusCode == 100000002
                || statusCode == 200037 || statusCode == 200038 || statusCode == 200039
                || statusCode == 200034 || statusCode == 200035 || statusCode == 200036) {
                Status.Phase = "Confirmed";
                Status.SortOrder = 1;
            }

            return Status;
        }
    </script>
    <script>
        function DrawTable(div, data, columns) {
            d3.select(div).selectAll("table").remove();
            var relTable = d3.select(div).append('table');
            var tabHead = relTable.append('thead');
            var tabBody = relTable.append('tbody');
            tabHead.append('tr')
                .selectAll('th')
                .data(function (d) { return columns })
                .enter()
                .append('th')
                .style('width', function (d) {
                    if (d == 'Created On' || d == 'Date Won' || d == 'Date') {
                        return '50px';
                    }
                    else if (d == 'Prob. Proj Proceed %' || d == 'Probability of Win %') {
                        return '60px';
                    }
                    else if (d == 'Project Director') {
                        return '150px';
                    }
                })
                .text(function (col) { return col; }).style('background-color', 'rgba(158, 158, 158, 0.5)');


            var rows = tabBody.selectAll('tr')
                .data(data)
                .enter()
                .append('tr').style('background-color', function (d, i) {
                    if (i % 2 == 0) {
                        return 'rgba(158, 158, 158, 0.05)';
                    }
                    else {
                        return 'rgba(158, 158, 158, 0.2)';
                    }
                });

            rows.selectAll('td')
                .data(function (row) {
                    return columns.map(function (column) {
                        return { column: column, value: row[column], OpportunityId: row["OpportunityId"], leadId: row["leadid"] };
                    })
                })
                .enter()
                .append('td')
                .style('text-align', function (d) {
                    if (d.column == 'Created On' || d.column == 'Date' || d.column == 'Arup Start Date' || d.column == 'Date Won'
                        || d.column == 'Total Fee Income' || d.column == 'Prob. Proj Proceed %' || d.column == 'Probability of Win %') {
                        return 'center';
                    }
                })
                .html(function (d) {
                    if (div == '#top10OpenOportunities' && d.column == 'Title') {
                        return '<a href=\"' + clientURL + '/main.aspx?etc=3&pagetype=entityrecord&id=%7b' + d.OpportunityId + '%7d' + '\" target=\"_blank\">' + d.value + '</a>';
                    }
                    if (div == '#leadsList' && d.column == 'Name') {
                        return '<a href=\"' + clientURL + '/main.aspx?pagetype=entityrecord&etc=4&id=%7b' + d.leadId + '%7d' + '\" target=\"_blank\">' + d.value + '</a>';
                    }
                    else {
                        return d.value;
                    }
                });
        }

        function DrawBarChart(div, nested, allOpenOppor, transitionRequired) {
            var keys = ["Fee Base", "Factored Fee"];

            var margin = {
                top: 20,
                right: 20,
                bottom: 60,
                left: 50
            },
                width = 580 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

            var x_groups = d3.scaleBand().range([0, width - 100]).padding(.1);

            var x_categories = d3.scaleBand();

            var x_values = d3.scaleBand();

            var y = d3.scaleLinear()
                .range([height, 0]);

            var color = d3.scaleOrdinal(d3.schemeCategory10);

            var groups_axis = d3.axisBottom(x_groups);

            var categories_axis = d3.axisBottom(x_categories);

            var values_axis = d3.axisBottom(x_categories);

            var yAxis = d3.axisLeft(y);

            d3.select(div).selectAll("svg").remove();
            d3.select(div).on("click", mouseout);
            var svg = d3.select(div).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var phases = ['Pre-Bids', 'Possible Jobs', 'Bids', 'Confirmed'];
            x_groups.domain(phases);

            var index = 0;
            var maxClientLength = 0;
            nested.forEach(function (d, i) {
                if (d.values.length > maxClientLength) {
                    maxClientLength = d.values.length;
                    index = i;
                }
            });

            var categories = nested[index].values.map(function (d, i) {
                return d.key;
            });
            x_categories.domain(categories).range([0, x_groups.bandwidth()]);
            var values = nested[0].values[0].value.map(function (d, i) {
                return d.key;
            });
            x_values.domain(values).range([0, x_categories.bandwidth()]);

            // ew! should prob do something way cleaner
            y.domain([0, d3.max(nested, function (d) {
                return d3.max(d.values, function (d) {
                    return d3.max(d.value, function (d) {
                        return d.value / 1000;
                    })
                });
            }) * 1.1]);

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + (height + 38) + ")")
                .call(groups_axis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -45)
                .attr("x", -35)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Fee (000's)");

            var groups_g = svg.selectAll(".group")
                .data(nested)
                .enter().append("g")
                .attr("class", function (d) {
                    return 'group group-' + d.key;
                })
                .attr("transform", function (d) {
                    return "translate(" + x_groups(d.key) + ",0)";
                });

            var categories_g = groups_g.selectAll(".category")
                .data(function (d) {
                    return d.values;
                })
                .enter().append("g")
                .attr("class", function (d) {
                    return 'category category-' + d.key;
                })
                .attr("transform", function (d) {
                    return "translate(" + x_categories(d.key) + ",0)";
                });

            var categories_labels = categories_g.selectAll('.category-label')
                .data(function (d) {
                    return [d.key];
                })
                .enter().append("text")
                .attr("class", function (d) {
                    return 'category-label category-label-' + d;
                })
                .attr("x", function (d) {
                    return x_categories.bandwidth() / 2;
                })
                .attr('y', function (d) {
                    return height + 8;
                })
                .attr('text-anchor', 'middle')
                //.text(function (d) {
                //    return d;
                //})
                .call(wrap, x_categories.bandwidth());
            //.call(wrap, 72.5);

            function wrap(text, width) {

                text.each(function () {

                    var textdata;
                    if (this.__data__.length > 26) {
                        textdata = this.__data__.substring(0, 23).trim() + '...';
                    }
                    else {
                        textdata = this.__data__;
                    }
                    var words = textdata.split(/\s+/).reverse();

                    var text = d3.select(this),
                        word,
                        line = [],
                        lineNumber = 0,
                        lineHeight = 1.1, // ems
                        y = text.attr("y"),
                        dy = .35;
                    tspan = text.text(null).append("tspan").attr("x", width / 2).attr("y", y).attr("dy", dy + "em").attr("dx", .01 + "em");

                    while (word = words.pop()) {
                        if (word.length > 8) {
                            word = word.substring(0, 6) + '..';
                        }
                        line.push(word);
                        tspan.text(line.join(" "));
                        if (tspan.node().getComputedTextLength() > width) {
                            line.pop();
                            tspan.text(line.join(" "));
                            line = [word];
                            tspan = text.append("tspan").attr("x", width / 2).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                        }
                    }
                });


            }

            var values_g = categories_g.selectAll(".value")
                .data(function (d) {
                    return d.value;
                })
                .enter().append("g")
                .attr("class", function (d) {
                    return 'value value-' + d.key;
                })
                .attr("transform", function (d) {
                    return "translate(" + x_values(d.key) + ",0)";
                });

            var rects = values_g.selectAll('.rect')
                .data(function (d) {
                    return [d];
                })
                .enter().append("rect");
            if (transitionRequired) {

                rects.attr("y", height).attr("height", 0)
                    .attr("width", x_values.bandwidth()).style("fill", function (d) {
                        return color(d.key);
                    })
                    .transition()
                    .duration(1000)
                    .attr(
                        "y", function (d, i) {
                            return y(d.value / 1000);
                        }
                    ).attr(
                        "height", function (d, i) {
                            return height - y(d.value / 1000);
                        });
            }
            else {
                rects
                    .attr("width", x_values.bandwidth())
                    .attr("x", function (d) {
                        return 0;
                    })
                    .attr("y", function (d) {
                        return y(d.value / 1000);
                    })
                    .attr("height", function (d) {
                        return height - y(d.value / 1000);
                    })
                    .style("fill", function (d) {
                        return color(d.key);
                    })
                    .on("mouseover", mouseover);// mouseover is defined below.
            }

            function printpage() {
                rects.on("mouseout", null);
            }
            function mouseover(d) {  // utility function to be called on mouseover.
                var org = d3.select(this.parentNode.parentNode).datum().key;
                var phase = d3.select(this.parentNode.parentNode.parentNode).datum().key;
                var filOpp = allOpenOppor.filter(function (currVal, index, arr) { if (currVal.Client == org && currVal.Phase == phase) { return currVal; } });
                var k;
                if (d.key == 'Fee Base')
                    k = 'Fee';
                else
                    k = 'FactoredFee';

                OpenOppTop10Table(filOpp);
                OpenOppPieChart(filOpp, k, true);
            }

            function mouseout(d) {    // utility function to be called on mouseout.
                OpenOppTop10Table(allOpenOppor);
                OpenOppPieChart(allOpenOppor, 'Fee');
            };

            //fee text of each bar
            values_g.selectAll('.text')
                .data(function (d) {
                    return [d];
                })
                .enter().append("text")
                .attr("x", function (d) {
                    return x_values.bandwidth() / 2;
                })
                .attr("y", function (d) {
                    return y(d.value / 1000) - 15;
                })
                .attr("dy", "0.32em")
                .attr('text-anchor', 'middle')
                .text(function (d) {
                    return d.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                });

            //display legend

            var legend = svg.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .attr("text-anchor", "start")
                .selectAll("g")
                .data(keys)
                .enter().append("g")
                .attr("transform", function (d, i) { return "translate(20," + i * 20 + ")"; });

            legend.append("rect")
                .attr("x", width - 110)
                .attr("width", 19)
                .attr("height", 9)
                .attr("fill", function (d, i) { return color(d) });

            legend.append("text")
                .attr("x", width - 85)
                .attr("y", 4.5)
                .attr("dy", "0.32em")
                .text(function (d) { return d; });
        }

        function DrawPieChartOpp(div, data, numberFormatRequired, allOpenOppor) {
            var width = 450, height = 200, radius = Math.min(width, height) / 2, barHeight = 10;

            var color = d3.scaleOrdinal(d3.schemeCategory20);


            var arc = d3.arc()
                .outerRadius(radius - 20)
                .innerRadius(radius - 70);

            var labelArc = d3.arc()
                .outerRadius(radius - 40)
                .innerRadius(radius - 40);

            var pie = d3.pie()
                .sort(null)
                .value(function (d) { return d.value; });

            d3.select(div).selectAll("svg").remove();
            d3.select(div).on("click", mouseout);
            var opporChart = d3.select(div).append("svg")
                .attr("width", width)
                .attr("height", height);
            ////////////
            opporChart.append("rect").attr("x", 0).attr("y", 0).attr("width", width).attr("height", height).style("stroke", 'black')
                .style("fill", "none")
                .style("stroke-width", 1);
            ////////////

            var svgPie = opporChart.append("g")
                .attr("transform", "translate(" + height / 2 + "," + height / 2 + ")");


            //load data into pie chart
            var gPie = svgPie.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            //fill pie chart
            gPie.append("path")
                .attr("d", arc)
                .style("fill", function (d, i) { return color(i); })
                .transition().duration(function (d, i) {
                    return 2000;
                })
                .attrTween('d', function (d) {
                    var i = d3.interpolate(d.startAngle + 0.1, d.endAngle);
                    return function (t) {
                        d.endAngle = i(t);
                        return arc(d);
                    }
                });

            //display text in chart
            gPie.append("text")
                .attr("transform", function (d) { return "translate(" + labelArc.centroid(d) + ")"; })
                .attr("dy", ".35em")
                .text(function (d) { if (numberFormatRequired) { return Math.round(d.data.value / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); } else { return d.data.value; } });

            gPie.on("mouseover", mouseover);
            function mouseover(d) {
                // call the update function of histogram with new data.
                var filOpp = allOpenOppor.filter(function (currVal, index, arr) { if (currVal.Client == d.data.label) { return currVal; } });

                OpenOppTop10Table(filOpp);
                PopulateLeads(filOpp);
                ForecastOpporBarChart(filOpp, true);
            }
            //Utility function to be called on mouseout a pie slice.
            function mouseout(d) {
                OpenOppTop10Table(allOpenOppor);
                ForecastOpporBarChart(allOpenOppor, false);
            }
            /////////////////////////////

            var barSvg = opporChart.append("g");


            var bar = barSvg.selectAll("g")
                .data(pie(data))
                .enter().append("g")
                .attr("class", ".bar")
                .attr("transform", function (d, i) { return "translate(" + (width - height - 35) + "," + (i + 2) * barHeight + ")"; });



            bar.append("rect")
                .attr("width", 20)
                .attr("height", barHeight - 2)
                .style("fill", function (d, i) { return color(i) });

            bar.append("text")
                .attr("x", 25)
                .attr("y", barHeight / 2)
                .attr("dy", ".35em")
                .text(function (d) {
                    if (d.data.label.length + d.data.count.length > 40) {
                        return d.data.label.substring(0, 35).trim() + '...' + d.data.count;
                    }
                    else {
                        return d.data.label + d.data.count;
                    }
                });

            /////////
            return gPie;
        }
        function DrawPieChart(div, data, numberFormatRequired) {
            var width = 519, height = 200, radius = Math.min(width, height) / 2, barHeight = 10;

            var color = d3.scaleOrdinal(d3.schemeCategory20);


            var arc = d3.arc()
                .outerRadius(radius - 20)
                .innerRadius(radius - 70);

            var labelArc = d3.arc()
                .outerRadius(radius - 40)
                .innerRadius(radius - 40);

            var pie = d3.pie()
                .sort(null)
                .value(function (d) { return d.value; });

            var opporChart = d3.select(div).append("svg")
                .attr("width", width)
                .attr("height", height);
            ////////////
            opporChart.append("rect").attr("x", 0).attr("y", 0).attr("width", width).attr("height", height).style("stroke", 'black')
                .style("fill", "none")
                .style("stroke-width", 1);
            ////////////

            var svgPie = opporChart.append("g")
                .attr("transform", "translate(" + height / 2 + "," + height / 2 + ")");


            //load data into pie chart
            var gPie = svgPie.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            //fill pie chart
            gPie.append("path")
                .attr("d", arc)
                .style("fill", function (d, i) { return color(i); });

            //display text in chart
            gPie.append("text")
                .attr("transform", function (d) { return "translate(" + labelArc.centroid(d) + ")"; })
                .attr("dy", ".35em")
                .text(function (d) { if (numberFormatRequired) { return Math.round(d.data.value / 1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); } else { return d.data.value; } });

            var barSvg = opporChart.append("g");


            var bar = barSvg.selectAll("g")
                .data(pie(data))
                .enter().append("g")
                .attr("class", ".bar")
                .attr("transform", function (d, i) { return "translate(" + (width - height - 80) + "," + (i + 2) * barHeight + ")"; });



            bar.append("rect")
                .attr("width", 20)
                .attr("height", barHeight - 2)
                .style("fill", function (d, i) { return color(i) });

            bar.append("text")
                .attr("x", 25)
                .attr("y", barHeight / 2)
                .attr("dy", ".35em")
                .text(function (d) {
                    if (d.data.label.length > 50) {
                        return d.data.label.substring(0, 47).trim() + '...';
                    }
                    else {
                        return d.data.label;
                    }
                });

            /////////
            return gPie;
        }
        function DrawMatrixTable(div, data) {


            var nested = data.filter(function (currentValue, index, arr) { if (index >= arr.length - 10) return currentValue; });

            var columns = Object.keys(data[0]).slice(0, 2);

            var matrixData = [];

            var ContactRows = d3.nest()
                .key(function (d) { return d['Contact']; })
                .rollup(function (leaves) {
                    leaves.forEach(function (leave) {
                        matrixData.push({ key: leave['Contact'], value: leave['CRM User'] });

                    })
                    return leaves[0];
                })
                .entries(nested);

            var crmusers = d3.nest()
                .key(function (d) { return d['CRM User']; })
                .entries(nested);

            crmusers.sort(function (a, b) {

                if (a.key < b.key) {
                    return -1;
                }
                if (a.key > b.key) {
                    return 1;
                }
                // a must be equal to b
                return 0;
            }).map(function (d) { columns.push(d.key); });

            var relTable = d3.select(div).append('table');
            var tabHead = relTable.append('thead');
            var tabBody = relTable.append('tbody');

            tabHead.append('tr')
                .selectAll('th')
                .data(function (d) { return columns })
                .enter()
                .append('th')
                .text(function (col) { return col; }).style('background-color', 'lightgray');

            var rows = tabBody.selectAll('tr')
                .data(ContactRows)
                .enter()
                .append('tr');

            rows.selectAll('td')
                .data(function (row) {
                    return columns.map(function (column) {
                        var exist = matrixData.filter(function (c, i, a) {
                            if (c.value == column && c.key == row.key) { return c; }
                        })
                        if (exist.length > 0) {
                            return { column: column, value: "", Color: 'gray' };
                        }
                        else {
                            return { column: column, value: row.value[column], Color: 'lightgray' };
                        }
                    })
                })
                .enter()
                .append('td')
                .text(function (d) { return d.value }).style('background-color', function (d) { return d.Color });
        }
        function DrawMatrixForceLayout(div, conData) {
            var nodelink = Object();
            nodelink.nodes = [];
            nodelink.links = [];
            nodelink.nodes.push({ id: accName, group: 1, rad: 10 });

            var arupContact = d3.nest()
                .key(function (d) { return d['CRM User']; })
                .entries(conData);
            var clientContact = d3.nest()
                .key(function (d) { return d['Contact']; })
                .entries(conData);
            arupContact.forEach(function (ac, i) {
                nodelink.nodes.push({ id: ac.key, group: 2, rad: 7 });
                nodelink.links.push({ source: accName, target: ac.key, value: 2 });
            })
            clientContact.forEach(function (ac, i) {
                nodelink.nodes.push({ id: ac.key, group: 3, rad: 5 });
            })

            conData.forEach(function (cc, i) {
                nodelink.links.push({ source: cc['CRM User'], target: cc['Contact'], value: 1 });
            })

            var svg = d3.select("#connForcelay"),
                width = +svg.attr("width"),
                height = +svg.attr("height");

            svg.append("rect")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .call(d3.zoom()
                    .scaleExtent([1 / 2, 4])
                    .on("zoom", zoomed));

            var g = svg.append("g");

            function zoomed() {
                g.attr("transform", d3.event.transform);
            }


            var color = d3.scaleOrdinal(d3.schemeCategory20);

            var simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(function (d) { return d.id; }))
                .force("charge", d3.forceManyBody())
                .force("center", d3.forceCenter(width / 2, height / 2));


            var link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(nodelink.links)
                .enter().append("line")
                .attr("stroke-width", function (d) { return Math.sqrt(d.value); });

            var node = g.append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(nodelink.nodes)
                .enter().append("circle")
                .attr("r", function (d) { return d.rad; })
                .attr("fill", function (d) { return color(d.group); })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("title")
                .text(function (d) { return d.id; });

            simulation
                .nodes(nodelink.nodes)
                .on("tick", ticked);

            simulation.force("link")
                .links(nodelink.links);

            function ticked() {
                link
                    .attr("x1", function (d) { return d.source.x; })
                    .attr("y1", function (d) { return d.source.y; })
                    .attr("x2", function (d) { return d.target.x; })
                    .attr("y2", function (d) { return d.target.y; });

                node
                    .attr("cx", function (d) { return d.x; })
                    .attr("cy", function (d) { return d.y; });
            }


            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function AlertDialog(alertStrings, alertOptions ) {
            var promise = Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
            promise.then(function() { Window.close() });
            return promise;
        }

    </script>


</body></html>